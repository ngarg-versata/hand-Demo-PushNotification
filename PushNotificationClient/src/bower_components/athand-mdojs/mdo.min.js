/**
 * @license almond 0.3.1 Copyright (c) 2011-2014, The Dojo Foundation All Rights Reserved.
 * Available via the MIT or new BSD license.
 * see: http://github.com/jrburke/almond for details
 */

/*! websql.js | MIT license | http://bitbucket.org/nonplus/websql-js */

//      (c) 2012 Stepan Riha
//      websql.js may be freely distributed under the MIT license.
//
// Module that wraps asynchronous WebSQL calls with deferred promises and provides SQL utility
// methods.
//
// Promises are **resolved** when asynchronous database callback is finished.
//
// Promises are **rejected** with an `Error` object that may contain one or more of the following:
//
// * `message`: Describing what failed
// * `exception`: Exception that was thrown
// * `sqlError`: Error returned by WebSQL
// * `sql`: statement that was executing
//
// ## Getting Started
//
// Websql can be loaded as
//
// * a `<script>` tag (creating a `websql` global)
// * an AMD module
//
// Websql can produce deferred promises using
//
// * [`when.js`](https://github.com/cujojs/when)
// * [`Q.js`](https://github.com/kriskowal/q)
// * [`jQuery's Deferred`](http://api.jquery.com/category/deferred-object/)
// * Other...
//
// ### To use in `<script>` tag
//
// The module will autodetect and use one of the supported promise providers
// if it's included in your HTML before `websql`:
//
//          <script src="path/to/when.js"></script>
//          <script src="path/to/websql.js"></script>
//          ...
//
// ### To use as an AMD module
//
// If a promise provider isn't loaded into the global scope, you need to use
// the `websql.config()` method to tell it which provider to use.
//
//          // Using a CommonJS Promisses/A implementation:
//          define(["websql", "when"], function(websql, when) {
//              websql.config({
//                  defer: when.defer
//              });
//              ...
//          })
//
//          // Using jQuery Deferred implementation:
//          define(["websql", "jquery"], function(websql, $) {
//              websql.config({
//                  defer: $.Deferred
//              });
//              ...
//          })
//
//
// ## Using the API
//
// Example:
//
//      var wsdb = websql("test");
//      wsdb.read("SELECT * FROM ...");
//          .then(function(resultSet) { ... });
//

/** @license MIT License (c) copyright 2011-2013 original author or authors */

/**
 * A lightweight CommonJS Promises/A and when() implementation
 * when is part of the cujo.js family of libraries (http://cujojs.com/)
 *
 * Licensed under the MIT License at:
 * http://www.opensource.org/licenses/mit-license.php
 *
 * @author Brian Cavalier
 * @author John Hann
 *
 * @version 1.8.1
 */

/** @license MIT License (c) copyright 2013 original author or authors */

// > http://underscorejs.org
// > (c) 2009-2013 Jeremy Ashkenas, DocumentCloud Inc.
// > Underscore may be freely distributed under the MIT license.

/** The server is out of device licenses */

/*!
* @hand DSS Library
*
* Copyright 2012, @hand Software Corporation
* All rights reserved
* http://www.hand.com
*/

//     (c) 2010-2013 Jeremy Ashkenas, DocumentCloud Inc.
//     Backbone may be freely distributed under the MIT license.
//     For all details and documentation:
//     http://backbonejs.org

// Copyright (C) 2011 Alexey Silin <pinkoblomingo@gmail.com>

/* Zepto 1.0rc1 - ajax - zeptojs.com/license */

/*  SHA-1 implementation in JavaScript | (c) Chris Veness 2002-2010 | www.movable-type.co.uk      */

(function(e,t){typeof define=="function"&&define.amd?define(function(){return t()}):e.mdo=t()})(this,function(){var requirejs,require,define;return function(e){function h(e,t){return f.call(e,t)}function p(e,t){var n,r,i,s,o,a,f,l,h,p,d,v=t&&t.split("/"),m=u.map,g=m&&m["*"]||{};if(e&&e.charAt(0)===".")if(t){e=e.split("/"),o=e.length-1,u.nodeIdCompat&&c.test(e[o])&&(e[o]=e[o].replace(c,"")),e=v.slice(0,v.length-1).concat(e);for(h=0;h<e.length;h+=1){d=e[h];if(d===".")e.splice(h,1),h-=1;else if(d===".."){if(h===1&&(e[2]===".."||e[0]===".."))break;h>0&&(e.splice(h-1,2),h-=2)}}e=e.join("/")}else e.indexOf("./")===0&&(e=e.substring(2));if((v||g)&&m){n=e.split("/");for(h=n.length;h>0;h-=1){r=n.slice(0,h).join("/");if(v)for(p=v.length;p>0;p-=1){i=m[v.slice(0,p).join("/")];if(i){i=i[r];if(i){s=i,a=h;break}}}if(s)break;!f&&g&&g[r]&&(f=g[r],l=h)}!s&&f&&(s=f,a=l),s&&(n.splice(0,a,s),e=n.join("/"))}return e}function d(t,r){return function(){var i=l.call(arguments,0);return typeof i[0]!="string"&&i.length===1&&i.push(null),n.apply(e,i.concat([t,r]))}}function v(e){return function(t){return p(t,e)}}function m(e){return function(t){s[e]=t}}function g(n){if(h(o,n)){var r=o[n];delete o[n],a[n]=!0,t.apply(e,r)}if(!h(s,n)&&!h(a,n))throw new Error("No "+n);return s[n]}function y(e){var t,n=e?e.indexOf("!"):-1;return n>-1&&(t=e.substring(0,n),e=e.substring(n+1,e.length)),[t,e]}function b(e){return function(){return u&&u.config&&u.config[e]||{}}}var t,n,r,i,s={},o={},u={},a={},f=Object.prototype.hasOwnProperty,l=[].slice,c=/\.js$/;r=function(e,t){var n,r=y(e),i=r[0];return e=r[1],i&&(i=p(i,t),n=g(i)),i?n&&n.normalize?e=n.normalize(e,v(t)):e=p(e,t):(e=p(e,t),r=y(e),i=r[0],e=r[1],i&&(n=g(i))),{f:i?i+"!"+e:e,n:e,pr:i,p:n}},i={require:function(e){return d(e)},exports:function(e){var t=s[e];return typeof t!="undefined"?t:s[e]={}},module:function(e){return{id:e,uri:"",exports:s[e],config:b(e)}}},t=function(t,n,u,f){var l,c,p,v,y,b=[],w=typeof u,E;f=f||t;if(w==="undefined"||w==="function"){n=!n.length&&u.length?["require","exports","module"]:n;for(y=0;y<n.length;y+=1){v=r(n[y],f),c=v.f;if(c==="require")b[y]=i.require(t);else if(c==="exports")b[y]=i.exports(t),E=!0;else if(c==="module")l=b[y]=i.module(t);else if(h(s,c)||h(o,c)||h(a,c))b[y]=g(c);else{if(!v.p)throw new Error(t+" missing "+c);v.p.load(v.n,d(f,!0),m(c),{}),b[y]=s[c]}}p=u?u.apply(s[t],b):undefined;if(t)if(l&&l.exports!==e&&l.exports!==s[t])s[t]=l.exports;else if(p!==e||!E)s[t]=p}else t&&(s[t]=u)},requirejs=require=n=function(s,o,a,f,l){if(typeof s=="string")return i[s]?i[s](o):g(r(s,o).f);if(!s.splice){u=s,u.deps&&n(u.deps,u.callback);if(!o)return;o.splice?(s=o,o=a,a=null):s=e}return o=o||function(){},typeof a=="function"&&(a=f,f=l),f?t(e,s,o,a):setTimeout(function(){t(e,s,o,a)},4),n},n.config=function(e){return n(e)},requirejs._defined=s,define=function(e,t,n){if(typeof e!="string")throw new Error("See almond README: incorrect module build, no module name");t.splice||(n=t,t=[]),!h(s,e)&&!h(o,e)&&(o[e]=[e,t,n])},define.amd={jQuery:!0}}(),define("../node_modules/almond/almond",function(){}),function(e,t){typeof define=="function"&&define.amd?define("lib/websql",[],t):e.websql=t()}(this,function(){"use strict";function f(e,r,f,d){function k(e,t){C++,o++;switch(s){case"sql":i.log("SQL["+N+"]: "+e);break;case"sql-params":i.log("SQL["+N+"]: "+e),t&&t.length&&i.log("   ["+N+"]  "+JSON.stringify(t,function(e,t){return g(t)&&t.length>20&&(t=t.substr(0,20)+"â€¦"),t}));break;case"sql-params-full":i.log("SQL["+N+"]: "+e),t&&t.length&&i.log("   ["+N+"]  "+JSON.stringify(t))}}function L(e,r,i,s){p(n,"openDatabase",e,r,i,s),i||(i=e),r||(r="");if(!s){var o=a?0:u?45:2;s=o*1024*1024}u=!1;var f=l();try{var h;window.sqlitePlugin?(h=window.sqlitePlugin,p(n,"Opening "+e+" database using native plugin...")):window.openDatabase&&(h=window,p(n,"Opening "+e+" database using WebSQL...")),h?(X.db=m=h.openDatabase(e,r,i,s),m?(p(n,"Opened "+e+" database"),f.resolve(x)):v(f,"Failed to open database"),m.isDatabase=!0,m.readTransaction=m.readTransaction||m.transaction):(p(t,"WebSQL not implemented"),v(f,"WebSQL not implemented"))}catch(d){p(t,"Failed to open database "+e),v(f,"Failed to open database "+e,{exception:d})}return X.promise=c(f),X.promise}function A(e,r,i){p(n,"openDatabase",m,e,r,i);var s=l();try{y(m)?m.changeVersion(e,r,i,function(e){p(t,e),v(s,"Failed to change version",{sqlError:e})},function(){p(n,"SUCCESS changeVersion"),s.resolve(this)}):v(s,"Database not specified (db='"+m+"')")}catch(o){p(t,o),v(s,"Failed changeVersion(db, '"+e+"', '"+r+"'')",{exception:o})}return c(s)}function O(){var e="SELECT name, type, sql FROM sqlite_master WHERE type in ('table') AND name NOT LIKE '?_?_%' ESCAPE '?'";return B(e,function(e){var t=[],n=e.rows,r;for(r=0;r<n.length;r++)t.push(n.item(r));return t})}function M(e){var t="SELECT * FROM sqlite_master WHERE name = ?";return j(t,[e],function(e){return e||undefined})}function _(){return D(function(e){var t="SELECT name FROM sqlite_master WHERE type in ('table') AND name NOT LIKE '?_?_%' ESCAPE '?'";k(t),e.executeSql(t,[],function(e,t){var n=t.rows,r;for(r=0;r<n.length;r++){var i='DROP TABLE "'+n.item(r).name+'"';k(i),e.executeSql(i)}})})}function D(e){return F("transaction",e)}function P(e){return F("readTransaction",e)}function H(e,t,n){return q(D,e,t,n)}function B(e,t,n){return q(P,e,t,n)}function j(e){var t,n,r,i=1;return arguments[i]instanceof Array&&(t=arguments[i++]),arguments[i]instanceof Function&&(n=arguments[i++]),arguments[i]instanceof Object&&(r=arguments[i++]),h(B(e,t),function(e){var t;if(e.rows.length>1)return v(l(),new Error("Query returned "+e.rows.length+" rows"));if(e.rows.length===0)if(r)t=r;else{if(!n)return v(l(),new Error("Query returned 0 rows"));t=n()}else t=e.rows.item(0),n&&(t=n(t));return t})}function F(e,r){var i=l();p(n,e+": in");try{if(!y(m))v(i,"Database not specified (db='"+m+"')");else{var s=!1;m[e](function(o){s=!0;try{r(o)}catch(u){p(t,e+": exception "+u.message),v(i,e+" callback threw an exception",{exception:u}),p(n,e+": rejected")}},function(r){p(t,e+": error "+r),v(i,"Failed executing "+e.replace(/transaction/i,"")+" transaction",{sqlError:r}),p(n,e+": rejected")},function(){p(n,e+": resolving"),s?E&&!I(R)?v(i,"Transaction completed without executing all statements.",{errorCode:T.skippedStatements}):(i.resolve(this),p(n,e+": resolved")):v(i,"Transaction callback was skipped.",{errorCode:T.skippedCallback})})}}catch(o){p(t,e+": exception "+o),v(i,"Failed calling "+e,{exception:o}),p(n,e+": rejected")}return p(n,e+": out"),c(i)}function I(e){for(var t in e)if(e.hasOwnProperty(t))return!1;return!0}function q(e,t,n,r){function a(){function t(e,t,n){k(t,n),e.executeSql(t,n||[],function(e,t){i.push(r?r(t):t)})}return e(function(e){p(e,t)})}function f(){function n(n,o,u){var a=z();R[a]=!0,k(o,u),n.executeSql(o,u||[],function(n,o){delete R[a],i.push(r?r(o):o),e++,e==s&&t.resolve()},function(n,r){delete R[a],t.reject(r)})}var e=0,t=l();return p(E,n),c(t)}function p(e,r){var i;if(S(t)){o=!0,s=t.length;for(i=0;i<t.length;i++){var u=t[i],a=w(u.args)?n:u.args;r(e,g(u)?u:u.sql,a)}}else{o=S(n)&&S(n[0]);var f=o?n:[n];s=f.length;for(i=0;i<f.length;i++)r(e,t,f[i])}}var i=[];typeof n=="function"&&(r=n,n=undefined);var s,o,u=E?f():a();return h(u,function(){return o?i:i[0]},function(e){return e.sql=t,v(l(),e)})}function z(){return++U}function W(e){function t(){var t=l(),r,i=D(function(t){function n(e){k("Abort!"),t.executeSql("Abort!",null,null,function(){return r=e,!0})}E=t,h(e(),null,n)});return h(i,n,n),h(i,function(){t.resolve()},function(e){v(t,r||e)}),c(t)}function n(){E=undefined,R={},U=0}return b(e)?E?v(l(),new Error("A transaction batch is already in progress")):t():v(l(),new Error("No transaction batch callback was specified"))}var m,E,x=this,N,C=0;e.length>5?N=e.substr(0,4)+"â€¦":N=(e+"    ").substr(0,5);var R={},U=0,X={openDatabase:L,changeVersion:A,getTables:O,tableExists:M,destroyDatabase:_,transaction:D,transactionBatch:W,readTransaction:P,execute:H,read:B,readRow:j};Object.defineProperties(X,{isTransactionBatchInProgress:{get:function(){return!!E}},inProgressBatchTransaction:{get:function(){if(E)return new $(E)}},queryCount:{get:function(){return C}}});if(y(e)){X.db=m=e;var V=l();X.promise=c(V),V.resolve(this)}else e&&L(e,r,f,d);var $=function(e){this.executeSql=function(t,n,r,i){var s=z();R[s]=!0,k(t,n),e.executeSql(t,n,function(){delete R[s],r&&r.apply(this,arguments)},function(){delete R[s],i&&i.apply(this,arguments)})}};return X}function p(e){if(e<=r&&i){var t=Array.prototype.slice.call(arguments,1);t.unshift("WebSQL:"),b(i.text)?i.text(t,"color: purple"):b(i.log)&&i.log(t.join(" "))}}function d(e){i=e}function v(e,n,r){return g(n)&&(n=new Error(n)),r&&(r.exception&&(n.exception=r.exception),r.sqlError&&(n.sqlError=r.sqlError),r.errorCode&&(n.errorCode=r.errorCode)),p(t,"ERROR: "+n.message||n.exception||n.sqlError),e.reject(n),c(e)}function m(e){return Object.prototype.toString.call(e)}function g(e){return m(e)==="[object String]"}function y(e){return m(e)==="[object Database]"||e.isDatabase}function b(e){return m(e)==="[object Function]"}function w(e){return e===void 0}function E(e){return e&&b(e.then)}function x(e,t,n,r){return new f(e,t,n,r)}var e=0,t=1,n=2,r=e,i=console,s="",o=0,u=!0,a=navigator.userAgent.match(/(iPad|iPhone);/i),l=function(){throw new Error("websql.defer not configured")},c=function(e){return b(e.pipe)?e.promise():e.promise},h=function(e,t,n){var r=l();return e.then(function(e){t&&(e=t(e)),E(e)?e.then(r.resolve,r.reject):r.resolve(e)},function(e){n&&(e=n(e)),E(e)?e.then(r.resolve,r.reject):r.reject(e)}),c(r)},S;S=Array.isArray||function(e){return m(e)==="[object Array]"},x.config=function(e){return e&&(b(e.defer)&&(l=e.defer),b(e.trace)&&(i=e.trace),w(e.traceDb)||(s=e.traceDb),w(e.logVerbosity)||(r=e.logVerbosity)),{defer:l,trace:i,traceDb:s,logVerbosity:r}},x.queryCount=function(){return o},x.log={NONE:e,ERROR:t,DEBUG:n},window.when&&b(window.when.defer)?l=window.when.defer:window.Q&&b(window.Q.defer)?l=window.Q.defer:window.jQuery&&b(window.jQuery.Deferred)&&(l=window.jQuery.Deferred);var T={skippedCallback:"skippedCallback",skippedStatements:"skippedStatements"};return x.errorCodes=T,x._internal={pipe:h,promise:c},Object.defineProperties(x._internal,{defer:{get:function(){return l}},isFirstOpenDatabaseRequest:{get:function(){return u},set:function(e){u=e}},hasDbSizeIncreaseBug:{get:function(){return a},set:function(e){a=e}}}),x}),function(e){"use strict";e("lib/when",[],function(){function r(e,t,n,r){return i(e).then(t,n,r)}function i(e){var t;return e instanceof u?t=e:c(e)?t=s(e):t=a(e),t}function s(e){var t=l();try{e.then(function(e){t.resolve(e)},function(e){t.reject(e)},function(e){t.progress(e)})}catch(n){t.reject(n)}return t.promise}function o(e){return r(e,f)}function u(e){this.then=e}function a(e){var t=new u(function(t){try{return i(typeof t=="function"?t(e):e)}catch(n){return f(n)}});return t}function f(e){var t=new u(function(t,n){try{return i(typeof n=="function"?n(e):f(e))}catch(r){return f(r)}});return t}function l(){function h(e,t,n){return o(e,t,n)}function p(e){return c(i(e))}function d(e){return c(f(e))}function v(e){return a(e)}var e,t,r,s,o,a,c;return t=new u(h),e={then:h,resolve:p,reject:d,progress:v,notify:v,promise:t,resolver:{resolve:p,reject:d,progress:v,notify:v}},r=[],s=[],o=function(e,t,n){var i,o;return i=l(),o=typeof n=="function"?function(e){try{i.notify(n(e))}catch(t){i.notify(t)}}:function(e){i.notify(e)},r.push(function(n){n.then(e,t).then(i.resolve,i.reject,o)}),s.push(o),i.promise},a=function(e){return b(s,e),e},c=function(e){return o=e.then,c=i,a=S,b(r,e),s=r=n,e},e}function c(e){return e&&typeof e.then=="function"}function h(e,t,n,i,s){return w(2,arguments),r(e,function(e){function g(e){p(e)}function y(e){h(e)}var o,u,a,f,c,h,p,d,v,m;v=e.length>>>0,o=Math.max(0,Math.min(t,v)),a=[],u=v-o+1,f=[],c=l();if(!o)c.resolve(a);else{d=c.notify,p=function(e){f.push(e),--u||(h=p=E,c.reject(f))},h=function(e){a.push(e),--o||(h=p=E,c.resolve(a))};for(m=0;m<v;++m)m in e&&r(e[m],y,g,d)}return c.promise.then(n,i,s)})}function p(e,t,n,r){function i(e){return t?t(e[0]):e[0]}return h(e,1,i,n,r)}function d(e,t,n,r){return w(1,arguments),m(e,S).then(t,n,r)}function v(){return m(arguments,S)}function m(e,t){return r(e,function(e){var n,i,s,o,u,a;s=i=e.length>>>0,n=[],a=l();if(!s)a.resolve(n);else{o=function(i,o){r(i,t).then(function(e){n[o]=e,--s||a.resolve(n)},a.reject)};for(u=0;u<i;u++)u in e?o(e[u],u):--s}return a.promise})}function g(n,i){var s=t.call(arguments,1);return r(n,function(t){var n;return n=t.length,s[0]=function(e,t,s){return r(e,function(e){return r(t,function(t){return i(e,t,s,n)})})},e.apply(t,s)})}function y(e,t,n){var i=arguments.length>2;return r(e,function(e){return e=i?n:e,t.resolve(e),e},function(e){return t.reject(e),f(e)},function(e){return typeof t.notify=="function"&&t.notify(e),e})}function b(e,t){var n,r=0;while(n=e[r++])n(t)}function w(e,t){var n,r=t.length;while(r>e){n=t[--r];if(n!=null&&typeof n!="function")throw new Error("arg "+r+" must be a function")}}function E(){}function S(e){return e}var e,t,n;return r.defer=l,r.resolve=i,r.reject=o,r.join=v,r.all=d,r.map=m,r.reduce=g,r.any=p,r.some=h,r.chain=y,r.isPromise=c,u.prototype={always:function(e,t){return this.then(e,e,t)},otherwise:function(e){return this.then(n,e)},yield:function(e){return this.then(function(){return e})},spread:function(e){return this.then(function(t){return d(t,function(t){return e.apply(n,t)})})}},t=[].slice,e=[].reduce||function(e){var t,n,r,i,s;s=0,t=Object(this),i=t.length>>>0,n=arguments;if(n.length<=1)for(;;){if(s in t){r=t[s++];break}if(++s>=i)throw new TypeError}else r=n[1];for(;s<i;++s)s in t&&(r=e(r,t[s],s,t));return r},r})}(typeof define=="function"&&define.amd?define:function(e){typeof exports=="object"?module.exports=e():this.when=e()}),function(e){e("lib/callbacks",["./when"],function(e){function n(t,n){return e.all(n||[]).then(function(n){var r=e.defer(),i=n.concat(u(r.resolve),u(r.reject));return t.apply(null,i),r.promise})}function r(e){var r=t.call(arguments,1);return n(e,r)}function i(e){var r=t.call(arguments,1);return function(){var i=t.call(arguments,0);return n(e,r.concat(i))}}function s(t,n){return function(){var r=o(),i=e.defer();return"callback"in n&&r.add(n.callback,u(i.resolve)),"errback"in n&&r.add(n.errback,u(i.reject)),e.all(arguments).then(function(e){return r.fillHolesWith(e),t.apply(null,r.toArray()),i.promise})}}function o(){var e=[],n=[];return{add:function(t,r){if(t>=0)e[t]=r;else{var i=Math.abs(t)-1;n[i]=r}},fillHolesWith:function(t){var n,r;for(n=0,r=0;n<t.length;n++,r++){while(r in e)r++;e[r]=t[n]}},toArray:function(){var r=t.call(e,0);for(var i=n.length-1;i>=0;i--)r.push(n[i]);return r}}}function u(e){return function(){arguments.length<=1?e.apply(null,arguments):e.call(null,t.call(arguments,0))}}var t=[].slice;return{apply:n,call:r,bind:i,promisify:s}})}(typeof define=="function"?define:function(e,t){typeof module!="undefined"?module.exports=t(require("./when")):this.when_callback=t(this.when)}),function(){var e=this,t=e._,n={},r=Array.prototype,i=Object.prototype,s=Function.prototype,o=r.push,u=r.slice,a=r.concat,f=i.toString,l=i.hasOwnProperty,c=r.forEach,h=r.map,p=r.reduce,d=r.reduceRight,v=r.filter,m=r.every,g=r.some,y=r.indexOf,b=r.lastIndexOf,w=Array.isArray,E=Object.keys,S=s.bind,x=function(e){if(e instanceof x)return e;if(!(this instanceof x))return new x(e);this._wrapped=e};typeof exports!="undefined"?(typeof module!="undefined"&&module.exports&&(exports=module.exports=x),exports._=x):e._=x,x.VERSION="1.4.4";var T=x.each=x.forEach=function(e,t,r){if(e==null)return;if(c&&e.forEach===c)e.forEach(t,r);else if(e.length===+e.length){for(var i=0,s=e.length;i<s;i++)if(t.call(r,e[i],i,e)===n)return}else for(var o in e)if(x.has(e,o)&&t.call(r,e[o],o,e)===n)return};x.map=x.collect=function(e,t,n){var r=[];return e==null?r:h&&e.map===h?e.map(t,n):(T(e,function(e,i,s){r[r.length]=t.call(n,e,i,s)}),r)};var N="Reduce of empty array with no initial value";x.reduce=x.foldl=x.inject=function(e,t,n,r){var i=arguments.length>2;e==null&&(e=[]);if(p&&e.reduce===p)return r&&(t=x.bind(t,r)),i?e.reduce(t,n):e.reduce(t);T(e,function(e,s,o){i?n=t.call(r,n,e,s,o):(n=e,i=!0)});if(!i)throw new TypeError(N);return n},x.reduceRight=x.foldr=function(e,t,n,r){var i=arguments.length>2;e==null&&(e=[]);if(d&&e.reduceRight===d)return r&&(t=x.bind(t,r)),i?e.reduceRight(t,n):e.reduceRight(t);var s=e.length;if(s!==+s){var o=x.keys(e);s=o.length}T(e,function(u,a,f){a=o?o[--s]:--s,i?n=t.call(r,n,e[a],a,f):(n=e[a],i=!0)});if(!i)throw new TypeError(N);return n},x.find=x.detect=function(e,t,n){var r;return C(e,function(e,i,s){if(t.call(n,e,i,s))return r=e,!0}),r},x.filter=x.select=function(e,t,n){var r=[];return e==null?r:v&&e.filter===v?e.filter(t,n):(T(e,function(e,i,s){t.call(n,e,i,s)&&(r[r.length]=e)}),r)},x.reject=function(e,t,n){return x.filter(e,function(e,r,i){return!t.call(n,e,r,i)},n)},x.every=x.all=function(e,t,r){t||(t=x.identity);var i=!0;return e==null?i:m&&e.every===m?e.every(t,r):(T(e,function(e,s,o){if(!(i=i&&t.call(r,e,s,o)))return n}),!!i)};var C=x.some=x.any=function(e,t,r){t||(t=x.identity);var i=!1;return e==null?i:g&&e.some===g?e.some(t,r):(T(e,function(e,s,o){if(i||(i=t.call(r,e,s,o)))return n}),!!i)};x.contains=x.include=function(e,t){return e==null?!1:y&&e.indexOf===y?e.indexOf(t)!=-1:C(e,function(e){return e===t})},x.invoke=function(e,t){var n=u.call(arguments,2),r=x.isFunction(t);return x.map(e,function(e){return(r?t:e[t]).apply(e,n)})},x.pluck=function(e,t){return x.map(e,function(e){return e[t]})},x.where=function(e,t,n){return x.isEmpty(t)?n?null:[]:x[n?"find":"filter"](e,function(e){for(var n in t)if(t[n]!==e[n])return!1;return!0})},x.findWhere=function(e,t){return x.where(e,t,!0)},x.max=function(e,t,n){if(!t&&x.isArray(e)&&e[0]===+e[0]&&e.length<65535)return Math.max.apply(Math,e);if(!t&&x.isEmpty(e))return-Infinity;var r={computed:-Infinity,value:-Infinity};return T(e,function(e,i,s){var o=t?t.call(n,e,i,s):e;o>=r.computed&&(r={value:e,computed:o})}),r.value},x.min=function(e,t,n){if(!t&&x.isArray(e)&&e[0]===+e[0]&&e.length<65535)return Math.min.apply(Math,e);if(!t&&x.isEmpty(e))return Infinity;var r={computed:Infinity,value:Infinity};return T(e,function(e,i,s){var o=t?t.call(n,e,i,s):e;o<r.computed&&(r={value:e,computed:o})}),r.value},x.shuffle=function(e){var t,n=0,r=[];return T(e,function(e){t=x.random(n++),r[n-1]=r[t],r[t]=e}),r};var k=function(e){return x.isFunction(e)?e:function(t){return t[e]}};x.sortBy=function(e,t,n){var r=k(t);return x.pluck(x.map(e,function(e,t,i){return{value:e,index:t,criteria:r.call(n,e,t,i)}}).sort(function(e,t){var n=e.criteria,r=t.criteria;if(n!==r){if(n>r||n===void 0)return 1;if(n<r||r===void 0)return-1}return e.index<t.index?-1:1}),"value")};var L=function(e,t,n,r){var i={},s=k(t||x.identity);return T(e,function(t,o){var u=s.call(n,t,o,e);r(i,u,t)}),i};x.groupBy=function(e,t,n){return L(e,t,n,function(e,t,n){(x.has(e,t)?e[t]:e[t]=[]).push(n)})},x.countBy=function(e,t,n){return L(e,t,n,function(e,t){x.has(e,t)||(e[t]=0),e[t]++})},x.sortedIndex=function(e,t,n,r){n=n==null?x.identity:k(n);var i=n.call(r,t),s=0,o=e.length;while(s<o){var u=s+o>>>1;n.call(r,e[u])<i?s=u+1:o=u}return s},x.toArray=function(e){return e?x.isArray(e)?u.call(e):e.length===+e.length?x.map(e,x.identity):x.values(e):[]},x.size=function(e){return e==null?0:e.length===+e.length?e.length:x.keys(e).length},x.first=x.head=x.take=function(e,t,n){return e==null?void 0:t!=null&&!n?u.call(e,0,t):e[0]},x.initial=function(e,t,n){return u.call(e,0,e.length-(t==null||n?1:t))},x.last=function(e,t,n){return e==null?void 0:t!=null&&!n?u.call(e,Math.max(e.length-t,0)):e[e.length-1]},x.rest=x.tail=x.drop=function(e,t,n){return u.call(e,t==null||n?1:t)},x.compact=function(e){return x.filter(e,x.identity)};var A=function(e,t,n){return T(e,function(e){x.isArray(e)?t?o.apply(n,e):A(e,t,n):n.push(e)}),n};x.flatten=function(e,t){return A(e,t,[])},x.without=function(e){return x.difference(e,u.call(arguments,1))},x.uniq=x.unique=function(e,t,n,r){x.isFunction(t)&&(r=n,n=t,t=!1);var i=n?x.map(e,n,r):e,s=[],o=[];return T(i,function(n,r){if(t?!r||o[o.length-1]!==n:!x.contains(o,n))o.push(n),s.push(e[r])}),s},x.union=function(){return x.uniq(a.apply(r,arguments))},x.intersection=function(e){var t=u.call(arguments,1);return x.filter(x.uniq(e),function(e){return x.every(t,function(t){return x.indexOf(t,e)>=0})})},x.difference=function(e){var t=a.apply(r,u.call(arguments,1));return x.filter(e,function(e){return!x.contains(t,e)})},x.zip=function(){var e=u.call(arguments),t=x.max(x.pluck(e,"length")),n=new Array(t);for(var r=0;r<t;r++)n[r]=x.pluck(e,""+r);return n},x.object=function(e,t){if(e==null)return{};var n={};for(var r=0,i=e.length;r<i;r++)t?n[e[r]]=t[r]:n[e[r][0]]=e[r][1];return n},x.indexOf=function(e,t,n){if(e==null)return-1;var r=0,i=e.length;if(n){if(typeof n!="number")return r=x.sortedIndex(e,t),e[r]===t?r:-1;r=n<0?Math.max(0,i+n):n}if(y&&e.indexOf===y)return e.indexOf(t,n);for(;r<i;r++)if(e[r]===t)return r;return-1},x.lastIndexOf=function(e,t,n){if(e==null)return-1;var r=n!=null;if(b&&e.lastIndexOf===b)return r?e.lastIndexOf(t,n):e.lastIndexOf(t);var i=r?n:e.length;while(i--)if(e[i]===t)return i;return-1},x.range=function(e,t,n){arguments.length<=1&&(t=e||0,e=0),n=arguments[2]||1;var r=Math.max(Math.ceil((t-e)/n),0),i=0,s=new Array(r);while(i<r)s[i++]=e,e+=n;return s},x.bind=function(e,t){if(e.bind===S&&S)return S.apply(e,u.call(arguments,1));var n=u.call(arguments,2);return function(){return e.apply(t,n.concat(u.call(arguments)))}},x.partial=function(e){var t=u.call(arguments,1);return function(){return e.apply(this,t.concat(u.call(arguments)))}},x.bindAll=function(e){var t=u.call(arguments,1);return t.length===0&&(t=x.functions(e)),T(t,function(t){e[t]=x.bind(e[t],e)}),e},x.memoize=function(e,t){var n={};return t||(t=x.identity),function(){var r=t.apply(this,arguments);return x.has(n,r)?n[r]:n[r]=e.apply(this,arguments)}},x.delay=function(e,t){var n=u.call(arguments,2);return setTimeout(function(){return e.apply(null,n)},t)},x.defer=function(e){return x.delay.apply(x,[e,1].concat(u.call(arguments,1)))},x.throttle=function(e,t){var n,r,i,s,o=0,u=function(){o=new Date,i=null,s=e.apply(n,r)};return function(){var a=new Date,f=t-(a-o);return n=this,r=arguments,f<=0?(clearTimeout(i),i=null,o=a,s=e.apply(n,r)):i||(i=setTimeout(u,f)),s}},x.debounce=function(e,t,n){var r,i;return function(){var s=this,o=arguments,u=function(){r=null,n||(i=e.apply(s,o))},a=n&&!r;return clearTimeout(r),r=setTimeout(u,t),a&&(i=e.apply(s,o)),i}},x.once=function(e){var t=!1,n;return function(){return t?n:(t=!0,n=e.apply(this,arguments),e=null,n)}},x.wrap=function(e,t){return function(){var n=[e];return o.apply(n,arguments),t.apply(this,n)}},x.compose=function(){var e=arguments;return function(){var t=arguments;for(var n=e.length-1;n>=0;n--)t=[e[n].apply(this,t)];return t[0]}},x.after=function(e,t){return e<=0?t():function(){if(--e<1)return t.apply(this,arguments)}},x.keys=E||function(e){if(e!==Object(e))throw new TypeError("Invalid object");var t=[];for(var n in e)x.has(e,n)&&(t[t.length]=n);return t},x.values=function(e){var t=[];for(var n in e)x.has(e,n)&&t.push(e[n]);return t},x.pairs=function(e){var t=[];for(var n in e)x.has(e,n)&&t.push([n,e[n]]);return t},x.invert=function(e){var t={};for(var n in e)x.has(e,n)&&(t[e[n]]=n);return t},x.functions=x.methods=function(e){var t=[];for(var n in e)x.isFunction(e[n])&&t.push(n);return t.sort()},x.extend=function(e){return T(u.call(arguments,1),function(t){if(t)for(var n in t)e[n]=t[n]}),e},x.pick=function(e){var t={},n=a.apply(r,u.call(arguments,1));return T(n,function(n){n in e&&(t[n]=e[n])}),t},x.omit=function(e){var t={},n=a.apply(r,u.call(arguments,1));for(var i in e)x.contains(n,i)||(t[i]=e[i]);return t},x.defaults=function(e){return T(u.call(arguments,1),function(t){if(t)for(var n in t)e[n]==null&&(e[n]=t[n])}),e},x.clone=function(e){return x.isObject(e)?x.isArray(e)?e.slice():x.extend({},e):e},x.tap=function(e,t){return t(e),e};var O=function(e,t,n,r){if(e===t)return e!==0||1/e==1/t;if(e==null||t==null)return e===t;e instanceof x&&(e=e._wrapped),t instanceof x&&(t=t._wrapped);var i=f.call(e);if(i!=f.call(t))return!1;switch(i){case"[object String]":return e==String(t);case"[object Number]":return e!=+e?t!=+t:e==0?1/e==1/t:e==+t;case"[object Date]":case"[object Boolean]":return+e==+t;case"[object RegExp]":return e.source==t.source&&e.global==t.global&&e.multiline==t.multiline&&e.ignoreCase==t.ignoreCase}if(typeof e!="object"||typeof t!="object")return!1;var s=n.length;while(s--)if(n[s]==e)return r[s]==t;n.push(e),r.push(t);var o=0,u=!0;if(i=="[object Array]"){o=e.length,u=o==t.length;if(u)while(o--)if(!(u=O(e[o],t[o],n,r)))break}else{var a=e.constructor,l=t.constructor;if(a!==l&&!(x.isFunction(a)&&a instanceof a&&x.isFunction(l)&&l instanceof l))return!1;for(var c in e)if(x.has(e,c)){o++;if(!(u=x.has(t,c)&&O(e[c],t[c],n,r)))break}if(u){for(c in t)if(x.has(t,c)&&!(o--))break;u=!o}}return n.pop(),r.pop(),u};x.isEqual=function(e,t){return O(e,t,[],[])},x.isEmpty=function(e){if(e==null)return!0;if(x.isArray(e)||x.isString(e))return e.length===0;for(var t in e)if(x.has(e,t))return!1;return!0},x.isElement=function(e){return!!e&&e.nodeType===1},x.isArray=w||function(e){return f.call(e)=="[object Array]"},x.isObject=function(e){return e===Object(e)},T(["Arguments","Function","String","Number","Date","RegExp"],function(e){x["is"+e]=function(t){return f.call(t)=="[object "+e+"]"}}),x.isArguments(arguments)||(x.isArguments=function(e){return!!e&&!!x.has(e,"callee")}),typeof /./!="function"&&(x.isFunction=function(e){return typeof e=="function"}),x.isFinite=function(e){return isFinite(e)&&!isNaN(parseFloat(e))},x.isNaN=function(e){return x.isNumber(e)&&e!=+e},x.isBoolean=function(e){return e===!0||e===!1||f.call(e)=="[object Boolean]"},x.isNull=function(e){return e===null},x.isUndefined=function(e){return e===void 0},x.has=function(e,t){return l.call(e,t)},x.noConflict=function(){return e._=t,this},x.identity=function(e){return e},x.times=function(e,t,n){var r=Array(e);for(var i=0;i<e;i++)r[i]=t.call(n,i);return r},x.random=function(e,t){return t==null&&(t=e,e=0),e+Math.floor(Math.random()*(t-e+1))};var M={escape:{"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","/":"&#x2F;"}};M.unescape=x.invert(M.escape);var _={escape:new RegExp("["+x.keys(M.escape).join("")+"]","g"),unescape:new RegExp("("+x.keys(M.unescape).join("|")+")","g")};x.each(["escape","unescape"],function(e){x[e]=function(t){return t==null?"":(""+t).replace(_[e],function(t){return M[e][t]})}}),x.result=function(e,t){if(e==null)return null;var n=e[t];return x.isFunction(n)?n.call(e):n},x.mixin=function(e){T(x.functions(e),function(t){var n=x[t]=e[t];x.prototype[t]=function(){var e=[this._wrapped];return o.apply(e,arguments),j.call(this,n.apply(x,e))}})};var D=0;x.uniqueId=function(e){var t=++D+"";return e?e+t:t},x.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var P=/(.)^/,H={"'":"'","\\":"\\","\r":"r","\n":"n","	":"t","\u2028":"u2028","\u2029":"u2029"},B=/\\|'|\r|\n|\t|\u2028|\u2029/g;x.template=function(e,t,n){var r;n=x.defaults({},n,x.templateSettings);var i=new RegExp([(n.escape||P).source,(n.interpolate||P).source,(n.evaluate||P).source].join("|")+"|$","g"),s=0,o="__p+='";e.replace(i,function(t,n,r,i,u){return o+=e.slice(s,u).replace(B,function(e){return"\\"+H[e]}),n&&(o+="'+\n((__t=("+n+"))==null?'':_.escape(__t))+\n'"),r&&(o+="'+\n((__t=("+r+"))==null?'':__t)+\n'"),i&&(o+="';\n"+i+"\n__p+='"),s=u+t.length,t}),o+="';\n",n.variable||(o="with(obj||{}){\n"+o+"}\n"),o="var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};\n"+o+"return __p;\n";try{r=new Function(n.variable||"obj","_",o)}catch(u){throw u.source=o,u}if(t)return r(t,x);var a=function(e){return r.call(this,e,x)};return a.source="function("+(n.variable||"obj")+"){\n"+o+"}",a},x.chain=function(e){return x(e).chain()};var j=function(e){return this._chain?x(e).chain():e};x.mixin(x),T(["pop","push","reverse","shift","sort","splice","unshift"],function(e){var t=r[e];x.prototype[e]=function(){var n=this._wrapped;return t.apply(n,arguments),(e=="shift"||e=="splice")&&n.length===0&&delete n[0],j.call(this,n)}}),T(["concat","join","slice"],function(e){var t=r[e];x.prototype[e]=function(){return j.call(this,t.apply(this._wrapped,arguments))}}),x.extend(x.prototype,{chain:function(){return this._chain=!0,this},value:function(){return this._wrapped}})}.call(this),define("underscore",function(e){return function(){var t,n;return t||e._}}(this)),define("Constants",[],function(){"use strict";var e={data:"data",dataAdded:"data:added",dataModified:"data:modified",dataDeleted:"data:deleted",dataSynced:"data:synced",dataReset:"data:reset",modelChanged:"model:changed",syncPreparingUploadXacts:"sync:preparingUploadXacts",syncUploadingXacts:"sync:uploadingXacts",syncUploadedXacts:"sync:uploadedXacts",syncDownloadingXacts:"sync:downloadingXacts",syncDownloadedXacts:"sync:downloadedXacts",syncProcessingXacts:"sync:processingXacts",syncProcessedXacts:"sync:processedXacts"},t={fileSet:"file:set"},n={invalidCredentials:"InvalidCredentials",invalidLocalCredentials:"InvalidLocalCredentials",dataRepostInProgress:"DataRepostInProgress",invalidSessionId:"InvalidSessionId",badFilter:"BadFilter",noDataAccessComponent:"NoDataAccessComponent",requestRejected:"RequestRejected",registerDeviceRejected:"RegisterDeviceRejected",deviceRpcRejected:"DeviceRpcRejected",authTokenRequired:"AuthTokenRequired",insufficientPrereqs:"InsufficientPrerequisites",clientNotInstalled:"ClientNotInstalled",deviceNotRegistered:"DeviceNotRegistered",canceled:"Canceled",noDatastore:"NoDatastore",dataNotUnique:"DataNotUnique",dataNotFound:"DataNotFound",refFieldNotFetched:"RefFieldNotFetched",mergedRefNotSupported:"mergedRefNotSupported",invalidMergedReference:"invalidMergedReference",unknownFieldOrElement:"unknownFieldOrElement",fileNotUnique:"FileNotUnique",fileNameMissing:"FileNameMissing",fileNotDownloaded:"FileNotDownloaded",fileElementIsNew:"FileElementIsNew",fileElementNoChanges:"FileElementNoChanges",fileElementNotSaved:"FileElementNotSaved",syncInProgress:"SyncInProgress",offline:"Offline",uiInterruptedTransaction:"uiInterruptedTransaction",uiSkippedTransaction:"uiSkippedTransaction",ajaxRequestTimeout:"AjaxTimeout",ajaxRequestAbort:"AjaxAbort",ajaxRequestParseError:"AjaxParserError",ajaxRequestError:"AjaxError",databaseOutOfMemory:"DatabaseOutOfMemory",serverFileNotFound:"ServerFileNotFount",serverFileNewer:"ServerFileNewer",notSupported:"NotSupported",invalidArgs:"InvalidArgs",unknownModelField:"UnknownModelField",unknownModelClass:"UnknownModelClass",unknownModelElement:"UnknownModelElement",unknownModelCollection:"UnknownModelCollection",missingValue:"MissingValue",invalidFile:"InvalidFile",missingDomainName:"MissingDomainName"},r={notSupported:"DeviceRegistrationNotSupported",invalidUserCredentials:"InvalidUserCredentials",userDeviceLimitExceeded:"UserDeviceLimitExceeded",systemDeviceLimitExceeded:"SystemDeviceLimitExceeded",applicationError:"ApplicationError"},i={notSupported:"DeviceRpcNotSupported",authenticationRequired:"AuthenticatedDeviceRequired",notAuthorized:"NotAuthorized",applicationError:"ApplicationError"},s={applyingServerChanges:"ApplyingServerChanges",preparingUpload:"PreparingUpload",extractingFile:"ExtractingFile",resettingDatabase:"ResettingDatabase",deployingDatabase:"DeployingDatabase",uploadingFile:"UploadingFile",downloadingFile:"DownloadingFile",downloadingSegment:"DownloadingSegment",checkingForAttachmentUploads:"CheckingForAttachmentUploads",checkingForAttachmentDownloads:"CheckingForAttachmentDownloads",downloadingVaultFiles:"DownloadingVaultFiles",downloadingVaultFile:"DownloadingVaultFile",uploadingVaultFiles:"UploadingVaultFiles",uploadingVaultFile:"UploadingVaultFile",authenticating:"Authenticating",disconnecting:"Disconnecting",requestingFiles:"RequestingFiles",registeringDevice:"RegisteringDevice"},o={"new":"new",saved:"saved",changed:"changed",deleted:"deleted"},u={closed:"closed",opened:"opened",privileged:"privileged"},a={none:"none",existingUser:"existingUser",changeUser:"changeUser"},f={easIos:"easIos",easAndroid:"easAndroid",easWindows8:"easWindows8",browser:"browser"},l={UNKNOWN_ERR:0,DATABASE_ERR:1,VERSION_ERR:2,TOO_LARGE_ERR:3,QUOTA_ERR:4,SYNTAX_ERR:5,CONSTRAINT_ERR:6,TIMEOUT_ERR:7};return{connectionEvents:e,dataEvents:t,errorCodes:n,messageCodes:s,elementStates:o,connectionStates:u,devicePlatforms:f,registerDeviceCodes:r,deviceRpcCodes:i,deviceSharing:a,sqlError:l}}),define("lib/when-extensions",["lib/when"],function(e){"use strict";var t=Object.getPrototypeOf(e.defer().promise);t.tap=function(t){return this.then(t).yield(this)}}),define("AH",["lib/websql","lib/when","lib/callbacks","underscore","Constants","lib/when-extensions"],function(e,t,n,r,i){"use strict";return function(){function s(e){if(e instanceof Date)return new Date(e.valueOf()+6e4*e.getTimezoneOffset());throw new Error("Invalid getLocalTimeAsUtc parameter: "+JSON.stringify(e))}function o(e){if(e instanceof Date)return new Date(e.valueOf()-6e4*e.getTimezoneOffset());throw new Error("Invalid getUtcAsLocalTime parameter: "+JSON.stringify(e))}function a(e,n){function s(){i&&(r.progress(e),i=!1)}var r=u(),i=!0;return setTimeout(s,0),t(n,function(e){s(),r.resolve(e)},function(e){s(),r.reject(e)},function(e){s(),r.progress(e)}),r.promise}function f(e,n){return t.chain(e,n)}function l(e,t,n){function s(){clearInterval(i),i=null,e.apply(t,n||[])}var r=this,i;this.delay=function(o,u,a,f){r.cancel(),e=u||e,t=a||t,n=f||n,i=setInterval(s,o)},this.cancel=function(){i&&(clearInterval(i),i=null)}}function c(){if(arguments.length===0)return undefined;var e=arguments[0],t=/(?:\{(.*?)\})/g,n=arguments,r=e.replace(t,function(e,t){var r=t.split(":",2),i=r.shift().split(",",2),s=n[parseInt(i[0],10)+1],o=r.shift();if(N(s)&&S(o)){var u,a;o.replace(/^([0#]*)(?:\.([0#]*))?/,function(e,t,n){u=t,a=n});if(S(u)||S(a)){s=String(s.toFixed((a||"").length));var f=s.indexOf(".");f<0&&(f=s.length),f=(u||"").length-f;while(f-->0)s="0"+s}}if(i.length===2){var l=parseInt(i[1],10),c=(l>0?l:-l)-s.length;if(c>0){var h=[];while(c>0)h.push(" "),c--;l>0?h.push(s):h.unshift(s),s=h.join("")}}return s});return r}function h(e,t){var n=S(e)?Number(Number(e).toFixed(t)):e;if(!N(n))throw new Error("Invalid parameter value: "+JSON.stringify(e));return n}function p(e){if(r.isNull(e))return null;if(N(e))return Boolean(e);e=String(e).toLowerCase();if(e==="true")return!0;if(e==="false")return!1;throw new Error("Invalid parameter value: "+JSON.stringify(e))}function d(e){if(!r.isBoolean(e))throw new Error("Invalid parameter type: "+typeof e);return e?1:0}function v(e){if(x(e))return e;if(typeof e=="string"){var t=/^(\d{4})-(\d{2})-(\d{2}) (\d{2}):(\d{2}):(\d{2})$/.exec(e);if(t){var n=new Date(Number(t[1]),Number(t[2])-1,Number(t[3]),Number(t[4]),Number(t[5]),Number(t[6]));return n}}return null}function m(e){var t=c("{0:0000}-{1:00}-{2:00} {3:00}:{4:00}:{5:00}",e.getFullYear(),e.getMonth()+1,e.getDate(),e.getHours(),e.getMinutes(),e.getSeconds());return t}function g(e){if(r.isUndefined(e)||r.isNull(e))return null;var t=window.atob(e),n=[];for(var i=0;i<t.length;i++)n.push(t.charCodeAt(i));return n}function y(e){if(!e||e instanceof Array){if(!e)return null;var t=r.map(e,function(e){return String.fromCharCode(e)}).join("");return window.btoa(t)}throw new Error("blobToDb requires an array of bytes")}function b(e){if(!S(e))return null;if(e instanceof ArrayBuffer){var t="",n=new Uint8Array(e),r=n.byteLength;for(var i=0;i<r;i++)t+=String.fromCharCode(n[i]);return window.btoa(t)}throw new Error("'buffer' is not a valid ArrayBuffer.")}function w(e){if(!S(e))return null;if(!r.isString(e))throw new Error("'base64' is not a valid String.");var t=window.atob(e),n=t.length,i=new ArrayBuffer(n),s=new Uint8Array(i);for(var o=0;o<n;o++)s[o]=t.charCodeAt(o);return i}function E(e,t){var n=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder;if(n){var r=new n;return r.append(e),r.getBlob(t)}if(window.Blob){var i=t?{type:t}:{};return new Blob([e],i)}throw new Error("Blob creation is not supported")}function S(e){return e!==null&&e!==undefined}function x(e){return e instanceof Date}function T(e){return typeof e=="boolean"}function N(e){return typeof e=="number"&&isFinite(e)}function C(e){return typeof e=="string"}function k(e){return!S(e)||e===""||L(e)&&!e.length}function L(e){return Object.prototype.toString.call(e)==="[object Array]"}function A(e,t,n){return typeof e!="object"||typeof t!="object"?e:(typeof n=="object"&&(e=A(e,n)),r.forEach(t,function(t,n){e[n]=t}),e)}function O(e,t,n,i){var s=e.caches||(e.caches={}),o=s[t];return o||(s[t]=o={},r.each(e,function(e){o[e[t]]=e})),!(n in o)&&i&&i(),o[n]}function M(e,t){return r.forEach(t,function(t){e.push(t)}),e}function D(e,t){try{return e.call(t)}catch(n){return n instanceof Error?H(n):H(new Error(n))}}function P(e){return t.resolve(e)}function H(e){return t.reject(e)}function B(e){return t.all(r.map(e,function(e){return e.then(function(e){return{state:"fulfilled",value:e}},function(e){return{state:"rejected",reason:e}})}))}function j(t){if(t.mdoCode)return t;if(t.errorCode)switch(t.errorCode){case e.errorCodes.skippedStatements:t.message="Database transaction interrupted by user interaction. Please sync again.",t.mdoCode=i.errorCodes.uiInterruptedTransaction;break;case e.errorCodes.skippedCallback:t.message="Database transaction interrupted by user interaction. Please sync again.",t.mdoCode=i.errorCodes.uiSkippedTransaction;break;default:}else if(t.sqlError){i.sqlError.QUOTA_ERR||(t.message="Unknown SQL Error: "+t.sqlError.message);switch(t.sqlError.code){case i.sqlError.QUOTA_ERR:t.message="Database quota exceeded.",t.mdoCode=i.errorCodes.databaseOutOfMemory;break;default:}}return t}function F(e,t){t&&(e=r.bind(e,t));if(arguments.length<=2)return n.call(e);var i=Array.prototype.slice.call(arguments,2);return n.apply(e,i)}function I(e,t){t&&(e=r.bind(e,t));if(arguments.length<=2)return n.bind(e);var i=Array.prototype.slice.call(arguments,2);return i.unshift(e),n.bind.apply(n,i)}function q(){return window.navigator.onLine}var u=t.defer;return e.config({defer:u}),{getLocalTimeAsUtc:s,getUtcAsLocalTime:o,format:c,toFixedNumber:h,boolFromDb:p,boolToDb:d,dateFromDb:v,dateToDb:m,blobFromDb:g,blobToDb:y,arrayBufferToBase64String:b,base64StringToArrayBuffer:w,createBlob:E,notify:a,chainPromise:f,DelayedTask:l,isDefined:S,isBoolean:T,isDate:x,isNumber:N,isString:C,isEmpty:k,isArray:L,apply:A,cachedArrayLookup:O,appendArray:M,deferredTryCatch:D,when:t,whenAll:t.all,whenSettle:B,defer:u,resolve:P,reject:H,whenCallViaCallbacks:F,bindCallViaCallbacks:I,websql:e,normalizeWebSqlError:j,isOnline:q}}()}),function(){var e=this,t=e.Backbone,n=[],r=n.push,i=n.slice,s=n.splice,o;typeof exports!="undefined"?o=exports:o=e.Backbone={},o.VERSION="1.0.0";var u=e._;!u&&typeof require!="undefined"&&(u=require("underscore")),o.$=e.jQuery||e.Zepto||e.ender||e.$,o.noConflict=function(){return e.Backbone=t,this},o.emulateHTTP=!1,o.emulateJSON=!1;var a=o.Events={on:function(e,t,n){if(!l(this,"on",e,[t,n])||!t)return this;this._events||(this._events={});var r=this._events[e]||(this._events[e]=[]);return r.push({callback:t,context:n,ctx:n||this}),this},once:function(e,t,n){if(!l(this,"once",e,[t,n])||!t)return this;var r=this,i=u.once(function(){r.off(e,i),t.apply(this,arguments)});return i._callback=t,this.on(e,i,n)},off:function(e,t,n){var r,i,s,o,a,f,c,h;if(!this._events||!l(this,"off",e,[t,n]))return this;if(!e&&!t&&!n)return this._events={},this;o=e?[e]:u.keys(this._events);for(a=0,f=o.length;a<f;a++){e=o[a];if(s=this._events[e]){this._events[e]=r=[];if(t||n)for(c=0,h=s.length;c<h;c++)i=s[c],(t&&t!==i.callback&&t!==i.callback._callback||n&&n!==i.context)&&r.push(i);r.length||delete this._events[e]}}return this},trigger:function(e){if(!this._events)return this;var t=i.call(arguments,1);if(!l(this,"trigger",e,t))return this;var n=this._events[e],r=this._events.all;return n&&c(n,t),r&&c(r,arguments),this},stopListening:function(e,t,n){var r=this._listeners;if(!r)return this;var i=!t&&!n;typeof t=="object"&&(n=this),e&&((r={})[e._listenerId]=e);for(var s in r)r[s].off(t,n,this),i&&delete this._listeners[s];return this}},f=/\s+/,l=function(e,t,n,r){if(!n)return!0;if(typeof n=="object"){for(var i in n)e[t].apply(e,[i,n[i]].concat(r));return!1}if(f.test(n)){var s=n.split(f);for(var o=0,u=s.length;o<u;o++)e[t].apply(e,[s[o]].concat(r));return!1}return!0},c=function(e,t){var n,r=-1,i=e.length,s=t[0],o=t[1],u=t[2];switch(t.length){case 0:while(++r<i)(n=e[r]).callback.call(n.ctx);return;case 1:while(++r<i)(n=e[r]).callback.call(n.ctx,s);return;case 2:while(++r<i)(n=e[r]).callback.call(n.ctx,s,o);return;case 3:while(++r<i)(n=e[r]).callback.call(n.ctx,s,o,u);return;default:while(++r<i)(n=e[r]).callback.apply(n.ctx,t)}},h={listenTo:"on",listenToOnce:"once"};u.each(h,function(e,t){a[t]=function(t,n,r){var i=this._listeners||(this._listeners={}),s=t._listenerId||(t._listenerId=u.uniqueId("l"));return i[s]=t,typeof n=="object"&&(r=this),t[e](n,r,this),this}}),a.bind=a.on,a.unbind=a.off,u.extend(o,a);var p=o.Model=function(e,t){var n,r=e||{};t||(t={}),this.cid=u.uniqueId("c"),this.attributes={},u.extend(this,u.pick(t,d)),t.parse&&(r=this.parse(r,t)||{});if(n=u.result(this,"defaults"))r=u.defaults({},r,n);this.set(r,t),this.changed={},this.initialize.apply(this,arguments)},d=["url","urlRoot","collection"];u.extend(p.prototype,a,{changed:null,validationError:null,idAttribute:"id",initialize:function(){},toJSON:function(e){return u.clone(this.attributes)},sync:function(){return o.sync.apply(this,arguments)},get:function(e){return this.attributes[e]},escape:function(e){return u.escape(this.get(e))},has:function(e){return this.get(e)!=null},set:function(e,t,n){var r,i,s,o,a,f,l,c;if(e==null)return this;typeof e=="object"?(i=e,n=t):(i={})[e]=t,n||(n={});if(!this._validate(i,n))return!1;s=n.unset,a=n.silent,o=[],f=this._changing,this._changing=!0,f||(this._previousAttributes=u.clone(this.attributes),this.changed={}),c=this.attributes,l=this._previousAttributes,this.idAttribute in i&&(this.id=i[this.idAttribute]);for(r in i)t=i[r],u.isEqual(c[r],t)||o.push(r),u.isEqual(l[r],t)?delete this.changed[r]:this.changed[r]=t,s?delete c[r]:c[r]=t;if(!a){o.length&&(this._pending=!0);for(var h=0,p=o.length;h<p;h++)this.trigger("change:"+o[h],this,c[o[h]],n)}if(f)return this;if(!a)while(this._pending)this._pending=!1,this.trigger("change",this,n);return this._pending=!1,this._changing=!1,this},unset:function(e,t){return this.set(e,void 0,u.extend({},t,{unset:!0}))},clear:function(e){var t={};for(var n in this.attributes)t[n]=void 0;return this.set(t,u.extend({},e,{unset:!0}))},hasChanged:function(e){return e==null?!u.isEmpty(this.changed):u.has(this.changed,e)},changedAttributes:function(e){if(!e)return this.hasChanged()?u.clone(this.changed):!1;var t,n=!1,r=this._changing?this._previousAttributes:this.attributes;for(var i in e){if(u.isEqual(r[i],t=e[i]))continue;(n||(n={}))[i]=t}return n},previous:function(e){return e==null||!this._previousAttributes?null:this._previousAttributes[e]},previousAttributes:function(){return u.clone(this._previousAttributes)},fetch:function(e){e=e?u.clone(e):{},e.parse===void 0&&(e.parse=!0);var t=this,n=e.success;return e.success=function(r){if(!t.set(t.parse(r,e),e))return!1;n&&n(t,r,e),t.trigger("sync",t,r,e)},j(this,e),this.sync("read",this,e)},save:function(e,t,n){var r,i,s,o=this.attributes;e==null||typeof e=="object"?(r=e,n=t):(r={})[e]=t;if(r&&(!n||!n.wait)&&!this.set(r,n))return!1;n=u.extend({validate:!0},n);if(!this._validate(r,n))return!1;r&&n.wait&&(this.attributes=u.extend({},o,r)),n.parse===void 0&&(n.parse=!0);var a=this,f=n.success;return n.success=function(e){a.attributes=o;var t=a.parse(e,n);n.wait&&(t=u.extend(r||{},t));if(u.isObject(t)&&!a.set(t,n))return!1;f&&f(a,e,n),a.trigger("sync",a,e,n)},j(this,n),i=this.isNew()?"create":n.patch?"patch":"update",i==="patch"&&(n.attrs=r),s=this.sync(i,this,n),r&&n.wait&&(this.attributes=o),s},destroy:function(e){e=e?u.clone(e):{};var t=this,n=e.success,r=function(){t.trigger("destroy",t,t.collection,e)};e.success=function(i){(e.wait||t.isNew())&&r(),n&&n(t,i,e),t.isNew()||t.trigger("sync",t,i,e)};if(this.isNew())return e.success(),!1;j(this,e);var i=this.sync("delete",this,e);return e.wait||r(),i},url:function(){var e=u.result(this,"urlRoot")||u.result(this.collection,"url")||B();return this.isNew()?e:e+(e.charAt(e.length-1)==="/"?"":"/")+encodeURIComponent(this.id)},parse:function(e,t){return e},clone:function(){return new this.constructor(this.attributes)},isNew:function(){return this.id==null},isValid:function(e){return this._validate({},u.extend(e||{},{validate:!0}))},_validate:function(e,t){if(!t.validate||!this.validate)return!0;e=u.extend({},this.attributes,e);var n=this.validationError=this.validate(e,t)||null;return n?(this.trigger("invalid",this,n,u.extend(t||{},{validationError:n})),!1):!0}});var v=["keys","values","pairs","invert","pick","omit"];u.each(v,function(e){p.prototype[e]=function(){var t=i.call(arguments);return t.unshift(this.attributes),u[e].apply(u,t)}});var m=o.Collection=function(e,t){t||(t={}),t.url&&(this.url=t.url),t.model&&(this.model=t.model),t.comparator!==void 0&&(this.comparator=t.comparator),this._reset(),this.initialize.apply(this,arguments),e&&this.reset(e,u.extend({silent:!0},t))},g={add:!0,remove:!0,merge:!0},y={add:!0,merge:!1,remove:!1};u.extend(m.prototype,a,{model:p,initialize:function(){},toJSON:function(e){return this.map(function(t){return t.toJSON(e)})},sync:function(){return o.sync.apply(this,arguments)},add:function(e,t){return this.set(e,u.defaults(t||{},y))},remove:function(e,t){e=u.isArray(e)?e.slice():[e],t||(t={});var n,r,i,s;for(n=0,r=e.length;n<r;n++){s=this.get(e[n]);if(!s)continue;delete this._byId[s.id],delete this._byId[s.cid],i=this.indexOf(s),this.models.splice(i,1),this.length--,t.silent||(t.index=i,s.trigger("remove",s,this,t)),this._removeReference(s)}return this},set:function(e,t){t=u.defaults(t||{},g),t.parse&&(e=this.parse(e,t)),u.isArray(e)||(e=e?[e]:[]);var n,i,o,a,f,l,c=t.at,h=this.comparator&&c==null&&t.sort!==!1,p=u.isString(this.comparator)?this.comparator:null,d=[],v=[],m={};for(n=0,i=e.length;n<i;n++){if(!(o=this._prepareModel(e[n],t)))continue;(f=this.get(o))?(t.remove&&(m[f.cid]=!0),t.merge&&(f.set(o.attributes,t),h&&!l&&f.hasChanged(p)&&(l=!0))):t.add&&(d.push(o),o.on("all",this._onModelEvent,this),this._byId[o.cid]=o,o.id!=null&&(this._byId[o.id]=o))}if(t.remove){for(n=0,i=this.length;n<i;++n)m[(o=this.models[n]).cid]||v.push(o);v.length&&this.remove(v,t)}d.length&&(h&&(l=!0),this.length+=d.length,c!=null?s.apply(this.models,[c,0].concat(d)):r.apply(this.models,d)),l&&this.sort({silent:!0});if(t.silent)return this;for(n=0,i=d.length;n<i;n++)(o=d[n]).trigger("add",o,this,t);return l&&this.trigger("sort",this,t),this},reset:function(e,t){t||(t={});for(var n=0,r=this.models.length;n<r;n++)this._removeReference(this.models[n]);return t.previousModels=this.models,this._reset(),this.add(e,u.extend({silent:!0},t)),t.silent||this.trigger("reset",this,t),this},push:function(e,t){return e=this._prepareModel(e,t),this.add(e,u.extend({at:this.length},t)),e},pop:function(e){var t=this.at(this.length-1);return this.remove(t,e),t},unshift:function(e,t){return e=this._prepareModel(e,t),this.add(e,u.extend({at:0},t)),e},shift:function(e){var t=this.at(0);return this.remove(t,e),t},slice:function(e,t){return this.models.slice(e,t)},get:function(e){return e==null?void 0:this._byId[e.id!=null?e.id:e.cid||e]},at:function(e){return this.models[e]},where:function(e,t){return u.isEmpty(e)?t?void 0:[]:this[t?"find":"filter"](function(t){for(var n in e)if(e[n]!==t.get(n))return!1;return!0})},findWhere:function(e){return this.where(e,!0)},sort:function(e){if(!this.comparator)throw new Error("Cannot sort a set without a comparator");return e||(e={}),u.isString(this.comparator)||this.comparator.length===1?this.models=this.sortBy(this.comparator,this):this.models.sort(u.bind(this.comparator,this)),e.silent||this.trigger("sort",this,e),this},sortedIndex:function(e,t,n){t||(t=this.comparator);var r=u.isFunction(t)?t:function(e){return e.get(t)};return u.sortedIndex(this.models,e,r,n)},pluck:function(e){return u.invoke(this.models,"get",e)},fetch:function(e){e=e?u.clone(e):{},e.parse===void 0&&(e.parse=!0);var t=e.success,n=this;return e.success=function(r){var i=e.reset?"reset":"set";n[i](r,e),t&&t(n,r,e),n.trigger("sync",n,r,e)},j(this,e),this.sync("read",this,e)},create:function(e,t){t=t?u.clone(t):{};if(!(e=this._prepareModel(e,t)))return!1;t.wait||this.add(e,t);var n=this,r=t.success;return t.success=function(i){t.wait&&n.add(e,t),r&&r(e,i,t)},e.save(null,t),e},parse:function(e,t){return e},clone:function(){return new this.constructor(this.models)},_reset:function(){this.length=0,this.models=[],this._byId={}},_prepareModel:function(e,t){if(e instanceof p)return e.collection||(e.collection=this),e;t||(t={}),t.collection=this;var n=new this.model(e,t);return n._validate(e,t)?n:(this.trigger("invalid",this,e,t),!1)},_removeReference:function(e){this===e.collection&&delete e.collection,e.off("all",this._onModelEvent,this)},_onModelEvent:function(e,t,n,r){if((e==="add"||e==="remove")&&n!==this)return;e==="destroy"&&this.remove(t,r),t&&e==="change:"+t.idAttribute&&(delete this._byId[t.previous(t.idAttribute)],t.id!=null&&(this._byId[t.id]=t)),this.trigger.apply(this,arguments)}});var b=["forEach","each","map","collect","reduce","foldl","inject","reduceRight","foldr","find","detect","filter","select","reject","every","all","some","any","include","contains","invoke","max","min","toArray","size","first","head","take","initial","rest","tail","drop","last","without","indexOf","shuffle","lastIndexOf","isEmpty","chain"];u.each(b,function(e){m.prototype[e]=function(){var t=i.call(arguments);return t.unshift(this.models),u[e].apply(u,t)}});var w=["groupBy","countBy","sortBy"];u.each(w,function(e){m.prototype[e]=function(t,n){var r=u.isFunction(t)?t:function(e){return e.get(t)};return u[e](this.models,r,n)}});var E=o.View=function(e){this.cid=u.uniqueId("view"),this._configure(e||{}),this._ensureElement(),this.initialize.apply(this,arguments),this.delegateEvents()},S=/^(\S+)\s*(.*)$/,x=["model","collection","el","id","attributes","className","tagName","events"];u.extend(E.prototype,a,{tagName:"div",$:function(e){return this.$el.find(e)},initialize:function(){},render:function(){return this},remove:function(){return this.$el.remove(),this.stopListening(),this},setElement:function(e,t){return this.$el&&this.undelegateEvents(),this.$el=e instanceof o.$?e:o.$(e),this.el=this.$el[0],t!==!1&&this.delegateEvents(),this},delegateEvents:function(e){if(!e&&!(e=u.result(this,"events")))return this;this.undelegateEvents();for(var t in e){var n=e[t];u.isFunction(n)||(n=this[e[t]]);if(!n)continue;var r=t.match(S),i=r[1],s=r[2];n=u.bind(n,this),i+=".delegateEvents"+this.cid,s===""?this.$el.on(i,n):this.$el.on(i,s,n)}return this},undelegateEvents:function(){return this.$el.off(".delegateEvents"+this.cid),this},_configure:function(e){this.options&&(e=u.extend({},u.result(this,"options"),e)),u.extend(this,u.pick(e,x)),this.options=e},_ensureElement:function(){if(!this.el){var e=u.extend({},u.result(this,"attributes"));this.id&&(e.id=u.result(this,"id")),this.className&&(e["class"]=u.result(this,"className"));var t=o.$("<"+u.result(this,"tagName")+">").attr(e);this.setElement(t,!1)}else this.setElement(u.result(this,"el"),!1)}}),o.sync=function(e,t,n){var r=T[e];u.defaults(n||(n={}),{emulateHTTP:o.emulateHTTP,emulateJSON:o.emulateJSON});var i={type:r,dataType:"json"};n.url||(i.url=u.result(t,"url")||B()),n.data==null&&t&&(e==="create"||e==="update"||e==="patch")&&(i.contentType="application/json",i.data=JSON.stringify(n.attrs||t.toJSON(n))),n.emulateJSON&&(i.contentType="application/x-www-form-urlencoded",i.data=i.data?{model:i.data}:{});if(n.emulateHTTP&&(r==="PUT"||r==="DELETE"||r==="PATCH")){i.type="POST",n.emulateJSON&&(i.data._method=r);var s=n.beforeSend;n.beforeSend=function(e){e.setRequestHeader("X-HTTP-Method-Override",r);if(s)return s.apply(this,arguments)}}i.type!=="GET"&&!n.emulateJSON&&(i.processData=!1),i.type==="PATCH"&&window.ActiveXObject&&(!window.external||!window.external.msActiveXFilteringEnabled)&&(i.xhr=function(){return new ActiveXObject("Microsoft.XMLHTTP")});var a=n.xhr=o.ajax(u.extend(i,n));return t.trigger("request",t,a,n),a};var T={create:"POST",update:"PUT",patch:"PATCH","delete":"DELETE",read:"GET"};o.ajax=function(){return o.$.ajax.apply(o.$,arguments)};var N=o.Router=function(e){e||(e={}),e.routes&&(this.routes=e.routes),this._bindRoutes(),this.initialize.apply(this,arguments)},C=/\((.*?)\)/g,k=/(\(\?)?:\w+/g,L=/\*\w+/g,A=/[\-{}\[\]+?.,\\\^$|#\s]/g;u.extend(N.prototype,a,{initialize:function(){},route:function(e,t,n){u.isRegExp(e)||(e=this._routeToRegExp(e)),u.isFunction(t)&&(n=t,t=""),n||(n=this[t]);var r=this;return o.history.route(e,function(i){var s=r._extractParameters(e,i);n&&n.apply(r,s),r.trigger.apply(r,["route:"+t].concat(s)),r.trigger("route",t,s),o.history.trigger("route",r,t,s)}),this},navigate:function(e,t){return o.history.navigate(e,t),this},_bindRoutes:function(){if(!this.routes)return;this.routes=u.result(this,"routes");var e,t=u.keys(this.routes);while((e=t.pop())!=null)this.route(e,this.routes[e])},_routeToRegExp:function(e){return e=e.replace(A,"\\$&").replace(C,"(?:$1)?").replace(k,function(e,t){return t?e:"([^/]+)"}).replace(L,"(.*?)"),new RegExp("^"+e+"$")},_extractParameters:function(e,t){var n=e.exec(t).slice(1);return u.map(n,function(e){return e?decodeURIComponent(e):null})}});var O=o.History=function(){this.handlers=[],u.bindAll(this,"checkUrl"),typeof window!="undefined"&&(this.location=window.location,this.history=window.history)},M=/^[#\/]|\s+$/g,_=/^\/+|\/+$/g,D=/msie [\w.]+/,P=/\/$/;O.started=!1,u.extend(O.prototype,a,{interval:50,getHash:function(e){var t=(e||this).location.href.match(/#(.*)$/);return t?t[1]:""},getFragment:function(e,t){if(e==null)if(this._hasPushState||!this._wantsHashChange||t){e=this.location.pathname;var n=this.root.replace(P,"");e.indexOf(n)||(e=e.substr(n.length))}else e=this.getHash();return e.replace(M,"")},start:function(e){if(O.started)throw new Error("Backbone.history has already been started");O.started=!0,this.options=u.extend({},{root:"/"},this.options,e),this.root=this.options.root,this._wantsHashChange=this.options.hashChange!==!1,this._wantsPushState=!!this.options.pushState,this._hasPushState=!!(this.options.pushState&&this.history&&this.history.pushState);var t=this.getFragment(),n=document.documentMode,r=D.exec(navigator.userAgent.toLowerCase())&&(!n||n<=7);this.root=("/"+this.root+"/").replace(_,"/"),r&&this._wantsHashChange&&(this.iframe=o.$('<iframe src="javascript:0" tabindex="-1" />').hide().appendTo("body")[0].contentWindow,this.navigate(t)),this._hasPushState?o.$(window).on("popstate",this.checkUrl):this._wantsHashChange&&"onhashchange"in window&&!r?o.$(window).on("hashchange",this.checkUrl):this._wantsHashChange&&(this._checkUrlInterval=setInterval(this.checkUrl,this.interval)),this.fragment=t;var i=this.location,s=i.pathname.replace(/[^\/]$/,"$&/")===this.root;if(this._wantsHashChange&&this._wantsPushState&&!this._hasPushState&&!s)return this.fragment=this.getFragment(null,!0),this.location.replace(this.root+this.location.search+"#"+this.fragment),!0;this._wantsPushState&&this._hasPushState&&s&&i.hash&&(this.fragment=this.getHash().replace(M,""),this.history.replaceState({},document.title,this.root+this.fragment+i.search));if(!this.options.silent)return this.loadUrl()},stop:function(){o.$(window).off("popstate",this.checkUrl).off("hashchange",this.checkUrl),clearInterval(this._checkUrlInterval),O.started=!1},route:function(e,t){this.handlers.unshift({route:e,callback:t})},checkUrl:function(e){var t=this.getFragment();t===this.fragment&&this.iframe&&(t=this.getFragment(this.getHash(this.iframe)));if(t===this.fragment)return!1;this.iframe&&this.navigate(t),this.loadUrl()||this.loadUrl(this.getHash())},loadUrl:function(e){var t=this.fragment=this.getFragment(e),n=u.any(this.handlers,function(e){if(e.route.test(t))return e.callback(t),!0});return n},navigate:function(e,t){if(!O.started)return!1;if(!t||t===!0)t={trigger:t};e=this.getFragment(e||"");if(this.fragment===e)return;this.fragment=e;var n=this.root+e;if(this._hasPushState)this.history[t.replace?"replaceState":"pushState"]({},document.title,n);else{if(!this._wantsHashChange)return this.location.assign(n);this._updateHash(this.location,e,t.replace),this.iframe&&e!==this.getFragment(this.getHash(this.iframe))&&(t.replace||this.iframe.document.open().close(),this._updateHash(this.iframe.location,e,t.replace))}t.trigger&&this.loadUrl(e)},_updateHash:function(e,t,n){if(n){var r=e.href.replace(/(javascript:|#).*$/,"");e.replace(r+"#"+t)}else e.hash="#"+t}}),o.history=new O;var H=function(e,t){var n=this,r;e&&u.has(e,"constructor")?r=e.constructor:r=function(){return n.apply(this,arguments)},u.extend(r,n,t);var i=function(){this.constructor=r};return i.prototype=n.prototype,r.prototype=new i,e&&u.extend(r.prototype,e),r.__super__=n.prototype,r};p.extend=m.extend=N.extend=E.extend=O.extend=H;var B=function(){throw new Error('A "url" property or function must be specified')},j=function(e,t){var n=t.error;t.error=function(r){n&&n(e,r,t),e.trigger("error",e,r,t)}}}.call(this),define("backbone",["underscore"],function(e){return function(){var t,n;return t||e.Backbone}}(this)),define("lib/uuid",[],function(){"use strict";function e(e,t){for(t=e="";e++<36;t+=e*51&52?(e^15?8^Math.random()*(e^20?16:4):4).toString(16):"-");return t}return{uuid:e}}),define("Http/Config",[],function(){"use strict";var e=3e4,t=12e4,n=12e4,r=5e3;return{authenticationTimeout:e,requestTimeout:t,attachmentTimeout:n,disconnectTimeout:r}}),define("zepto",["underscore"],function(_){"use strict";var Zepto={};return function($){function ajaxSuccess(e,t,n){var r=n.context,i="success";n.success.call(r,e,i,t),ajaxComplete(i,t,n)}function ajaxError(e,t,n,r){var i=r.context;r.error.call(i,n,t,e),ajaxComplete(t,n,r)}function ajaxComplete(e,t,n){var r=n.context;n.complete.call(r,t,e)}function empty(){}function mimeToDataType(e){return e&&(e==htmlType?"html":e==jsonType?"json":scriptTypeRE.test(e)?"script":xmlTypeRE.test(e)&&"xml")||"text"}function appendQuery(e,t){return(e+"&"+t).replace(/[&?]{1,2}/,"?")}function serializeData(e){e.processData&&isObject(e.data)&&(e.data=$.param(e.data,e.traditional)),e.data&&(!e.type||e.type.toUpperCase()=="GET")&&(e.url=appendQuery(e.url,e.data))}function serialize(e,t,n,r){var i=_.isArray(t);_.each(t,function(t,s){r&&(s=n?r:r+"["+(i?"":s)+"]"),!r&&i?e.add(t.name,t.value):(n?_.isArray(t):isObject(t))?serialize(e,t,n,s):e.add(s,t)})}var jsonpID=0,isObject=_.isObject,document=window.document,key,name,rscript=/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,scriptTypeRE=/^(?:text|application)\/javascript/i,xmlTypeRE=/^(?:text|application)\/xml/i,jsonType="application/json",htmlType="text/html",blankRE=/^\s*$/;$.ajaxSettings={type:"GET",success:empty,error:empty,complete:empty,context:null,xhr:function(){return new window.XMLHttpRequest},accepts:{script:"text/javascript, application/javascript",json:jsonType,xml:"application/xml, text/xml",html:htmlType,text:"text/plain"},crossDomain:!1,timeout:0,processData:!0},$.ajax=function(options){var settings=_.extend({},options||{});for(key in $.ajaxSettings)settings[key]===undefined&&(settings[key]=$.ajaxSettings[key]);settings.crossDomain||(settings.crossDomain=/^([\w-]+:)?\/\/([^\/]+)/.test(settings.url)&&RegExp.$2!=window.location.host);var dataType=settings.dataType,hasPlaceholder=/=\?/.test(settings.url);settings.url||(settings.url=window.location.toString()),serializeData(settings);var mime=settings.accepts[dataType],baseHeaders={},protocol=/^([\w-]+:)\/\//.test(settings.url)?RegExp.$1:window.location.protocol,xhr=settings.xhr(),abortTimeout;settings.crossDomain||(baseHeaders["X-Requested-With"]="XMLHttpRequest"),mime&&(baseHeaders.Accept=mime,mime.indexOf(",")>-1&&(mime=mime.split(",",2)[0]),xhr.overrideMimeType&&xhr.overrideMimeType(mime));if(settings.contentType||settings.contentType!==!1&&settings.data&&settings.type.toUpperCase()!="GET")baseHeaders["Content-Type"]=settings.contentType||"application/x-www-form-urlencoded";settings.headers=_.extend(baseHeaders,settings.headers||{}),xhr.onreadystatechange=function(){if(xhr.readyState==4){clearTimeout(abortTimeout);var result,error=!1;if(xhr.status>=200&&xhr.status<300||xhr.status==304||xhr.status==0&&protocol=="file:"){dataType=dataType||mimeToDataType(xhr.getResponseHeader("content-type")),result=xhr.response;try{dataType=="script"?(1,eval)(result):dataType=="xml"?result=xhr.responseXML:dataType=="json"&&(result=blankRE.test(result)?null:JSON.parse(result))}catch(e){error=e}error?ajaxError(error,"parsererror",xhr,settings):ajaxSuccess(result,xhr,settings)}else ajaxError(null,"error",xhr,settings)}};var async="async"in settings?settings.async:!0;xhr.open(settings.type,settings.url,async),settings.responseType&&(xhr.responseType=settings.responseType);for(name in settings.headers)xhr.setRequestHeader(name,settings.headers[name]);return settings.timeout>0&&(abortTimeout=setTimeout(function(){xhr.onreadystatechange=empty,xhr.abort(),ajaxError(null,"timeout",xhr,settings)},settings.timeout)),xhr.send(settings.data?settings.data:null),xhr},$.get=function(e,t){return $.ajax({url:e,success:t})},$.post=function(e,t,n,r){return _.isFunction(t)&&(r=r||n,n=t,t=null),$.ajax({type:"POST",url:e,data:t,success:n,dataType:r})},$.getJSON=function(e,t){return $.ajax({url:e,success:t,dataType:"json"})};var escape=encodeURIComponent;$.param=function(e,t){var n=[];return n.add=function(e,t){this.push(escape(e)+"="+escape(t))},serialize(n,e,t),n.join("&").replace(/%20/g,"+")}}(Zepto),Zepto}),define("Http/ajax",["zepto","underscore","AH","Constants"],function(e,t,n,r){"use strict";return{ajax:function(i){var s=n.defer();return t.extend(i,{success:function(e,t,n){s.resolve({data:e,status:t,xhr:n})},error:function(e,t,n){var i=new Error(n||e.statusText||t);switch(t){case"timeout":i.message="Request timed out",i.mdoCode=r.errorCodes.ajaxRequestTimeout;break;case"abort":i.message="Request was aborted",i.mdoCode=r.errorCodes.ajaxRequestAbort;break;case"parsererror":i.message="Cannot parse response",i.mdoCode=r.errorCodes.ajaxRequestParseError;break;case"error":i.message=(e.statusText||"Cannot access server")+" (Status: "+e.status+")",i.httpStatus=e.status,i.mdoCode=r.errorCodes.ajaxRequestError;break;default:}return s.reject(i)}}),e.ajax(i),s.promise},postJson:function(e){return t.extend(e,{type:"POST",contentType:"application/json; charset=utf-8",dataType:"json"}),this.ajax(e).then(function(e){return e.data})}}}),define("Messages/Message",["underscore","Constants","AH"],function(e,t,n){"use strict";function s(e,t){var r=arguments;Object.defineProperty(this,"messageCode",{get:function(){return t}}),Object.defineProperty(this,"message",{get:function(){var t=[e].concat(this.args);return n.format.apply(undefined,t)}}),Object.defineProperty(this,"args",{get:function(){return Array.prototype.slice.call(r,2)}})}function o(e,t){var n=Function.prototype.bind||function(e){function r(){}function i(){return n.apply(this instanceof r&&!e?this:e,t.concat(Array.prototype.slice.call(arguments)))}if(typeof this!="function")throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable");var t=Array.prototype.slice.call(arguments,1),n=this;return r.prototype=this.prototype,i.prototype=new r,i};return n.apply(e,Array.prototype.slice.call(arguments,1))}var r={},i={};return r[t.messageCodes.applyingServerChanges]="Applying server change {0} of {1}",r[t.messageCodes.preparingUpload]="Preparing upload",r[t.messageCodes.extractingFile]="Extracting file {0} of {1}",r[t.messageCodes.resettingDatabase]="Resetting database",r[t.messageCodes.deployingDatabase]="Deploying database",r[t.messageCodes.uploadingFile]="Uploading file {0} of {1}",r[t.messageCodes.downloadingFile]="Downloading file {0} of {1}",r[t.messageCodes.downloadingSegment]="Downloading segment {0} of {1}",r[t.messageCodes.checkingForAttachmentUploads]="Checking for attachments to upload",r[t.messageCodes.checkingForAttachmentDownloads]="Checking for attachments to download",r[t.messageCodes.downloadingVaultFile]="Downloading {0} of {1}: '{2}'",r[t.messageCodes.downloadingVaultFiles]="Downloading {0} attachment(s)",r[t.messageCodes.uploadingVaultFile]="Uploading {0} of {1}: '{2}'",r[t.messageCodes.uploadingVaultFiles]="Uploading {0} attachment(s)",r[t.messageCodes.authenticating]="Authenticating",r[t.messageCodes.disconnecting]="Disconnecting",r[t.messageCodes.requestingFiles]="Requesting Files",r[t.messageCodes.registeringDevice]="Registering device",s.prototype.toString=function(){return this.message},s.overrideMessages=function(t){i={},e.extend(i,t)},s.getMessage=function(e){var t=Array.prototype.slice.call(arguments,1);t.splice(0,0,s,undefined,i[e]||r[e]||"["+e+"]",e);var n=o.apply(undefined,t);return new n},s}),define("Http/Server",["./ajax","./Config","underscore","AH","Messages/Message","Constants"],function(e,t,n,r,i,s){"use strict";return function(o,u){function l(e){if(!a){var t=new Error("A call to 'authenticate' is required before the request can be made");throw t.mdoCode=s.errorCodes.authTokenRequired,t}return e=e||{},n.extend(e,a),f&&(e.fileAck=f),e}function c(t,i,s){function a(e){if(!e.error)return f=null,e;var t=new Error(e.error);return e.errorCode&&(t.mdoCode=e.errorCode),n.extend(t,e,{error:undefined,errorCode:undefined}),r.reject(t)}o&&(t=o+t);var u=n.extend({data:i,url:t,headers:{"Cache-Control":"no-cache"}},s);return e.postJson(u).then(a)}function h(e,n){return r.deferredTryCatch(function(){var o;e.deviceSharing?o=e.domainId&&e.userId&&e.user:o=e.domainId&&e.userId||e.domain&&e.user;if(!o)throw new Error("Invalid credentials format");var u=c("Authenticate",JSON.stringify(e),{timeout:n||t.authenticationTimeout});return u.then(function(e){a=e}),r.notify(i.getMessage(s.messageCodes.authenticating),u)})}function p(e,n){function i(){return r.resolve(l(e.queryOptions))}function s(i){if(!e.dataStoreId||!e.className)throw new Error("Invalid request format");return c(r.format("Data/{0}/{1}",e.dataStoreId,e.className),JSON.stringify(i||{}),{timeout:n||t.requestTimeout})}return r.deferredTryCatch(i).then(s)}function d(e){return r.deferredTryCatch(function(){var n=l(),o=a,u=c("Disconnect",JSON.stringify(n),{timeout:e||t.disconnectTimeout});return u.then(function(){a===o&&(a=null)}),r.notify(i.getMessage(s.messageCodes.disconnecting),u)})}function v(e){return r.deferredTryCatch(function(){var n=l(),o=c("Manifest",JSON.stringify(n),{timeout:e||t.requestTimeout});return r.notify(i.getMessage(s.messageCodes.requestingFiles),o)})}function m(e,i,s){return r.deferredTryCatch(function(){if(!e)throw new Error("file is required for file download requests");var r=l(n.extend({file:e},i));return c("Download",JSON.stringify(r),{timeout:s||t.requestTimeout})})}function g(e,i){return r.deferredTryCatch(function(){if(!e)throw new Error("segmentInfo is required for segment download requests");var r="mailboxId segmentFileName segmentFileType segmentIndex".split(" ");e=n.pick(e,r),n.forEach(r,function(t){if(n.isUndefined(e[t]))throw new Error(t+" is required for segment download requests")});var s=l(e);return c("DownloadSegment",JSON.stringify(s),{timeout:i||t.requestTimeout})})}function y(e,n){return r.deferredTryCatch(function(){var r=l(e);return c("Upload",JSON.stringify(r),{timeout:n||t.requestTimeout})})}function b(e,n,i){if(!e||!n){var o=new Error("Missing required parameters.");return o.mdoCode=s.errorCodes.invalidArgs,r.reject(o)}return a&&(n=l(n)),c("Execute/"+e,JSON.stringify(n),{timeout:i||t.requestTimeout})}function S(e,t){e=e?n.partial(e,this):e,E=E||r.deferredTryCatch(function(){return h(u(),t)});var i=E.then(function(t){return x(e,t)});return i.then(function(e){return C(!1,e)},function(e){return C(!0,e)})}function x(e,t){var i;return e&&(i=e(t),!i||!n.isObject(i)||!n.isFunction(i.then)?i=r.reject(new Error("Session callback did not return a promise.")):i=T(i)),i}function T(e){return w.push(e),e.then(function(t){return N(e),r.resolve(t)},function(t){return N(e),r.reject(t)})}function N(e){w.splice(w.indexOf(e),1)}function C(e,t,n){return w.length?k(e,t):(E=null,d(n).always(function(){return k(e,t)}))}function k(e,t){return e?r.reject(t):r.resolve(t)}function L(e){var t=Array.prototype.slice.call(arguments,1),n=s.errorCodes;return e.apply(this,t).then(undefined,function(i){return i.mdoCode===n.authTokenRequired||i.mdoCode===n.invalidSessionId?h(u()).then(function(){return e.apply(this,t)}):r.reject(i)}).then(function(e){return C(!1,e)},function(e){return C(!0,e)})}var a,f=null,w=[],E;return{query:n.partial(L,p),getFileList:n.partial(L,v),getFile:n.partial(L,m),getSegment:n.partial(L,g),putFile:n.partial(L,y),execute:b,session:S,set fileToAcknowledge(e){if(f)throw new Error("Cannot overwrite file acknowledgement (fileToAcknowledge).");f=e},get fileToAcknowledge(){return f}}}}),define("lib/Class",["underscore","backbone"],function(e,t){"use strict";var n=function(){this.initialize.apply(this,arguments)};return e.extend(n.prototype,{initialize:function(){}}),n.extend=t.Model.extend,n}),define("LocalStorage/Storage",["underscore","lib/Class"],function(e,t){"use strict";return t.extend({initialize:function(t,n,r,i){function o(e){return function(t){return a(e,t)}}function u(e){return function(t){return f(e,t)}}function a(t,n){return n!==undefined&&(s[t]=n===null?undefined:n,h()),e.isUndefined(s[t])?l(t):s[t]}function f(e,n){var r=t+"."+e;return n!==undefined&&(n===null?localStorage.removeItem(r):localStorage.setItem(r,JSON.stringify(n))),r in localStorage?JSON.parse(localStorage.getItem(r)):l(e)}function l(t){return e.isUndefined(i[t])?null:i[t]}function c(){s=t in localStorage?JSON.parse(localStorage.getItem(t)):{}}function h(){localStorage.setItem(t,JSON.stringify(s))}var s={};i=i||{},this.settings={},this.key=t,this.quickProperties=r,c(),n&&e.each(n,function(e){this[e]=o(e)},this),r&&e.each(r,function(e){this[e]=u(e)},this)},remove:function(){var t=this.key;localStorage.removeItem(t),this.quickProperties&&e.each(this.quickProperties,function(e){localStorage.removeItem(t+"."+e)},this),this.settings={}}})}),define("LocalStorage/Datastore",["./Storage","AH"],function(e,t){"use strict";function r(e){return"@datastore_"+e}function i(e){return"/Datastores/"+e+"/"}function s(e){return i(e)+"Incoming/"}var n={},o=e.extend({initialize:function(t){e.prototype.initialize.call(this,r(t),["id","name","modelId","modelVersion","inSeriesId","outSeriesId"],["inSeqNum","outSeqNum","nextTempId"])},remove:function(){var t=this.id();delete n[t],e.prototype.remove.call(this)},generateNextTempId:function(){return this.nextTempId(this.nextTempId()-1)},directory:function(){return i(this.id())},modelPath:function(){return this.directory()+this.id()+".mdm"},incomingDir:function(){return s(this.id())},dbName:function(){return this.id()}});return o.create=function(e){var t=new o(e);return t.id(e),n[e]=t,t},o.retrieve=function(e){var t=n[e];if(!t){t=new o(e);if(!t.id())return undefined;n[e]=t}return t},o.getIncomingDir=s,o.getDirectory=i,o.reset=function(){n={}},o}),define("lib/utf8",[],function(){function e(e){var t=e.replace(/[\u0080-\u07ff]/g,function(e){var t=e.charCodeAt(0);return String.fromCharCode(192|t>>6,128|t&63)});return t=t.replace(/[\u0800-\uffff]/g,function(e){var t=e.charCodeAt(0);return String.fromCharCode(224|t>>12,128|t>>6&63,128|t&63)}),t}function t(e){var t=e.replace(/[\u00e0-\u00ef][\u0080-\u00bf][\u0080-\u00bf]/g,function(e){var t=(e.charCodeAt(0)&15)<<12|(e.charCodeAt(1)&63)<<6|e.charCodeAt(2)&63;return String.fromCharCode(t)});return t=t.replace(/[\u00c0-\u00df][\u0080-\u00bf]/g,function(e){var t=(e.charCodeAt(0)&31)<<6|e.charCodeAt(1)&63;return String.fromCharCode(t)}),t}return{encode:e,decode:t}}),define("lib/encryption",["./utf8"],function(e){function o(t,n){n=typeof n=="undefined"?!0:n,n&&(t=e.encode(t));var r=[1518500249,1859775393,2400959708,3395469782];t+=String.fromCharCode(128);var i=t.length/4+2,s=Math.ceil(i/16),o=new Array(s);for(var l=0;l<s;l++){o[l]=new Array(16);for(var c=0;c<16;c++)o[l][c]=t.charCodeAt(l*64+c*4)<<24|t.charCodeAt(l*64+c*4+1)<<16|t.charCodeAt(l*64+c*4+2)<<8|t.charCodeAt(l*64+c*4+3)}o[s-1][14]=(t.length-1)*8/Math.pow(2,32),o[s-1][14]=Math.floor(o[s-1][14]),o[s-1][15]=(t.length-1)*8&4294967295;var h=1732584193,p=4023233417,d=2562383102,v=271733878,m=3285377520,g=new Array(80),y,b,w,E,S;for(var l=0;l<s;l++){for(var x=0;x<16;x++)g[x]=o[l][x];for(var x=16;x<80;x++)g[x]=a(g[x-3]^g[x-8]^g[x-14]^g[x-16],1);y=h,b=p,w=d,E=v,S=m;for(var x=0;x<80;x++){var T=Math.floor(x/20),N=a(y,5)+u(T,b,w,E)+S+r[T]+g[x]&4294967295;S=E,E=w,w=a(b,30),b=y,y=N}h=h+y&4294967295,p=p+b&4294967295,d=d+w&4294967295,v=v+E&4294967295,m=m+S&4294967295}return f(h)+f(p)+f(d)+f(v)+f(m)}function u(e,t,n,r){switch(e){case 0:return t&n^~t&r;case 1:return t^n^r;case 2:return t&n^t&r^n&r;case 3:return t^n^r}}function a(e,t){return e<<t|e>>>32-t}function f(e){var t="",n;for(var r=7;r>=0;r--)n=e>>>r*4&15,t+=n.toString(16);return t.toUpperCase()}var t=1732584193,n=4023233417,r=2562383102,i=271733878,s=3285377520;return{sha1:o}}),define("LocalStorage/Domain",["underscore","./Datastore","./Storage","lib/encryption","AH"],function(e,t,n,r,i){"use strict";function u(e,t){return r.sha1(e+"\0"+t,!1)}var s,o=n.extend({initialize:function(){n.prototype.initialize.call(this,"@domain",["name","id","user","userId","device","passwordHash","dataStoreIds","serverUrl"])},saveCredentials:function(e,t){this.user(e),this.passwordHash(u(e,t))},clearCredentials:function(){this.user(null),this.passwordHash(null)},testCredentials:function(e,t){return this.user()===e&&this.passwordHash()===u(e,t)},remove:function(){s=undefined,e.each(this.dataStoreIds()||[],function(e){var n=t.retrieve(e);n&&n.remove()}),n.prototype.remove.call(this)},addDatastore:function(n){var r=this.dataStoreIds()||[];if(e.indexOf(r,n)>=0)throw new Error("Duplicate datastoreId "+n);var i=t.create(n);return r.push(n),this.dataStoreIds(r),i},getDatastoreById:function(e){return t.retrieve(e)},removeDatastore:function(n){var r=this.dataStoreIds()||[],i=e.indexOf(r,n);if(i<0)throw new Error("Invalid datastoreId "+n);r.splice(i,1),this.dataStoreIds(r);var s=t.retrieve(n);s&&s.remove()},getNumDatastores:function(){return(this.dataStoreIds()||[]).length},getDatastore:function(e){var t=this.dataStoreIds()[e];return this.getDatastoreById(t)},incomingDir:function(){return"/Incoming/"},outgoingDir:function(){return"/Outgoing/"},dsDeploymentsDir:function(){return"/DataStores/Install/"},getDSDeploymentModelDir:function(e,t){return this.dsDeploymentsDir()+e+"."+t+"/"},getDSDeploymentModelPath:function(e){return this.getDSDeploymentModelDir(e.dataStoreId,e.modelVersion)+e.modelId+".mdm"}});return o.create=function(){return s=new o,s},o.retrieve=function(){var e=s;if(!e){e=new o;if(!e.name())return undefined;s=e}return e},o}),define("MDO/AsyncEvents",["AH","underscore","backbone"],function(e,t,n){"use strict";function r(n,r,i){return t.reduce(r,function(t,n){return e.when(t,function(){return n.callback.apply(n.ctx,i)})},n)}return t.extend({asyncTrigger:function(t){var n=e.resolve(self),i=n;if(this._events){var s=Array.prototype.slice.call(arguments,1),o=this._events[t];o&&(n=r(n,o,s));var u=this._events.all;u&&(n=r(n,u,arguments)),n!==i&&(i=n.then(function(){return self}))}return i}},n.Events)}),define("Files/fs",["AH","Constants","underscore"],function(e,t,n){"use strict";return function(){function o(){if(s)return s;i=e.websql(r,"","@hand File System");var t=i.promise.then(N);return s=t,s.then(null,u),t}function u(){s=undefined,i=undefined}function a(){return o().then(function(){return i.destroyDatabase()}).then(u,u)}function f(e,t){var n=S(e,t),r="SELECT dir || name as path, * FROM files WHERE dir = ? AND name = ?";return o().then(function(){return i.readRow(r,[n.dir,n.name]).then(function(e){return e?e:T("readFile",n.path)})})}function l(e,t){function r(e){return n.defaults({content:JSON.parse(e.content)},e)}return f(e,t).then(r)}function c(e,t){return l(e,t).then(function(e){return e.content})}function h(t,n,r,s){function a(){var t=e.format("{0} INTO files (dir, name, content, size) VALUES (?, ?, ?, ?)",s?"INSERT OR REPLACE":"INSERT");return o().then(function(){return i.execute(t,[u.dir,u.name,r,r.length]).then(null,m("writeFile",u.path))})}var u;return r===undefined||typeof r=="boolean"?(u=S(t),s=r,r=n):u=S(t,n),u.validate("writeFile").then(a)}function p(t,n,r,i){return e.deferredTryCatch(function(){if(r===undefined||typeof r=="boolean")i=r,r=n,n="";return h(t,n,JSON.stringify(r),i)})}function d(e,t,n){function u(){var e=n?"INSERT OR REPLACE":"INSERT";return e+=" INTO files (dir, name, content, size, created, updated) SELECT ?, ?, content, size, created, updated FROM files WHERE dir = ? AND name = ?",o().then(function(){return i.execute(e,[s.dir,s.name,r.dir,r.name]).then(null,m("copyFile",s.path))})}var r=S(e),s=S(t);return r.validate("copyFile - srcPath").then(function(){return s.validate("copyFile - fdDst")}).then(u)}function v(e,t){function s(){var e="UPDATE files SET dir=?, name=? WHERE dir=? AND name=?";return o().then(function(){return i.execute(e,[r.dir,r.name,n.dir,n.name]).then(function(e){return e.rowsAffected!==1?T("moveFile",n.path):e},m("moveFile",r.path))})}var n=S(e),r=S(t);return n.validate("moveFile - srcPath").then(function(){return r.validate("moveFile - fdDst")}).then(s)}function m(n,r){return function(s){switch(s.sqlError.code){case t.sqlError.DATABASE_ERR:case t.sqlError.CONSTRAINT_ERR:r?s.message=n+": duplicate file '"+r+"'":s.message=n+" operation failed";break;case t.sqlError.QUOTA_ERR:s.message="Database quota has been exceeded";break;case t.sqlError.UNKNOWN_ERR:case t.sqlError.VERSION_ERR:case t.sqlError.TOO_LARGE_ERR:case t.sqlError.SYNTAX_ERR:case t.sqlError.TIMEOUT_ERR:break;default:}return e.reject(s)}}function g(e,t,n){n===undefined&&typeof t!="string"&&(n=t,t=undefined);var r=S(e,t),s="DELETE FROM files WHERE dir = ? AND name = ?";return o().then(function(){return i.execute(s,[r.dir,r.name]).then(function(e){return e.rowsAffected!==1&&n?T("deleteFile",r.path):e})})}function y(e,t){var n="DELETE FROM files WHERE dir LIKE ?";return o().then(function(){return i.execute(n,[e+"%"]).then(function(n){return n.rowsAffected<1&&t?T("deleteDirectory",e):n})})}function b(t,r,s){if(!n.isString(t))return e.reject("'dir' is required");if(!n.isString(r))return e.reject("'pattern' is required");var u=[],a=[];E(t,r,a,u,s);var f="DELETE FROM files WHERE "+a.join(" AND ");return o().then(function(){return i.execute(f,u)})}function w(e,t,n){var r=[],s=[];E(e,t,s,r);var u="SELECT dir || name as path, dir, name, size, created, updated FROM files";return s.length&&(u+=" WHERE "+s.join(" AND ")),o().then(function(){return i.read(u,r).then(function(e){var t=[];for(var r=0;r<e.rows.length;r++)t.push(e.rows.item(r));return n?t.sort(n):t})})}function E(e,t,n,r,i){e&&(n.push("dir = ?"),r.push(e)),t&&(t=t.replace(/\*/g,"%"),i?n.push("name NOT LIKE ?"):n.push("name LIKE ?"),r.push(t))}function S(e,t){if(!t){var n=e.lastIndexOf("/")+1;t=e.substr(n),e=e.substr(0,n)}return{dir:e,name:t,path:e+t,validate:x}}function x(t){t=t||"file operation";var n=this.name;if(!n||n.indexOf("/")>=0||n.indexOf(" ")===0||n.lastIndexOf(" ")===n.length-1)return e.reject(new Error(t+": invalid file name '"+n+"'"));var r=this.dir;return!r||r.indexOf("/")!==0||r.lastIndexOf("/")!==r.length-1?e.reject(new Error(t+": invalid directory '"+r+"'")):e.resolve(this)}function T(t,n){var r=new Error(t+": path not found '"+n+"'");return e.reject(r)}function N(){var e="CREATE TABLE IF NOT EXISTS files (dir NOT NULL, name NOT NULL, content, size INTEGER, created DEFAULT CURRENT_TIMESTAMP, updated DEFAULT CURRENT_TIMESTAMP, UNIQUE( dir, name)CHECK( dir LIKE '/%' AND dir LIKE '%/' AND length(name) > 0 ))";return i.execute(e)}function C(e,t){return k(e)-k(t)}function k(e){typeof e!="string"&&(e=e&&(e.name||e.path)||"");var t=/\.(\d+)\.[^\.]+$/,n=e.match(t);if(!n||!n.length)throw new Error("Path does not contain a sequence number: '"+e+"'");return Number(n[1])}var r="@fsdb",i,s;return{format:a,readFile:f,writeFile:h,copyFile:d,moveFile:v,deleteFile:g,deleteDirectory:y,deleteFiles:b,listFiles:w,readJsonFile:l,readJsonFileContent:c,writeJsonFile:p,getPathSeqNum:k,pathSeqNumCompare:C}}()}),define("Logging/settings",["underscore","LocalStorage/Storage"],function(e,t){"use strict";var n={echoToConsole:!1,daysToKeepLogs:7,hoursBetweenOldLogClears:24},r=t.extend({initialize:function(){t.prototype.initialize.call(this,"@loggerSettings",e.keys(n),undefined,n)}});return new r}),define("Logging/logger",["AH","underscore","./settings"],function(e,t,n){"use strict";function r(){this._logsDb=e.websql("@logs","","@hand Logs"),this._clearLogsInterval=null,this.initialize.apply(this,arguments)}return t.extend(r.prototype,{settings:n,initialize:function(){return this._initPromise=this._logsDb.promise.then(t.bind(this._initializeSchema,this)),this.setClearLogsInterval(n.hoursBetweenOldLogClears()*36e5),this.clearOldLogs(),this._initPromise},_initializeSchema:function(){var e="CREATE TABLE IF NOT EXISTS logs (domainId, appId, category COLLATE NOCASE, message TEXT NOT NULL, timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP)";return this._logsDb.execute(e)},log:function(r,i){function o(){n.echoToConsole()&&console.log(s._formatMessage(r,i))}function u(){function a(t,r){e.push(t),n.push(r),o.push("?")}i=t.pick(i,"domainId","appId","category");var e=[],n=[],o=[];t.each(t.keys(i),function(e){var t=i[e];if(t===undefined||t===null)return;a(e,t)}),a("message",r);var u="INSERT INTO logs ("+e.join(", ")+") VALUES ("+o.join(", ")+")";return s._logsDb.execute(u,n)}var s=this;return i=i||{},r?this._initPromise.then(o).then(u):e.reject("'message' is required")},_formatMessage:function(e,t){t=t||{};var n;return t.domainId&&t.appId?n="(domain:"+t.domainId+" app:"+t.appId+")":t.domainId?n="(domain:"+t.domainId+")":t.appId&&(n="(app:"+t.appId+")"),t.category&&(n?n+=" "+t.category:n=t.category),n?n+=": "+e:n=e,n},logError:function(n,r){return n?this.log(this._formatError(n),t.extend({category:"ERROR"},r)):e.reject("'error' parameter is required")},_formatError:function(e){var t=String(e.message||e);e.code&&(t+=" (Code: "+e.code+")"),e.mdoCode&&(t+=" (MDOCode: "+e.mdoCode+")");if(e.sqlError){t+=" [WebSQL: "+(e.sqlError.message||e.sqlError)+" (SQLError: "+(e.sqlError.code||"??");var n=e.sql||e.sqlError.sql;n&&(t+=', SQL: "'+n+'"'),t+=")]"}return e.exception&&(t+=" [Cause: "+(e.exception.message||e.exception)+"]"),t},readLogs:function(n){function o(){return r._logsDb.read(i,s.args)}function u(n){var r=[];for(var i=0;i<n.rows.length;i++){var s=e.dateFromDb(n.rows.item(i).timestamp),o=t.defaults({timestamp:e.getUtcAsLocalTime(s)},n.rows.item(i));r.push(o)}return r}var r=this,i="SELECT * FROM logs",s=this._buildSqlFilter(n);return s.conditions.length&&(i+=" WHERE "+s.conditions.join(" AND ")),this._initPromise.then(o).then(u)},setClearLogsInterval:function(e){return this._clearLogsInterval&&(clearInterval(this._clearLogsInterval),this._clearLogsInterval=null),e>0&&(this._clearLogsInterval=setInterval(t.bind(this.clearOldLogs,this),e)),this._clearLogsInterval},clearLogs:function(e){var t=this,n="DELETE FROM logs",r=this._buildSqlFilter(e);return r.conditions.length&&(n+=" WHERE "+r.conditions.join(" AND ")),this._initPromise.then(function(){return t._logsDb.execute(n,r.args)})},clearOldLogs:function(){var e=new Date;return e.setDate(e.getDate()-n.daysToKeepLogs()),this.clearLogs({end:e})},_buildSqlFilter:function(e){var t=[],n=[];return e&&(e.domainId&&(t.push("domainId = ?"),n.push(e.domainId)),e.appId&&(t.push("appId = ?"),n.push(e.appId)),e.category&&(t.push("category = ?"),n.push(e.category)),e.start&&(t.push("timestamp >= datetime(?, 'unixepoch')"),n.push(Math.floor(e.start.getTime()/1e3))),e.end&&(t.push("timestamp <= datetime(?, 'unixepoch')"),n.push(Math.floor(e.end.getTime()/1e3)))),{conditions:t,args:n}}}),Object.defineProperties(r.prototype,{database:{get:function(){return this._logsDb}}}),new r}),define("Files/Mtl",["underscore"],function(e){"use strict";function t(){function f(t){t.classId&&(t=e.extend({},t),t.c=p(t.classId),delete t.classId),o.push(t)}function l(t,n){if(t.length===0)return;for(var r=0;r<t.length;r++){var i=t[r];i.classId&&(t[r]=i=e.extend({},i),i.c=p(i.classId),delete i.classId)}o=o.slice(0,n).concat(t).concat(o.slice(n))}function c(e){o.splice(e,1)}function h(t){var n=o[t];return n&&!e.isUndefined(n.c)&&(n=e.extend({classId:u[n.c]},n),delete n.c),n}function p(t){var n=a[t];return e.isUndefined(n)&&(n=a[t]=u.length,u.push(t)),n}function d(e){v(JSON.parse(e))}function v(e){t=e.mid,n=e.v,r=e.sid,i=e["#"],o=e.xacts||[],u=e.cids||[],s=e.segmentIndex,a={},u.forEach(function(e,t){a[e]=t})}function m(){var e={mid:t,v:n,sid:r,cids:u,xacts:o};return e["#"]=i,s&&(e.segmentIndex=s),e}var t,n,r,i,s,o=[],u=[],a={};return e.extend(this,{addXact:f,insertXacts:l,deleteXact:c,getXact:h,toJSON:m,fromJSON:v,parse:d}),Object.defineProperties(this,{modelId:{get:function(){return t},set:function(e){t=e}},modelVersion:{get:function(){return n},set:function(e){n=e}},seriesId:{get:function(){return r},set:function(e){r=e}},seqNum:{get:function(){return i},set:function(e){i=e}},segmentIndex:{get:function(){return s},set:function(e){s=e}}}),this}return t.fromJSON=function(e){var n=new t;return n.fromJSON(e),n},t.xactType={Begin:"B",Create:"C",Update:"U",Delete:"D",End:"E",SharedDataVersion:"SDV",Sync:"SYNC",Identity:"I",LoginUser:"LOGUSR",CreateValidate:"CV",Setting:"DS",LocalCreate:"LC"},t}),define("Files/Mtc",["underscore"],function(e){"use strict";var t="type, version, fileName, contentId, destinationId, domainId, targetId".split(", ");return function(){function i(t,n,i){r.push(e.extend({},i,{fileName:t,type:n}))}function s(){return{descriptor:n,files:r}}var n={},r=[];return Object.defineProperties({addFile:i,toJSON:s},t.reduce(function(e,t){return e[t]={get:function(){return n[t]},set:function(e){n[t]=e}},e},{}))}}),define("MDO/Error",[],function(){"use strict";function e(e,t){var n=new Error(e);this.message=e,this.stack=n.stack,this.mdoCode=t}return e.prototype=new Error,e}),define("DataModel/ModelField",["AH","underscore","Constants","../MDO/Error"],function(e,t,n,r){"use strict";function i(e,n){t.extend(this,n),this.textSize>4e3&&(this.textSize=undefined),this.modelClass=e}function l(t,n){this.modelClass=t,e.appendArray(this,n)}function c(e,n,r){var s=r?t.map(n,function(t){return new i(e,t)}):n;return new l(e,s)}function h(e){return e&&e.isIdField()}var s={Index:"Index",Unique:"Unique"},o={Number:"Number",Text:"Text",Bool:"Bool",Blob:"Blob",Date:"Date",Time:"Time",Timestamp:"Timestamp"},u={Int8:"Int8",Int16:"Int16",Int32:"Int32",Float64:"Float64",Decimal:"Decimal"},a={Int8:{min:-127,max:128},Int16:{min:-32768,max:32767},Int32:{min:-2147483648,max:2147483647},Float64:{min:-Number.MAX_VALUE,max:Number.MAX_VALUE}},f={Date:"Date",Time:"Time",DateTime:"DateTime",Timestamp:"Timestamp"};return i.prototype.getSchema=function(){var e=this.name;switch(this.fieldType){case o.Number:switch(this.numberType){case u.Float64:case u.Decimal:e+=" REAL";break;default:e+=" INTEGER"}break;case o.Text:e+=" TEXT COLLATE NOCASE";break;default:}switch(this.index){case s.Unique:e+=" PRIMARY KEY";break;default:}return this.allowNull||(e+=" NOT NULL"),e},i.prototype.isIdField=function(){return this.index===s.Unique},i.prototype.validateValue=function(n){function f(t){return t=Number(t),e.isNumber(t)&&t>=0&&t<=255}if(t.isUndefined(n)||t.isNull(n))return this.allowNull?undefined:"Required field is null";switch(this.fieldType){case o.Number:n=Number(n);if(!e.isNumber(n))return"Not a number";var r=this.numberType;if(r===u.Decimal){if(this.numberLength){var i=Math.pow(10,this.numberLength-this.numberPrecision);if(Math.abs(n)>=i)return"Number value out of range"}return undefined}r!==u.Float64&&(n=Math.round(n));var s=a[r];if(n<s.min||n>s.max)return"Number value out of range";break;case o.Text:n=String(n);if(this.textSize&&n.length>this.textSize)return"String value too long";break;case o.Timestamp:if(!Date.parse(n))return"Not a "+this.timestampType;break;case o.Bool:if(!t.isBoolean(n))return"Not a Boolean";break;case o.Blob:if(!t.isArray(n)||!t.every(n,f))return"Not a Blob";break;default:throw new Error("Unknown field type: "+this.fieldType)}return undefined},i.prototype.normalizeValue=function(n){if(!e.isDefined(n))return null;var r=this.validateValue(n);if(r)throw new Error("Invalid field value - "+r+" ("+this.modelClass.name+"."+this.name+")");switch(this.fieldType){case o.Timestamp:n=new Date(n);break;case o.Number:n=Number(n);switch(this.numberType){case u.Decimal:t.isNumber(this.numberPrecision)&&(n=Number(n.toFixed(this.numberPrecision)));break;case u.Float64:break;default:n=Math.round(n)}break;case o.Text:n=String(n);break;default:}return n},i.prototype.valueToDb=function(i){if(!e.isDefined(i))return i;try{switch(this.fieldType){case o.Bool:return e.boolToDb(i);case o.Blob:return e.blobToDb(i);case o.Timestamp:return this.timestampType===f.Timestamp&&(i=e.getLocalTimeAsUtc(i)),e.dateToDb(i);case o.Number:return this.numberType===u.Decimal&&t.isNumber(this.numberPrecision)&&(i=e.toFixedNumber(i,this.numberPrecision)),i;default:return i}}catch(s){throw new r("Unable to convert "+this.modelClass.name+"."+this.name+" value ("+i+") to DB.",n.errorCodes.notSupported)}},i.prototype.valueFromDb=function(t){if(!e.isDefined(t))return t;try{switch(this.fieldType){case o.Bool:return e.boolFromDb(t);case o.Blob:return e.blobFromDb(t);case o.Timestamp:return t=e.dateFromDb(t),this.timestampType===f.Timestamp&&(t=e.getUtcAsLocalTime(t)),t;default:return t}}catch(i){throw new r("Unable to convert "+this.modelClass.name+"."+this.name+" value ("+t+") from DB.",n.errorCodes.notSupported)}},l.prototype=[],l.prototype.getByName=function(i,s){function o(){throw new r("'"+this.modelClass.name+"."+i+"' model field does not exist.",n.errorCodes.unknownModelField)}return e.cachedArrayLookup(this,"name",i,s?t.bind(o,this):undefined)},l.prototype.getByFieldId=function(i,s){function o(){throw new r("'"+this.modelClass.name+"' model field with id '"+i+"' does not exist.",n.errorCodes.unknownModelField)}return e.cachedArrayLookup(this,"fieldId",i,s?t.bind(o,this):undefined)},{makeArray:c,isIdField:h}}),define("DataModel/ModelElement",["AH","underscore","Constants","../MDO/Error"],function(e,t,n,r){"use strict";function i(e,n){t.extend(this,n),this.modelClass=e,this.referenceField.element=this;var r=this.refClass.referencingElements||(this.refClass.referencingElements=[]);r.push(this)}function s(t,n){this.modelClass=t,e.appendArray(this,n)}function o(e,n,r){var o=r?t.map(n,function(t){return new i(e,t)}):n;return new s(e,o)}function u(n){var r=new s(n[0].modelClass,[]);return t.forEach(n,function(t){e.appendArray(r,t)}),r}return Object.defineProperty(i.prototype,"refClass",{get:function(){return this._refClass||(this._refClass=this.modelClass.model.classes.getByClassId(this.refClassId)),this._refClass}}),Object.defineProperty(i.prototype,"referenceField",{get:function(){return this.modelClass.fields.getByFieldId(this.fieldId)}}),s.prototype=[],s.prototype.getByName=function(i,s){function o(){throw new r("'"+this.modelClass.name+"."+i+"' model element does not exist.",n.errorCodes.unknownModelElement)}return e.cachedArrayLookup(this,"name",i,s?t.bind(o,this):undefined)},{makeArray:o,joinArrays:u}}),define("DataModel/ModelCollection",["AH","underscore","Constants","../MDO/Error"],function(e,t,n,r){"use strict";function i(e,n){t.extend(this,n),this.modelClass=e}function s(t,n){this.modelClass=t,e.appendArray(this,n)}function o(e,n,r){var o=r?t.map(n,function(t){return new i(e,t)}):n;return new s(e,o)}function u(n){var r=new s(n[0].modelClass,[]);return t.forEach(n,function(t){e.appendArray(r,t)}),r}return Object.defineProperty(i.prototype,"colClass",{get:function(){return this._colClass||(this._colClass=this.modelClass.model.classes.getByClassId(this.colClassId)),this._colClass}}),Object.defineProperty(i.prototype,"colParent",{get:function(){return this.colClass.fields.getByFieldId(this.colParentId)}}),s.prototype=[],s.prototype.getByName=function(i,s){function o(){throw new r("'"+this.modelClass.name+"."+i+"' model collection does not exist.",n.errorCodes.unknownModelCollection)}return e.cachedArrayLookup(this,"name",i,s?t.bind(o,this):undefined)},{makeArray:o,joinArrays:u}}),define("DataModel/ModelClass",["AH","underscore","./ModelField","./ModelElement","./ModelCollection","Constants","../MDO/Error"],function(e,t,n,r,i,s,o){"use strict";function a(e,n){t.extend(this,n),this.model=e}function f(n,r){e.appendArray(this,r),n.classes=this,t.each(this,function(e){e.initClass()})}function l(e){var n=t.map(e.classes,function(t){return new a(e,t)});return new f(e,n)}var u={Unknown:"Unknown",Record:"Record",File:"File",Folder:"Folder",Attribute:"Attribute",Message:"Message"};return a.prototype.initClass=function(){this.baseClass=this.model.classes.getByClassId(this.baseId),this.fields=n.makeArray(this,this.fields,!0),this.elements=r.makeArray(this,this.elements,!0),this.collections=i.makeArray(this,this.collections,!0)},a.prototype.getSchema=function(e){var t=[];for(var n=0;n<this.fields.length;n++)t.push(this.fields[n].getSchema());var r="CREATE TABLE "+(e||this.name)+" ("+t.join(", ")+")";return r},a.prototype.getEltOrFieldByName=function(e,t){var n=this.allFields.getByName(e);n||(n=this.allElements.getByName(e));if(!n&&t)throw new o("'"+this.name+"."+e+"' does not exist.",s.errorCodes.unknownModelField);return n},Object.defineProperties(a.prototype,{inheritance:{get:function(){if(!this._inheritance){this._inheritance=[];var e=this;while(e)this._inheritance.push(e),e=e.baseClass}return this._inheritance}},derivedClasses:{get:function(){return this._derived||(this._derived=this.model.classes.filter(function(e){return e.baseClass===this},this)),this._derived}},idField:{get:function(){return this._idField||this.fields.some(function(e){if(e.isIdField())return this._idField=e,!0},this),this._idField}},allFields:{get:function(){if(!this._allFields)if(this.inheritance.length===1)this._allFields=this.fields;else{var e=[];t.each(this.inheritance,function(r,i){t.each(r.fields,function(t){(i===0||!n.isIdField(t))&&e.push(t)})}),this._allFields=n.makeArray(this,e,!1)}return this._allFields}},allElements:{get:function(){return this._allElements||(this.inheritance.length===1?this._allElements=this.elements:this._allElements=r.joinArrays(t.pluck(this.inheritance,"elements"))),this._allElements}},allCollections:{get:function(){return this._allCollections||(this.inheritance.length===1?this._allCollections=this.collections:this._allCollections=i.joinArrays(t.pluck(this.inheritance,"collections"))),this._allCollections}},isFileClass:{get:function(){return this.type===u.File}}}),a.prototype.getFieldFilter=function(e){var n=this.inheritance.reduce(function(n,r){return t.extend(n,r.pluckOwnAttributes(e))},{});return n},a.prototype.pluckOwnAttributes=function(e){var n={},r=this.fields;return t.keys(e).filter(function(e){return r.getByName(e)}).forEach(function(t){n[t]=e[t]}),n},a.prototype.getIdFilter=function(e){var r={};return this.fields.filter(n.isIdField).forEach(function(n){var i=n.name,u=t.isObject(e)?e[i]:e;if(t.isUndefined(u))throw new o("value not defined for "+this.name+"."+i,s.errorCodes.missingValue);r[i]=u},this),r},f.prototype=[],f.prototype.getByName=function(t,n){function r(){throw new o("'"+t+"' model class does not exist.",s.errorCodes.unknownModelClass)}return e.cachedArrayLookup(this,"name",t,n?r:undefined)},f.prototype.getByClassId=function(t,n){function r(){throw new o("Id '"+t+"' model class does not exist.",s.errorCodes.unknownModelClass)}return e.cachedArrayLookup(this,"classId",t,n?r:undefined)},{makeArray:l}}),define("DataModel/Model",["./ModelClass","underscore","Constants","../MDO/Error"],function(e,t,n,r){"use strict";function i(n){t.isString(n)&&(n=JSON.parse(n)),t.extend(this,n),t.isArray(this.classes)&&e.makeArray(this)}function s(e){return new i(e)}return i.prototype.compareTo=function(i){var s=this,o={};if(!i||!i.classes)throw new r("Cannot compare to an invalid model.",n.errorCodes.invalidArgs);var u=t.pluck(s.classes,"classId"),a=t.pluck(i.classes,"classId");o.classesToCreate=t.difference(a,u),o.classesToDelete=t.difference(u,a);var f=t.intersection(u,a);return o.classesToAlter=t.filter(f,function(e){function o(e){var n={name:e.name};return t.each(e.fields,function(e){n[e.fieldId]=e.name}),n}var n=o(s.classes.getByClassId(e)),r=o(i.classes.getByClassId(e));return!t.isEqual(n,r)}),o},{fromString:s}}),define("MDO/Stats",["underscore","backbone","AH"],function(e,t,n){"use strict";function o(){return n.websql.queryCount()}function u(){return require("Data/Server").queryCount()}function a(){r||p();var t=e.extend(new c,JSON.parse(JSON.stringify(r)));return t.id=++i,t.ts=s(),t.queryCount=o(),t.serverQueryCount=u(),t}function f(t,n){if(!t||!t.stats)throw new Error("oldSnapshot is not a Snapshot");n=n||r;if(!n||!n.stats)throw new Error("newSnapshot is not a Snapshot");var i=e.extend(new h,{from:{ts:t.ts,id:t.id},to:{ts:n.ts||s(),id:n.id},stats:{}});i.elapsed=(n.ts||s())-t.ts,i.queryCount=(n.queryCount||o())-t.queryCount,i.serverQueryCount=(n.serverQueryCount||u())-t.serverQueryCount;var a=t.stats,f=n.stats,l=e.union(e.keys(a),e.keys(f)).sort();return e.forEach(l,function(t){var n=a[t]||{},r=f[t]||{},s=e.union(e.keys(n),e.keys(r)).sort(),o;e.forEach(s,function(e){var s=(r[e]||0)-(n[e]||0);s&&(o=o||(i.stats[t]={}),o[e]=s)})}),i}function l(t,n,i){if(!r)return;var s=r.stats,o=s[t]||(s[t]={});e.isUndefined(i)&&(i=1),o[n]=(o[n]||0)+i,o.$all=(o.$all||0)+i}function c(){}function h(){}function p(){r={stats:{}}}function d(){r=undefined}var r,i=0,s=e.isObject(window.performance)&&e.isFunction(window.performance.now)?e.bind(window.performance.now,window.performance):e.bind(Date.now,Date);c.prototype.toString=function(){var t=[];return t.push("[Snapshot "+this.id+" ("+this.ts+")]"),t.push("Local Queries:  "+this.queryCount),t.push("Server Queries: "+this.serverQueryCount),e.forEach(e.keys(this.stats).sort(),function(n){t.push(n);var r=this.stats[n],i=e.keys(r).sort();e.forEach(i,function(e){t.push("  "+e+": "+r[e])})},this),t.join("\n")},h.prototype.toString=function(){return this.format()},h.prototype.format=function(t){if(t==="short"){var n=[];return this.queryCount&&n.push("LQ "+this.queryCount),this.serverQueryCount&&n.push("SQ "+this.serverQueryCount),e.forEach(this.stats,function(e,t){var r=e.$all;if(r){var i=t.replace(/(\w)(?:\w*)(?:-?)/g,"$1");n.push(i+" "+r)}}),n.join(", ")}var r=[];return t==="full"&&r.push("[Snapshot Diff ("+this.from.id+" -> "+(this.to.id||"current")+")] "+(this.elapsed/1e3).toFixed(3)+"s"),this.queryCount&&r.push("Local Queries:  "+this.queryCount),this.serverQueryCount&&r.push("Server Queries: "+this.serverQueryCount),e.forEach(e.keys(this.stats).sort(),function(t){r.push(t);var n=this.stats[t],i=e.keys(n).sort();e.forEach(i,function(e){r.push("  "+e+": "+n[e])})},this),r.join("\n")};var v={now:s,snapshot:a,diff:f,updateStat:l,reset:function(){i=0,r=undefined}};return Object.defineProperties(v,{enabled:{get:function(){return Boolean(r)},set:function(e){e&&!r?p():r&&!e&&d()}},queryCount:{get:o},serverQueryCount:{get:u}}),v}),define("Data/TempId/TempIdRow",["underscore","backbone","AH"],function(e,t,n){"use strict";var r=t.Model.extend({idAttribute:"tempid",sync:function(e,t,r){function s(e){return r.success(e),n.resolve(i)}function o(e){return n.reject(e)}function u(e,t,s){function f(n){return{id:n.insertId,sequence:e,tempid:t,permid:s}}var o='INSERT OR REPLACE INTO "@tempid" (sequence, tempid, permid) VALUES (?, ?, ?)',u=[e,t,s];if(r.xact){var a=n.defer();return r.xact.executeSql(o,u,function(e,t){a.resolve(f(t))},function(e,t){a.reject(t)}),a.promise}return i.collection._db.execute(o,u).then(f)}var i=this;switch(e){case"update":return u(this.attributes.sequence,this.attributes.tempid,this.attributes.permid).then(s,o);default:return n.reject(new Error("TempIdRow sync method not implemented: "+e))}}});return r}),define("Data/TempId/TempIdCache",["./TempIdRow","underscore","backbone","AH"],function(e,t,n,r){"use strict";var i=n.Collection.extend({_seriesColumnExists:function(){return this._db.tableExists("@tempid").then(function(e){return e?e.sql.indexOf("series")>-1:!1})},model:e,initialize:function(e,t){var n=this;t=t||{},this._db=t.database;var i="@tempid",s='CREATE TABLE IF NOT EXISTS "{0}" (id INTEGER PRIMARY KEY ASC, sequence INTEGER NOT NULL, tempid INTEGER NOT NULL, permid INTEGER NOT NULL, ts TIMESTAMP DEFAULT CURRENT_TIMESTAMP, UNIQUE (tempid))';this._tablePromise=this._seriesColumnExists().then(function(e){return e?n._db.transaction(function(e){var t="@tempidCOPY",n='INSERT INTO "{0}" SELECT id, sequence, tempid, permid, ts FROM "{1}"',o='DROP TABLE "{0}"';e.executeSql(r.format(s,t)),e.executeSql(r.format(n,t,i)),e.executeSql(r.format(o,i)),e.executeSql(r.format(s,i)),e.executeSql(r.format(n,i,t)),e.executeSql(r.format(o,t))}):n._db.transaction(function(e){e.executeSql(r.format(s,i))})})},sync:function(e,t,n){function o(e){return n.success(e),r.resolve(s)}function u(e){return r.reject(e)}function a(){return i.read('SELECT * FROM "@tempid"',function(e){var t=[],n=e.rows;for(var r=0;r<n.length;r++)t.push(n.item(r));return t})}var i=this._db,s=this;switch(e){case"read":return this._tablePromise.then(a).then(o,u);default:return r.reject(new Error("TempIdCache sync method not implemented: "+e))}},comparator:function(e,t){return t.attributes.tempid-e.attributes.tempid},purgeTempIdCache:function(e){return this._tablePromise.then(t.bind(function(){return this._db.execute('DELETE FROM "@tempid" WHERE sequence <= ?',[e]).then(t.bind(function(){return this},this))},this))},emptyTempIdCache:function(){return this._tablePromise.then(t.bind(function(){return this._db.execute('DELETE FROM "@tempid"').then(t.bind(function(){return this.fetch()},this))},this))},resolveTempId:function(e){var t=this.get(e);return t?t.get("permid"):e}});return i}),define("Settings/Storage",["underscore","AH","lib/Class"],function(e,t,n){"use strict";return n.extend({initialize:function(t,n){this._tableName=n,this._db=t,this._openPromise=this._db.promise.then(e.bind(this._createSettingsTable,this)),this._openPromise.then(null,function(){this._db=undefined})},_createSettingsTable:function(){return this._db.execute('CREATE TABLE IF NOT EXISTS "'+this._tableName+'" (Key NOT NULL, Value, UNIQUE( Key ))')},getItem:function(t){return this._openPromise.then(e.bind(function(){return this._db.read('SELECT Value FROM "'+this._tableName+'" WHERE Key = ?',[t]).then(function(e){return e.rows.length===0?null:e.rows.item(0).Value})},this))},getAllItems:function(){return this._openPromise.then(e.bind(function(){return this._db.read('SELECT Key, Value FROM "'+this._tableName+'"').then(function(e){if(e.rows.length===0)return{};var t={};for(var n=0;n<e.rows.length;n++){var r=e.rows.item(n);t[r.Key]=r.Value}return t})},this))},setItem:function(t,n){return this._openPromise.then(e.bind(function(){return e.isObject(n)&&(n=JSON.stringify(n)),this._db.execute('INSERT OR REPLACE INTO "'+this._tableName+'" (Key, Value) VALUES(?, ?)',[t,n]).then(function(){return n})},this))},removeItem:function(t){return this._openPromise.then(e.bind(function(){return this._db.execute('DELETE FROM "'+this._tableName+'" WHERE Key = ?',[t])},this))},removeAllItems:function(){return this._openPromise.then(e.bind(function(){return this._db.execute('DELETE FROM "'+this._tableName+'"')},this))}})}),define("Settings/StorageWrapper",["underscore","AH","lib/Class"],function(e,t,n){"use strict";return n.extend({initialize:function(e,t,n){this._settings={},this._defaults=n||{},this._storage=e,this._createPropertyAccessors(t),this._isLoaded=!1},load:function(){var e=this;return this._storage.getAllItems().then(function(t){e._settings=t,e._isLoaded=!0})},getAllItems:function(){return e.clone(this._settings)},_createPropertyAccessors:function(t){function r(t){function r(){return n._throwIfNotLoaded(),e.isUndefined(n._settings[t])?n._getDefaultValueOrNull(t):n._settings[t]}function i(e){return n._storage.setItem(t,e).then(function(e){return e===null?(delete n._settings[t],undefined):n._settings[t]=e})}n[t]=function(e){return e===undefined?r():i(e)}}var n=this;t&&e.each(t,function(e){r(e)})},_getDefaultValueOrNull:function(t){return e.isUndefined(this._defaults[t])?null:this._defaults[t]},_throwIfNotLoaded:function(){if(!this._isLoaded)throw new Error("Storage items have not been loaded")},clear:function(){return this._storage.removeAllItems().then(e.bind(function(){this._settings={}},this))},isEmpty:function(){return this._throwIfNotLoaded(),e.isEmpty(this._settings)}})}),define("Settings/Datastore",["./Storage","./StorageWrapper","underscore","AH"],function(e,t,n,r){"use strict";var i=t.extend({initialize:function(n){var i=new e(n,"@settings");t.prototype.initialize.call(this,i,["id","name","model","modelId","modelVersion","inSeriesId","outSeriesId","inSeqNum","outSeqNum","nextTempId"]),this._previousTempIdPromise=r.resolve()},generateNextTempId:function(){function n(){r.chainPromise(e.nextTempId(e.nextTempId()-1),t)}var e=this,t=r.defer();return this._previousTempIdPromise.always(n),this._previousTempIdPromise=t.promise},importSettingsFromDsInfo:function(e){function u(){n.each(s,function(t){e[t](null)})}var t=this,i=["id","name","modelId","modelVersion","inSeriesId","inSeqNum","outSeriesId","outSeqNum","nextTempId"],s=n.rest(i,2),o;return n.each(i,function(n){o=r.when(o).then(function(){return t[n](e[n]())})}),o.then(u)}});return Object.defineProperties(i.prototype,{incomingMtlFilePattern:{get:function(){if(this.outSeriesId()===null)throw new Error("No 'outSeriesId' has been set");return this.outSeriesId()+".*.MTL"}},outgoingMtcFilePattern:{get:function(){if(this.inSeriesId()===null)throw new Error("No 'inSeriesId' has been set");return this.inSeriesId()+".*.mtc"}}}),i}),define("Files/fileSystem",["AH","underscore"],function(e,t){"use strict";return function(){function g(){return i?i:window.cordova&&window.requestFileSystem?n.Native:window.webkitRequestFileSystem||window.requestFileSystem?n.Browser:n.None}function b(){var t=window.PERSISTENT;navigator.webkitPersistentStorage?(a=e.bindCallViaCallbacks(navigator.webkitPersistentStorage.requestQuota,navigator.webkitPersistentStorage),f=e.bindCallViaCallbacks(navigator.webkitPersistentStorage.queryUsageAndQuota,navigator.webkitPersistentStorage)):(a=e.bindCallViaCallbacks(window.webkitStorageInfo.requestQuota,window.webkitStorageInfo,t),f=e.bindCallViaCallbacks(window.webkitStorageInfo.queryUsageAndQuota,window.webkitStorageInfo,t)),u=P,s=e.bindCallViaCallbacks(window.webkitRequestFileSystem||window.requestFileSystem,window,t)}function w(){s=window.requestFileSystem,u=D,s=e.bindCallViaCallbacks(s,window,window.LocalFileSystem.PERSISTENT)}function S(){return h!==c?h:(i=g(),i===n.None?l:(i===n.Native?w():i===n.Browser&&y(),h=x().then(N),h.then(function(e){o=e},C),h))}function x(){return i===n.Native?e.resolve():f().then(function(e){var t=e[r];return t>=d?t:a(d)})}function T(){return f().then(function(e){return a(e[r]+p)})}function N(e){return s(e||0)}function C(){h=c,s=undefined,o=undefined,u=undefined,a=undefined,f=undefined,i=undefined}function L(t,n){n=n||{create:!0};var r=F(t);return r.filename?j(r.dir,{create:n.create}).then(function(t){return e.whenCallViaCallbacks(t.getFile,t,r.filename,n)}):e.reject(new Error("'path' refers to a directory and not to a file ('"+t+"')."))}function O(e,t){return E().then(function(){return k(e)}).then(function(e){return M(e,t)})}function M(t,r){return u(r).then(function(r){var s=e.defer();return t.createWriter(function(t){function u(){function i(){n.resolve()}function s(e){n.reject(e)}var n=e.defer();return t.onerror=s,t.onwriteend=i,t.write(r),n.promise}function a(){function s(){r.resolve()}function o(e){r.reject(e)}if(i===n.Native)return e.resolve();var r=e.defer();return t.onerror=o,t.onwriteend=s,t.truncate(t.position),r.promise}var o=u().then(a);e.chainPromise(o,s)},function(t){s.reject(t)}),s.promise})}function D(n){return t.isString(n)?e.resolve(window.btoa(n)):n instanceof Blob||n instanceof File?H(n):e.reject(new Error("Unable to normalize data for write. 'data' is not of a supported type."))}function P(t){return D(t).then(function(t){return e.createBlob(t,"text/plain")})}function H(t){function i(t){var r=t.target.result;n.resolve(e.arrayBufferToBase64String(r))}function s(e){n.reject(e)}var n=e.defer(),r=new FileReader;return r.onerror=s,r.onloadend=i,r.readAsArrayBuffer(t),n.promise}function B(t){function n(n){function i(n){var i=new FileReader;i.onerror=s,i.onload=function(n){var i=n.target.result,s=e.base64StringToArrayBuffer(i);r.resolve(e.createBlob(s,q(t)))},i.readAsText(n)}function s(e){r.reject(e)}var r=e.defer();return n.file(i,s),r.promise}return E().then(function(){return k(t,{create:!1})}).then(n)}function j(n,r){function u(e){if(!s.length)i.resolve(e);else{var t=s.shift();e.getDirectory(t,r,function(e){u(e)},function(e){i.reject(e)})}}r=r||{create:!0};var i=e.defer(),s=t.without(n.split("/"),"");return u(o.root),i.promise}function F(n){if(!e.isDefined(n)||!t.isString(n))throw new Error("'path' must be a valid string.");if(n==="")return{dir:"",filename:"",path:""};var r=n.lastIndexOf("/")+1,i=n.substr(r),s=n.substr(0,r);return{dir:s,filename:i,path:s+i}}function I(e){var t=F(e),n=t.filename,r=n.lastIndexOf(".");return r===-1?"":n.substr(r+1)}function q(e){var t=I(e);return m[t.toLowerCase()]||v}function U(t,n){return E().then(function(){return k(t,{create:!1})}).then(function(t){var r=F(n);return z(n).then(function(){return j(r.dir)}).then(function(n){return e.whenCallViaCallbacks(t.copyTo,t,n,r.filename)})})}function z(t){return E().then(function(){return k(t,{create:!1})}).then(function(t){return e.whenCallViaCallbacks(t.remove,t)}).then(null,X)}function W(t){return E().then(function(){var n=F(t);return n.filename?e.reject(new Error("'path' refers to a file and not to a directory ('"+t+"').")):j(n.dir,{create:!1})}).then(function(t){return e.whenCallViaCallbacks(t.removeRecursively,t)}).then(null,X)}function X(t){if(t.code!==FileError.NOT_FOUND_ERR)return e.reject(t)}function V(t){return function(){function u(){return t.apply(r,s)}var r=this,s=arguments,o=u();return i===n.Browser&&(o=o.then(null,function(t){return t.code===FileError.QUOTA_EXCEEDED_ERR?T().then(u,function(){return e.reject(t)}):e.reject(t)})),o}}var n={Native:"Native",Browser:"Browser",None:"None"},r=1,i,s,o,u,a,f,l=e.reject(new Error("File System API is not supported.")),c=e.reject(new Error("File system is closed.")),h=c,p=1073741824,d=p,v="application/octet-stream",m={avi:"video/x-msvideo",bmp:"image/bmp",gif:"image/gif",jpe:"image/jpeg",jpeg:"image/jpeg",jpg:"image/jpeg",mov:"video/quicktime",mp2:"audio/mpeg",mp3:"audio/mpeg",mp4:"video/mp4",mpe:"video/mpeg",mpeg:"video/mpeg",mpg:"video/mpeg",mpga:"audio/mpeg",pbm:"image/x-portable-bitmap",pcm:"audio/x-pcm",pct:"image/pict",pdf:"application/pdf",pgm:"image/x-portable-graymap",pic:"image/pict",pict:"image/pict",png:"image/png",pnm:"image/x-portable-anymap",pnt:"image/x-macpaint",pntg:"image/x-macpaint",ppm:"image/x-portable-pixmap",qt:"video/quicktime",ra:"audio/x-pn-realaudio",ram:"audio/x-pn-realaudio",ras:"image/x-cmu-raster",rgb:"image/x-rgb",snd:"audio/basic",txt:"text/plain",tif:"image/tiff",tiff:"image/tiff",wav:"audio/x-wav",wbmp:"image/vnd.wap.wbmp"},y=b,E=S,k=L,A=O,R=U,$={writeFile:V(function(){return A.apply(this,arguments)}),getFile:V(function(){return B.apply(this,arguments)}),deleteFile:V(function(){return z.apply(this,arguments)}),copyFile:V(function(){return R.apply(this,arguments)}),deleteDirectory:W,parsePath:F,getMimeType:q,SupportLevels:n,FileError:{NOT_FOUND_ERR:window.FileError?window.FileError.NOT_FOUND_ERR:1,QUOTA_EXCEEDED_ERR:window.FileError?window.FileError.QUOTA_EXCEEDED_ERR:10},_close:C,_initialQuota:d,_quotaSizeIncrease:p,_getDirectory:j,_createFileError:function(e){var t=g(),r;return t===n.Native?r=new FileError(e):(r=new Error,r.code=e,FileError&&(r.__proto__=FileError.prototype)),r}};return Object.defineProperties($,{isSupported:{get:function(){return this.supportLevel!==n.None}},supportLevel:{get:g},_fs:{get:function(){return o}},_getFileEntry:{get:function(){return k},set:function(e){k=e}},_writeFile:{get:function(){return A},set:function(e){A=e}},_copyFile:{get:function(){return R},set:function(e){R=e}},_open:{get:function(){return E},set:function(e){E=e}},_requestQuota:{get:function(){return a},set:function(e){a=e}},_queryUsageAndQuota:{get:function(){return f},set:function(e){f=e}},_captureAndWrapBrowserAPI:{get:function(){return y},set:function(e){y=e}}}),$}()}),define("Files/Operation",["AH","underscore","lib/Class"],function(e,t,n){"use strict";return n.extend({execute:function(){return this._executionPromise||(this._executionPromise=this._onExecute()),this._executionPromise},_onExecute:function(){}})}),define("Files/WriteOperation",["./fileSystem","./Operation"],function(e,t){"use strict";return t.extend({initialize:function(e,n){t.prototype.initialize.apply(this,arguments),this._path=e,this._data=n},_onExecute:function(){return e.writeFile(this._path,this._data)}})}),define("Files/CopyOperation",["./fileSystem","./Operation"],function(e,t){"use strict";return t.extend({initialize:function(e,n){t.prototype.initialize.apply(this,arguments),this._srcPath=e,this._dstPath=n},_onExecute:function(){return e.copyFile(this._srcPath,this._dstPath)}})}),define("Files/DeleteOperation",["./fileSystem","./Operation","Logging/logger","AH"],function(e,t,n,r){"use strict";return t.extend({initialize:function(e,n){t.prototype.initialize.apply(this,arguments),this._path=e,this._alwaysSucceed=n},_onExecute:function(){var t=e.deleteFile(this._path);return this._alwaysSucceed&&(t=t.then(null,function(e){return n.logError(e),r.resolve()})),t}})}),define("MDO/Vault",["AH","underscore","Files/fileSystem","Files/WriteOperation","Files/CopyOperation","Files/DeleteOperation"],function(e,t,n,r,i,s){"use strict";return function(o){function l(){return n.isSupported?n.deleteDirectory(E()):e.resolve()}function c(){if(u)throw f;u=[]}function h(){if(!u)return e.reject(a);var n=u;return d(),t.reduce(n,function(e,t){return e.then(function(){return t.execute()})},e.resolve())}function p(){return u?(d(),e.resolve()):e.reject(a)}function d(){u=undefined}function m(t){return u?(u.push(t),e.resolve()):t.execute()}function g(n,s,o){var u=w(s,o),a;if(t.isString(n))a=new i(n,u);else{if(!(n instanceof Blob||n instanceof File))return e.reject(new Error("Unable to add vault file. File 'data' is not of a supported type."));a=new r(u,n)}return v(a)}function y(e,t,n){var r=new s(w(e,t),n);return v(r)}function b(t,r){var i=w(t,r);return n.getFile(i).then(null,function(t){return t.code!==n.FileError.NOT_FOUND_ERR?e.reject(t):e.resolve(null)})}function w(e,n){var r=t.isString(e)?e:e.name;return E()+r+"/"+encodeURIComponent(n)}function E(){return o.directory()+"Vault/"}var u,a=new Error("A transaction has not been started."),f=new Error("A transaction is already in progress.");d();var v=m,S={addFile:g,getFile:b,removeFile:y,getVaultFilePath:w,getVaultDirectory:E,beginTransaction:c,commitTransaction:h,rollbackTransaction:p,destroy:l};return Object.defineProperties(S,{_executeOrQueueOperation:{get:function(){return v},set:function(e){v=e}},_operationQueue:{get:function(){return u}}}),S}}),define("Data/AbstractStore",["lib/Class","AH","underscore","DataModel/ModelField","Data/TempId/TempIdCache","DataModel/Model","Settings/Datastore","MDO/Vault","Logging/logger","Files/fs","Constants"],function(e,t,n,r,i,s,o,u,a,f,l){"use strict";var c="\0\0\0",h="\0\0",p=e.extend({constructor:function(e){this._dsInfo=e,this._dsSettings=undefined,this._db=undefined,this._model=undefined,this._vault=new u(this._dsInfo),this._tempIdCache=undefined},close:function(){return this._dsSettings=undefined,this._db=undefined,this._tempIdCache=undefined,this._model=undefined,t.resolve(this)},getModelClass:function(e){if(!this._model)throw new Error("No model specified");var t=this._model.classes.getByName(e);if(!t)throw new Error("Invalid class name: "+e);return t},_loadModel:function(){function i(){var t=f.readFile(e._dsInfo.modelPath()).then(function(t){return e._dsSettings.model(t.content)});return t.then(function(){return f.deleteFile(e._dsInfo.modelPath())}),t}var e=this,n,r=!e._dsSettings.model()&&e._dsSettings.modelVersion();return r&&(n=i()),t.when(n).then(function(){var t=e._dsSettings.model();t?e._model=s.fromString(e._dsSettings.model()):e._model=undefined})},_loadSettings:function(){var e=this;return e._dsSettings=new o(e._db),e._dsSettings.load().then(function(){if(e._dsSettings.isEmpty())return e._transaction(function(){return e._dsSettings.importSettingsFromDsInfo(e._dsInfo)})})},_setModel:function(e){this._model=e},_retrieveTempIdCache:function(){var e=this;return t.when(t.deferredTryCatch(function(){if(!e._db)throw new Error("Database has not been opened. Cannot access TempIdCache");return e._tempIdCache?e._tempIdCache:(e._tempIdCache=new i(undefined,{database:e._db}),e._tempIdCache.fetch())}),undefined,function(){e._tempIdCache=undefined})},_reloadTempIdCache:function(){return this._tempIdCache=undefined,this._retrieveTempIdCache()},_openDatabase:function(){return(this._db||(this._db=t.websql(this._dsInfo.dbName()))).promise},_transaction:function(e){function s(){var s=t.defer();r._vault.beginTransaction(),i=!0;var o=r._db.transactionBatch(function(){try{var n=e();return t.when(n,null,null,function(e){s.progress(e)}),n}catch(r){return t.reject(r)}});return o=o.then(null,function(e){return r._dsSettings.load().then(n.bind(r._loadModel,r)).then(n.bind(r._reloadTempIdCache,r)).always(function(){return t.reject(e)})}),t.when(o,function(e){s.resolve(e)},function(e){s.reject(e)}),s.promise}function o(e){return r._vault.commitTransaction().then(function(){return e},function(e){var n=new Error("There was an error committing file updates. File elements may be in an inconsistent state.");return n.exception=e,r._logError(n),t.reject(n)})}function u(e){function n(){return t.reject(e)}return i?r._vault.rollbackTransaction().then(n,n):n()}var r=this;if(!n.isFunction(e))return t.reject(new Error("No transaction callback was specified"));var i=!1;return r._db.promise.then(s).then(o,u)},_logError:function(e,t){a.logError(e,n.extend({domainId:this._dsInfo.id()},t))},getRows:function(e){return this._readRows(e)},getRow:function(e){function n(n){if(n.length===1)return n[0];var r=new Error(n.length+" rows matched for '"+e.className+"' WHERE "+JSON.stringify(e.filter));return r.mdoCode=n.length<1?l.errorCodes.dataNotFound:l.errorCodes.dataNotUnique,t.reject(r)}return this._readRows(e).then(n)},_readRows:function(e){var n=new Error("abstract method, _readRows, has not been implemented");return n.mdoCode=l.errorCodes.notSupported,t.reject(n)}},{dbToMtlValue:function(e,r){if(n.isNull(r))return r;switch(e.fieldType){case"Bool":return t.boolFromDb(r);case"Blob":return c+r;case"Timestamp":return h+r;default:return r}},mtlToDbValue:function(e,t){if(n.isNull(t))return t;switch(e.fieldType){case"Bool":return t?1:0;case"Blob":return t.substring(c.length);case"Timestamp":return t.substring(h.length);default:return t}},parseFilter:function(e,i,s,o){var u=e;if(!n.isString(e)){e=e||{};var a=[];i=[],n.keys(e).forEach(function(t){var n=s.allFields.getByName(t,!0);i.push(n.valueToDb(e[t])),r.isIdField(n)&&(t=s.name+"."+t),a.push(t+"=?")}),u=a.join(" AND ")}else i&&(i=n.map(i,function(e){return n.isBoolean(e)?o?e:t.boolToDb(e):e instanceof Date?o?h+t.dateToDb(e):t.dateToDb(e):e instanceof Array?t.blobToDb(e):e}));return{filter:u,filterParams:i}}});return Object.defineProperties(p.prototype,{database:{get:function(){return this._db}},settings:{get:function(){return this._dsSettings}},model:{get:function(){return this._model}},vault:{get:function(){return this._vault}},dataStoreInfo:{get:function(){return this._dsInfo}}}),p}),define("Data/XactPromiseWrapper",["AH"],function(e){"use strict";return function(t){var n=0,r=e.defer(),i=!1;this.executeSql=function(e,s,o,u){if(i)throw new Error("Cannot add statements after the xact promise wrapped has been marked completed.");n++,t.executeSql(e,s,function(){o&&o.apply(this,arguments),n--,n===0&&(r.resolve(),i=!0)},function(e,t){u&&u.apply(this,arguments),n--,n===0&&(r.reject(t),i=!0)})},this.done=function(){i=!0,n===0&&r.resolve()},this._dfd=r,this.promise=r.promise}}),define("Data/FilterTokenizer",[],function(){"use strict";function t(t){function s(e){var n,r;for(n=e+1;n<t.length;n++){r=t[n];if(!(r==="."||r==="_"||r>="a"&&r<="z"||r>="A"&&r<="Z"||r>="0"&&r<="9"))break}return n}function o(n){var r,i,s=!1;for(r=n;r<t.length;r++){i=t[r];if(i==="'")s=!s;else if(!s&&i===e)break}return r}if(!t)return[];var n=[],r=0;while(r<t.length){var i;t[r]===e?i=s(r):i=o(r),n.push(t.substring(r,i)),r=i}return n}var e="$";return{tokenize:t,logicalTokenPrefix:e}}),define("Data/QueryBuilder",["underscore","AH","Data/FilterTokenizer","DataModel/ModelField"],function(e,t,n,r){"use strict";function i(e,t){var n="SELECT COUNT(*) FROM "+a(e)+o(e,{filter:t});return n}function s(n,r){function i(){if(!r||t.isEmpty(r.limit)||!t.isDefined(r.limit))return"";if(!e.isNaN(r.limit)&&e.isFinite(r.limit)&&r.limit>0)return" LIMIT "+r.limit;throw new Error("Invalid LIMIT value: "+r.limit)}function s(){if(!r||t.isEmpty(r.offset)||!t.isDefined(r.offset))return"";if(!e.isNaN(r.offset)&&e.isFinite(r.offset)&&r.offset>=0)return" OFFSET "+r.offset;throw new Error("Invalid OFFSET value: "+r.offset)}return u(n,r)+o(n,r)+i()+s()}function o(t,n){if(!n||!n.filter&&!n.orderBy)return"";var r="",i=new l,s=f(t,n.filter,i,/\sOR\s/i.test(n.filter)?"LEFT OUTER JOIN":"JOIN"),o=f(t,n.orderBy,i,"LEFT OUTER JOIN");return e.each(i.joins,function(e){r+=" "+e.type+" "+e.table+" "+e.tableAlias+" ON "+e.condition}),n.filter&&(r+=" WHERE "+s),n.orderBy&&(r+=" ORDER BY "+o),r}function u(t,n){n=n||{};var r=a(t),i=t.allFields,s=n.fields;if(s){var o=t.idField;s.indexOf(o.name)===-1&&s.unshift(o.name),i=e.map(s,function(e){return i.getByName(e,!0)})}else t.baseClass?i=e.filter(t.baseClass.allFields,function(e){return!e.isIdField()}):i=[],i.unshift({modelClass:t,name:"*"});var u=e.map(i,function(e){return e.modelClass.name+"."+e.name});return"SELECT "+u.join(", ")+" FROM "+r}function a(e){var t,n="";return e.inheritance.forEach(function(e){t?n+=" JOIN "+e.name+" ON "+t.name+".PKey = "+e.name+".PKey":n+=e.name,t=e}),n}function f(t,r,i,s){function u(e){return e&&e.charAt(0)===n.logicalTokenPrefix?a(e):e}function a(e){e===n.logicalTokenPrefix?e=t.idField.name:e=e.substring(1);var r=e.split("."),o=t,u,a,f,l=n.logicalTokenPrefix+o.name;for(var c=0;c<r.length-1;c++){var h=o.allElements.getByName(r[c],!0);u||(u=h.modelClass.name);var p=r[c+1],d=h.refClass.getEltOrFieldByName(p,!0);a=d.modelClass,l+=":"+h.name+":"+a.name,i.hasExistingJoin(l)?(i.restrictJoin(l,s),f=i.getTableAlias(l)):(f=i.createTableAlias(l),i.addJoin(l,{table:a.name,tableAlias:f,type:s,condition:f+"."+a.idField.name+" = "+u+"."+h.referenceField.name})),o=a,u=f}var v=r[r.length-1],m=o.getEltOrFieldByName(v,!0),g=u||m.modelClass.name,y=m.referenceField?m.referenceField.name:m.name;return g+"."+y}var o=n.tokenize(r);return e.map(o,u).join("")}function l(){function i(){return"AHE_MT"+t++}function s(e){var t=r[e];return t===undefined?undefined:t.tableAlias||t.table}function o(e){return Boolean(r[e])}function u(e,t){var i=t.tableAlias||t.table;if(!e)throw new Error("No join descriptor provided");if(r[e])throw new Error("Duplicate use of join descriptor  '"+e+"'");if(n[i])throw new Error("Duplicate use of table alias '"+i+"'");r[e]=t,n[i]=!0}function f(e,t){if(!e)throw new Error("No join descriptor provided");var n=r[e];if(!n)throw new Error("Join descriptor  '"+e+"' does not have any join associated with it");a[n.type]>a[t]&&(n.type=t)}var t=0,n={},r={},a={"LEFT OUTER JOIN":1,JOIN:0};return{createTableAlias:i,getTableAlias:s,hasExistingJoin:o,addJoin:u,restrictJoin:f,get joins(){return e.values(r)}}}return{buildCountQuery:i,buildInheritanceSelectQuery:u,buildSelectQuery:s,_internal:{buildJoinsAndConditions:o}}}),define("Data/Store",["AH","MDO/Stats","Data/AbstractStore","Data/XactPromiseWrapper","underscore","Constants","Data/QueryBuilder","DataModel/Model","Logging/logger","Files/fs","Files/Mtl"],function(e,t,n,r,i,s,o,u,a,f,l){"use strict";var c={permanentId:"id",primaryTempId:"ptmp",foreignTempId:"ftmp",bothTempId:"btmp"},h=n.extend({constructor:function(t){n.prototype.constructor.call(this,t),this._closedRejectedPromise=e.reject(new Error("Store is closed")),this._openPromise=this._closedRejectedPromise,this._isOpen=!1,this._systemTablesRejectedPromise=e.reject(new Error("The datastore's system tables have not been initialized")),this._systemTablesPromise=this._systemTablesRejectedPromise,this._isMtlXactInProgress=undefined},open:function(){var e=this;return e._openPromise!==e._closedRejectedPromise?e._openPromise:(e._openPromise=e._openDatabase().then(i.bind(e._createSystemTables,e)).then(i.bind(e._loadSettings,e)).then(i.bind(e._loadModel,e)).then(i.bind(e._importIncomingMtlsFromFs,e)).then(function(){return e}),e._openPromise.then(function(){e._isOpen=!0},i.bind(e.close,e)),e._openPromise)},reset:function(e){var t=this,n;return t._model=undefined,n=e?t._openPromise.then(i.bind(t._performPartialReset,t)):t._openPromise.always(i.bind(t._openDatabase,t)).then(t._db.destroyDatabase).then(function(){t._tempIdCache=undefined,t._systemTablesPromise=t._systemTablesRejectedPromise}),n.then(function(){return t})},close:function(){var e=this;return n.prototype.close.call(e).then(function(){e._openPromise=e._closedRejectedPromise,e._isOpen=!1,e._systemTablesPromise=e._systemTablesRejectedPromise})},destroy:function(){var t=this;return t.reset().then(function(){return t._vault.destroy()}).then(i.bind(t.close,t),function(n){return t.close(),e.reject(n)})},applyMtlXacts:function(t){function o(o){function v(){function T(){return m.done(),g.push(m.promise),e.whenAll(g).then(v)}function N(t,r){var s=[];return i.forEach(r,function(e){s.push(n._vault.removeFile(t,e.ahFileName,!0))}),e.whenAll(s)}function C(t){var n=[],r=s.getByClassId(t.classId);return r.isFileClass&&n.push(k(r,t).then(i.partial(N,r))),e.whenAll(n)}function k(e,t){if(t.id){var r={};return i.keys(t.id).forEach(function(n){r[e.fields.getByFieldId(n).name]=t.id[n]}),n.getRows({className:e.name,filter:r})}return n.getRows({className:e.name,filter:e.idField.name+" > ? AND ahCurrentUploadTS IS NULL",filterParams:[0]})}var m,g;if(!t.getXact(u))return e.resolve();var y;g=[],m=new r(o);while(y=t.getXact(u++))switch(y.t){case l.xactType.Begin:case l.xactType.End:break;case l.xactType.SharedDataVersion:break;case l.xactType.Create:case l.xactType.CreateValidate:var b=a(y);m.executeSql(b.sql,b.args);break;case l.xactType.LocalCreate:var w=f(y);m.executeSql(w.sql,w.args);break;case l.xactType.Update:if(y.set){var E=p(y);m.executeSql(E.sql,E.args)}break;case l.xactType.Delete:g.push(C(y));var S=c(y);m.executeSql(S.sql,S.args);break;case l.xactType.Identity:return g.push(d(o,y)),T();case l.xactType.Sync:var x=y.set[h.MtlValueIds.inSequenceNum];g.push(n.purgeOutgoingMtlXacts(n._dsSettings.inSeriesId(),x)),g.push(n.purgeTempIdCache(x));break;default:throw new Error("Unexpected MTL Xact Type: "+y.t)}return T()}var u=0;return v()}function u(e,t){var n=[];return i.keys(t).forEach(function(r){var i=e.getByFieldId(r);n.push(h.mtlToDbValue(i,t[r]))}),n}function a(e){var t=s.getByClassId(e.classId),n=i.keys(e.id).concat(i.keys(e.set||{})),r=u(t.fields,e.set||{}),o=i.values(e.id).concat(r),a=i.map(n,function(e){return this.getByFieldId(e).name},t.fields),f=i.map(a,function(){return"?"}),l="INSERT OR REPLACE";return{sql:l+" INTO "+t.name+" ("+a.join(",")+") VALUES ("+f.join(",")+")",args:o}}function f(e){function h(e){return t.fields.getByFieldId(e).name}function p(e){return"new."+e}function d(e){return"old."+e}function v(e){return"? AS "+e}var t=s.getByClassId(e.classId),n=i.keys(e.id).concat(i.keys(e.set||{})),r=i.difference(i.map(i.pluck(t.fields,"fieldId"),String),n);if(r.length===0)return a(e);var o=i.map(n,h),f=i.map(r,h),l=o[0],c=i.values(e.id).concat(u(t.fields,e.set||{}));return{sql:"INSERT OR REPLACE INTO "+t.name+" ("+o.join(", ")+", "+f.join(", ")+")"+" SELECT "+i.map(o,p).join(", ")+", "+i.map(f,d).join(", ")+" FROM ( SELECT "+i.map(o,v).join(", ")+") AS new LEFT JOIN"+" (SELECT "+l+", "+f.join(", ")+" FROM "+t.name+") AS old"+" ON "+p(l)+" = "+d(l),args:c}}function c(e){var t=s.getByClassId(e.classId),n=v(t,e);return{sql:"DELETE FROM "+t.name+n.where,args:n.args}}function p(e){var t=s.getByClassId(e.classId),n=i.keys(e.set||{}).map(function(e){return this.getByFieldId(e).name+"=?"},t.fields),r=v(t,e),o=u(t.fields,e.set||{});return{sql:"UPDATE "+t.name+" SET "+n.join(",")+r.where,args:o.concat(r.args)}}function d(t,i){function v(e,t){if(t&&t.rowsAffected){var n=c.referencingElements;n&&n.forEach(function(e){p.executeSql(m(e.referenceField),[f,a])}),l=c.derivedClasses.slice()}c=l.pop(),c?p.executeSql(m(c.idField),[f,a],v):p.done()}function m(e){return"UPDATE "+e.modelClass.name+" SET "+e.name+"=?"+" WHERE "+e.name+"=?"}var o=s.getByClassId(i.classId),u=o.idField.fieldId,a=i.id[u],f=i.set[u],l=[o],c,h=n.cacheTempId(a,f,t),p=new r(t),d=n._mtlXactSqlStatement(n.newMtlResolveTempIdXact(o,a,f));return p.executeSql(d.sql,d.args),v(t),e.whenAll([h,p.promise])}function v(e,t){if(t.id){var n=i.keys(t.id).map(function(e){return this.getByFieldId(e).name+"=?"},e.fields);return{where:" WHERE ("+n.join(" AND ")+")",args:i.values(t.id)}}return{where:"",args:[]}}var n=this;if(!n._model)return e.reject(new Error("Data store does not have a model"));var s=n._model.classes;return n._openPromise.then(function(){return n._db.isTransactionBatchInProgress?o(n._db.inProgressBatchTransaction):n._transaction(function(){return o(n._db.inProgressBatchTransaction)})})},getCount:function(e,t,n){var r=this;return r._openPromise.then(function(){var i=r.getModelClass(e),s=h.parseFilter(t,n,i);return r._fetchCount(i,s)})},_fetchCount:function(e,t){var n=o.buildCountQuery(e,t.filter);return this._db.read(n,t.filterParams).then(function(e){var t=e.rows.item(0);return Number(t[i.keys(t)[0]])})},_readRows:function(e){var n=this;return n._openPromise.then(function(){function a(o){function c(e){var t=r.allFields.getByName(e);a[e]=t.valueFromDb(f[e])}var u=[],a,f;for(var l=0;l<o.rows.length;l++)f=o.rows.item(l),a={},i.keys(f).forEach(c),u.push(a);return t.updateStat("READ",e.className,u.length),e.totalCount?n._fetchCount(r,s).then(function(e){return u.totalCount=e,u}):u}var r=n.getModelClass(e.className),s=h.parseFilter(e.filter,e.filterParams,r),u=o.buildSelectQuery(r,i.extend({},e.queryOptions,s));return n._db.read(u,s.filterParams).then(a)})},insertElement:function(e,n,r){var s=this;return s._openPromise.then(function(){if(!e)throw new Error("No class specified.");if(!n)throw new Error("No values specified.");var o=e.idField,u=n[o.name];if(u)throw new Error(e.name+"."+o.name+" should be undefined ("+JSON.stringify(u)+").");var a={};return i.keys(n).forEach(function(t){var r=e.allFields.getByName(t);a[t]=r.valueToDb(n[t])}),s._dsSettings.generateNextTempId().then(function(n){function l(){var t={};return t[o.name]=n,s.getRow({className:e.name,filter:t})}var u=[],f=!1;return e.inheritance.forEach(function(e){var o={};e.fields.forEach(function(e){var t;e.isIdField()?t=n:t=a[e.name],i.isUndefined(t)||(o[e.name]=t)});var l=i.keys(o),c="INSERT INTO "+e.name+" ("+l.join(",")+") VALUES ("+i.range(l.length).map(function(){return"?"}).join(",")+")";u.push({sql:c,args:i.values(o)});var h=s.newMtlCreateXact(e,o,r);h&&(t.updateStat("CREATE",e.name),u.unshift(s._mtlXactSqlStatement(h)),f=!0)}),s._db.execute(f?s._mtlXactStatementBlock(u):u).then(l)})})},updateElement:function(e,n,r,s){var o=this;return o._openPromise.then(function(){function l(){return o.getRow({className:e.name,filter:a})}if(!e)throw new Error("No class specified.");if(!n)throw new Error("No values specified.");var u=[],a,f=!1;return e.inheritance.forEach(function(e){a=e.getIdFilter(n);var l=e.pluckOwnAttributes(n),c=i.extend({},r,a);i.keys(l).forEach(function(t){if(i.isEqual(l[t],c[t]))delete l[t];else{var n=e.fields.getByName(t);l[t]=n.valueToDb(l[t])}});if(!i.isEmpty(l)){var h=[],p="UPDATE "+e.name+" SET "+o._buildSqlAssignmentArray(l,h).join(",")+" WHERE "+o._buildSqlAssignmentArray(a,h).join(" AND ");u.push({sql:p,args:h});var d=o.newMtlUpdateXact(e,a[e.idField.name],l,s);d&&(t.updateStat("UPDATE",e.name),u.push(o._mtlXactSqlStatement(d)),f=!0)}}),u.length?o._db.execute(f?o._mtlXactStatementBlock(u):u).then(l):l()})},deleteElement:function(n,r,i){function a(t,n,r){return c(t,n,r).then(function(t){if(t){u.push({modelClass:t,id:n});var r=e.when();return t.inheritance.forEach(function(e){r=r.then(function(){return f(e,n)})}),r}return!0})}function f(n,r){var u=[];return n.collections.forEach(function(e){u.push(l(e,r))}),e.whenAll(u).then(function(){o.push({sql:"DELETE FROM "+n.name+" WHERE "+n.idField.name+"=?",args:[r]}),t.updateStat("DELETE",n.name);if(!i){var e=s.newMtlDeleteXact(n,r);o.push(s._mtlXactSqlStatement(e))}})}function l(t,n){function u(e){var t=[],n=e.rows;for(var r=0;r<n.length;r++)t.push(n.item(r).id);return t}function f(t){var n=e.when();return t.forEach(function(e){n=n.then(function(){return a(r,e,!0)})}),n}var r=s._model.classes.getByClassId(t.colClassId),i=r.fields.getByFieldId(t.colParentId),o="SELECT "+r.idField.name+" AS id FROM "+r.name+" WHERE "+i.name+"=?";return s._db.read(o,[n]).then(u).then(f)}function c(t,n,r){function i(){function u(e){return e||c(s,n)}var r=t.derivedClasses,i=e.when(),s;for(var o=0;o<r.length;o++)s=r[o],i=i.then(u);return i.then(function(e){return e||t})}function o(t){var r="SELECT COUNT(*) AS cnt FROM "+t.name+" WHERE "+t.idField.name+"=?";return s._readRow(r,[n]).then(function(t){return t.cnt?t:e.reject(new Error("Record doesn't exist"))})}return e.when(r||o(t),i,function(){return e.resolve(null)})}var s=this,o=[],u=[];return s._openPromise.then(function(){if(!n)throw new Error("No class specified.");if(!r)throw new Error("No filter specified.");var e=r[n.idField.name];if(!e)throw new Error("No id specified.");return a(n,e).then(function(){return o.length?s._db.execute(i?o:s._mtlXactStatementBlock(o)).then(function(){return u}):u})})},cacheTempId:function(e,t,n){var r=this;return r._retrieveTempIdCache().then(function(i){return i.add({sequence:r._dsSettings.inSeqNum(),tempid:e,permid:t}),i.get(e).save(null,{xact:n})})},getTempIdCache:function(){return this._retrieveTempIdCache().then(function(e){var t={};for(var n=0;n<e.length;n++){var r=e.at(n);t[r.get("tempid")]=r.get("permid")}return t})},purgeTempIdCache:function(e){return this._retrieveTempIdCache().then(function(t){return t.purgeTempIdCache(e)})},emptyTempIdCache:function(){return this._retrieveTempIdCache().then(function(e){return e.emptyTempIdCache()})},resolveTempId:function(e){if(!this._tempIdCache)throw new Error("TempIdCache has not been initialized. Please open the store and/or deploy a model.");return this._tempIdCache.resolveTempId(e)},emptyMtlXactLog:function(){var e=this;return e._openPromise.then(function(){return e._db.execute('DELETE FROM "@xacts"')})},getOutgoingMtlXactRecords:function(){var e=this;return e._openPromise.then(function(){return e._db.read('SELECT * FROM "@xacts" WHERE series=? AND posted IS NULL ORDER BY id',[e._dsSettings.inSeriesId()]).then(i.bind(e._extractRowsFromResultSet,e))})},getPostedMtlXactRecordsInSequence:function(e){var t=this;return t._openPromise.then(function(){return t._db.read('SELECT * FROM "@xacts" WHERE series=? AND sequence <= ? AND posted IS NOT NULL ORDER BY id',[t._dsSettings.inSeriesId(),e]).then(i.bind(t._extractRowsFromResultSet,t))})},getAllPostedMtlXactRecords:function(){var e=this;return e._openPromise.then(function(){return e._db.read('SELECT * FROM "@xacts" WHERE series=? AND posted IS NOT NULL ORDER BY id',[e._dsSettings.inSeriesId()]).then(i.bind(e._extractRowsFromResultSet,e))})},postOutgoingMtlXacts:function(e,t){var n=this;return n._openPromise.then(function(){return n._db.execute('UPDATE "@xacts" SET posted = datetime() WHERE series=? AND sequence=?',[e,t])})},purgeOutgoingMtlXacts:function(e,t){return this._db.execute('DELETE FROM "@xacts" WHERE series=? AND sequence <= ?',[e,t])},purgeAllOutgoingXacts:function(){var e=this;return e._openPromise.then(function(){return e._db.execute('DELETE FROM "@xacts" WHERE series= ?',[e._dsSettings.inSeriesId()])})},newMtlSyncXact:function(e){var t={t:l.xactType.Sync,set:{}};return t.set[h.MtlValueIds.inSeriesID]=this._dsSettings.inSeriesId(),t.set[h.MtlValueIds.inSequenceNum]=e,t},newMtlBeginXact:function(){return{t:l.xactType.Begin}},newMtlCreateXact:function(e,t,n){if(n===!0)return null;var r=e.idField.name,s=t[r];return t=i.extend({},t),delete t[r],this._newMtlUpsertXact(l.xactType.Create,e,s,t,n)},newMtlUpdateXact:function(e,t,n,r){return this._newMtlUpsertXact(l.xactType.Update,e,t,n,r)},newMtlDeleteXact:function(e,t){return this._newMtlDataXact(l.xactType.Delete,e,t)},newMtlResolveTempIdXact:function(e,t,n){var r={t:l.xactType.Identity,classId:e.classId,id:{},set:{}},i=e.idField.fieldId;return r.id[i]=t,r.set[i]=n,r},newMtlEndXact:function(){return{t:l.xactType.End}},_importIncomingMtlsFromFs:function(){var t=this;return t._systemTablesPromise.then(function(){return f.listFiles(t._dsInfo.incomingDir(),"*.MTL")}).then(function(n){var r=e.resolve();return i.each(n,function(e){r=r.then(function(){return f.readJsonFileContent(e.path)}).then(i.bind(t._addIncomingMtl,t)).then(function(){return f.deleteFile(e.path)})}),r})},_addIncomingMtl:function(e){var t=this;return t._systemTablesPromise.then(function(){var n;return e instanceof l?n=e:n=l.fromJSON(e),t._db.execute('INSERT OR REPLACE INTO "@incoming" (mtl, seriesId, seqNum, segmentIndex) VALUES (?, ?, ?, ?)',[JSON.stringify(n.toJSON()),n.seriesId,n.seqNum,n.segmentIndex||0])})},deleteIncomingMtl:function(e){var t=this;return t._openPromise.then(function(){return t._systemTablesPromise}).then(function(){var n;return e instanceof l?n=e:n=l.fromJSON(e),t._db.execute('DELETE FROM "@incoming" WHERE seriesId = ? AND seqNum = ? AND segmentIndex = ?',[n.seriesId,n.seqNum,n.segmentIndex||0])})},getIncomingMtl:function(e){function n(e){var t=new l;return t.parse(e.mtl),t}var t=this;return t._openPromise.then(function(){return t._systemTablesPromise}).then(function(){return t._db.readRow('SELECT mtl FROM "@incoming" WHERE seriesId = ? AND seqNum = ? AND segmentIndex = ?',[e.seriesId,e.seqNum,e.segmentIndex||0])}).then(n)},deleteIncomingMtlsNotFromSeries:function(e){var t=this;return t._openPromise.then(function(){return t._systemTablesPromise}).then(function(){return t._db.execute('DELETE FROM "@incoming" WHERE seriesId <> ?',[e])})},getIncomingMtlDescriptors:function(){function t(e){var t=[];for(var n=0;n<e.rows.length;n++)t.push(e.rows.item(n));return t}var e=this;return e._openPromise.then(function(){return e._systemTablesPromise}).then(function(){return e._db.read('SELECT seriesId, seqNum, segmentIndex FROM "@incoming" WHERE seriesId = ? ORDER BY seqNum, segmentIndex',[e._dsSettings.outSeriesId()])}).then(t)},mdoTransaction:function(t){function r(){n._isMtlXactInProgress=!0;var e=n._transaction(function(){return n._db.execute([n._mtlXactSqlStatement(n.newMtlBeginXact())]).then(t).then(function(){return n._db.execute([n._mtlXactSqlStatement(n.newMtlEndXact())])})});return e.always(function(){n._isMtlXactInProgress=!1}),e}var n=this;return i.isFunction(t)?n._openPromise.then(i.bind(n._throwIfXactInProgress,n)).then(r):e.reject(new Error("No mdo transaction callback was specified"))},deployModel:function(t){function s(){if(n._dsSettings.modelId()&&r.modelId!==n._dsSettings.modelId())return e.reject(new Error("MDO.datastore.deployModel: datastore["+n._dsSettings.modelId()+"] != model["+r.modelId+"]"));if(n._dsSettings.modelVersion()&&Number(r.version)<Number(n._dsSettings.modelVersion()))return e.reject(new Error("New model version ("+r.version+") is less than current model version ("+n._dsSettings.modelVersion()+")."))}function o(){return n._dsSettings.model(t).then(function(){return n._dsSettings.modelVersion(r.version)}).then(function(){if(!n._dsSettings.modelId())return n._dsSettings.modelId(r.modelId)})}var n=this,r=u.fromString(t);return n._openPromise.then(s).then(function(){return n._deployNewModelToDb(r)}).then(o).then(i.bind(n._createSystemTables,n)).then(function(){n._setModel(r)})},getDb:function(){return this._db},_performPartialReset:function(){var e=this;return e._db.getTables().then(function(t){var n=[];i.each(t,function(e){if(e.name.charAt(0)==="@")return;n.push('DROP TABLE "'+e.name+'"')});if(n.length)return e._db.execute(n)})},_createSystemTables:function(){return this._systemTablesPromise=this._createXactTable().then(i.bind(this._createIncomingTable,this)).then(i.bind(this._retrieveTempIdCache,this)),this._systemTablesPromise},_createXactTable:function(){var e='CREATE TABLE IF NOT EXISTS "@xacts" (id INTEGER PRIMARY KEY ASC, series TEXT NOT NULL, sequence INTEGER NOT NULL, version INTEGER NOT NULL, posted TIMESTAMP, xact TEXT NOT NULL, ts TIMESTAMP DEFAULT CURRENT_TIMESTAMP)';return this._db.execute(e)},_createIncomingTable:function(){function t(t){var n='CREATE TABLE "@incoming" (mtl NOT NULL, seriesId TEXT NOT NULL COLLATE NOCASE, seqNum INTEGER NOT NULL, segmentIndex INTEGER NOT NULL DEFAULT 0, UNIQUE(seriesId, seqNum, segmentIndex))';if(!t)return e._db.execute(n);if(t.sql.indexOf("segmentIndex")<0)return e._db.transaction(function(e){e.executeSql('ALTER TABLE "@incoming" RENAME TO "@incoming_temp"'),e.executeSql(n),e.executeSql('INSERT INTO "@incoming" (mtl, seriesId, seqNum) SELECT mtl, seriesId, seqNum FROM "@incoming_temp"'),e.executeSql('DROP TABLE "@incoming_temp"')})}var e=this;return e._db.tableExists("@incoming").then(t)},_deployNewModelToDb:function(e){var t=this,n=[];if(t._model){var r=t._model.compareTo(e);i.each(r.classesToCreate,function(t){var r=e.classes.getByClassId(t),i=r.getSchema();a.log("Creating table '"+r.name+"'"),n.push(i)}),i.each(r.classesToDelete,function(e){var r=t._model.classes.getByClassId(e);a.log("Dropping table '"+r.name+"'");var i="DROP TABLE "+r.name;n.push(i)}),i.each(r.classesToAlter,function(r){var s=t._model.classes.getByClassId(r);a.log("Updating table '"+s.name+"'");var o='"@'+s.name+'"',u=s.getSchema(o);n.push(u);var f="INSERT INTO "+o+" SELECT * FROM "+s.name;n.push(f),u="DROP TABLE "+s.name,n.push(u);var l=e.classes.getByClassId(r);u=l.getSchema(),n.push(u);var c=i.intersection(i.pluck(l.fields,"fieldId"),i.pluck(s.fields,"fieldId"));if(c&&c.length){var h=i.map(c,function(e){return s.fields.getByFieldId(e).name}).join(", "),p=i.map(c,function(e){return l.fields.getByFieldId(e).name}).join(", ");f="INSERT INTO "+l.name+"("+p+") SELECT "+h+" FROM "+o,n.push(f)}u="DROP TABLE "+o,n.push(u)})}else for(var s=0;s<e.classes.length;s++)n.push(e.classes[s].getSchema());if(n.length)return t._db.execute(n)},_buildSqlAssignmentArray:function(e,t){t=t||[];var n=[];return i.keys(e).forEach(function(r){n.push(r+"=?"),t.push(e[r])}),n},_extractRowsFromResultSet:function(e){var t=[];for(var n=0;n<e.rows.length;n++)t.push(e.rows.item(n));return t},_mtlXactSqlStatement:function(e){return{sql:'INSERT INTO "@xacts" (series, sequence, version, xact) VALUES (?, ?, ?, ?)',args:[this._dsSettings.inSeriesId(),this._dsSettings.inSeqNum(),this._model.version,JSON.stringify(e)]}},_mtlXactStatementBlock:function(e){return e.length>2&&!this._isMtlXactInProgress&&(e.unshift(this._mtlXactSqlStatement(this.newMtlBeginXact())),e.push(this._mtlXactSqlStatement(this.newMtlEndXact()))),e},_newMtlUpsertXact:function(e,t,n,r,s){var o=i.keys(r);s&&(o=i.difference(o,s));if(e!==l.xactType.Create&&i.isEmpty(o))return null;var u=this._newMtlDataXact(e,t,n,s),a,f;return i.forEach(o,function(e){var n=t.fields.getByName(e),s=h.dbToMtlValue(n,r[e]);n.element&&!i.isNull(s)&&(s=Number(s)),n.element&&s<0?(f=f||(u[c.foreignTempId]={}),f[n.fieldId]=s):(a=a||(u.set={}),a[n.fieldId]=s)}),u},_newMtlDataXact:function(e,t,n,r){var i={t:e,classId:t.classId};r===!0&&(i.localOnly=!0),n=Number(n);var s={};s[t.idField.fieldId]=n;var o=c.permanentId;return n<0&&(o=t.baseClass?c.bothTempId:c.primaryTempId),i[o]=s,i},_readRow:function(e,t){return this._db.read(e,t).then(function(e){if(e.rows.length!==1)throw new Error("Query returned "+e.rows.length+" rows");return e.rows.item(0)})},_throwIfXactInProgress:function(){if(this._isMtlXactInProgress)throw new Error("A transaction is already in progress")},transaction:function(e){return this._openPromise.then(i.bind(this._transaction,this,e))},importIncomingMtlsFromFs:function(){return this._openPromise.then(i.bind(this._importIncomingMtlsFromFs,this))},addIncomingMtl:function(e){return this._openPromise.then(i.bind(this._addIncomingMtl,this,e))}},{MtlValueIds:{inSeriesID:"4",inSequenceNum:"5",outSeriesID:"6",outSeqNum:"7"}});return h}),define("Data/Server",["AH","MDO/Stats","underscore","./Store","lib/Class","Constants"],function(e,t,n,r,i,s){"use strict";var o=0,u=i.extend({constructor:function(e,t){this._store=e,this._httpServer=t},getRow:function(t){function n(n){if(n.length===1)return n[0];var r=new Error(n.length+" rows matched for '"+t.className+"' WHERE "+JSON.stringify(t.filter));return r.mdoCode=n.length<1?s.errorCodes.dataNotFound:s.errorCodes.dataNotUnique,e.reject(r)}return this.getRows(t).then(n)},getRows:function(e){var i=this;return i._store.open().then(function(){function f(i){function l(e){var t=s.allFields.getByName(e);a[e]=t.valueFromDb(r.mtlToDbValue(t,u[e]))}var o=[],u,a;for(var f=0;f<i.rows.length;f++)u=i.rows[f],a={},n.keys(u).forEach(l),o.push(a);return n.isUndefined(i.count)||(o.totalCount=i.count),t.updateStat("READ-SERVER",e.className,o.length),o}var s=i._store.getModelClass(e.className),u=r.parseFilter(e.filter,e.filterParams,s,!0),a={dataStoreId:i._store.dataStoreInfo.id(),className:e.className,queryOptions:n.extend({},e.queryOptions,u,{getRows:!0,getCount:e.totalCount})};return o++,i._httpServer.query(a,e.timeout).then(f)})},getCount:function(e){var i=this;return i._store.open().then(function(){function f(n){var r=n.count;return t.updateStat("READ-SERVER",e.className,1),r}var s=i._store.getModelClass(e.className),u=r.parseFilter(e.filter,e.filterParams,s,!0),a={dataStoreId:i._store.dataStoreInfo.id(),className:e.className,queryOptions:n.extend({},e.queryOptions,u,{getCount:!0})};return o++,i._httpServer.query(a,e.timeout).then(f)})},session:function(e,t){return this._httpServer.session(e,t)}},{queryCount:function(){return o}});return u}),define("MDO/Datastore",["AH","underscore","./AsyncEvents","Files/fs","Logging/logger","Files/Mtl","Files/Mtc","DataModel/Model","Data/Store","Data/Server","Constants","Messages/Message"],function(e,t,n,r,i,s,o,u,a,f,l,c){"use strict";var h;return function(u,p){function b(){return g.always(function(){var t=[];return t.push(r.deleteDirectory(u.directory()).then(null,function(){return e.resolve()})),t.push(d.destroy()),e.whenAll(t)})}function w(){return g!==m?g:(g=d.open(),g.then(function(){y=!0},E),g)}function E(){function n(){return d.close()}var t=this;return g=m,y=!1,n().then(function(){return e.resolve(t)})}function S(e){function t(){return d.deployModel(e)}return g.then(t)}function x(){if(!y)throw new Error("Datastore is closed")}function T(e){if(!this.model)throw new Error("Model not deployed");if(!this.model.classes.getByName(e))throw new Error("Invalid class name: "+e);return!0}function N(e){function r(){return d.getTempIdCache()}function i(r){return t=r,C(t,e).then(function(e){n=e})}function o(){return d.getAllPostedMtlXactRecords().then(a)}function u(){return d.getOutgoingMtlXactRecords().then(a)}function a(n){var r=O(n,t,e),i=new s;return i.insertXacts(r,0),d.applyMtlXacts(i)}var t,n;return g.then(r).then(i).then(o).then(u).then(function(){return n&&h.asyncTrigger("processedXacts")})}function C(n,r){function i(e){return e.length>0?h.asyncTrigger("processingXacts").then(function(){return e}):e}function s(i){var s=t.groupBy(i,"seqNum"),o=e.resolve(),u={count:0,total:t.reduce(t.values(s),function(e,t){return e+t.length},0)},a=t.keys(s);return a.sort(function(e,t){return e-t}),t.forEach(a,function(e){var t=s[e];o=o.then(function(){var e=L(t,n,u,r);return e})}),o.then(function(){return i.length>0})}return d.getIncomingMtlDescriptors().then(i).then(s)}function k(){return x(),d.model}function L(n,r,i,o){return g.then(function(){function m(t){return t?d.applyMtlXacts(t):e.resolve()}function g(e){t.keys(e.set||{}).forEach(function(t){var n=e.set[t];switch(t){case a.MtlValueIds.outSeqNum:h=n;break;default:throw new Error("Unexpected MTL Datastore Setting: "+t+"="+n)}})}function y(n){function m(){var t;if(t=u.classes.getByClassId(f.classId)){var n=t.idField.fieldId,i=f.id[n],s=f.set[n];v=e.when(v,function(){r[i]=s})}}function y(t,i){v=e.when(v,function(){return d.getPostedMtlXactRecordsInSequence(t).then(function(e){var t=O(e,r,o);i+=c,n.insertXacts(t,i),c+=t.length})})}if(!n)return e.resolve();h<n.seqNum+1&&(h=n.seqNum+1);var i=0,f,l,c=0,v=null;while(f=n.getXact(i++)){l=u.classes.getByClassId(f.classId);if(f.classId&&!l)i-=1,n.deleteXact(i);else switch(f.t){case s.xactType.Sync:p=f.set[a.MtlValueIds.inSequenceNum],y(p,i-1);break;case s.xactType.Setting:g(f),i-=1,n.deleteXact(i);break;case s.xactType.Identity:m();break;case s.xactType.Create:case s.xactType.CreateValidate:A(f,l);break;case s.xactType.Update:A(f,l),t.isEmpty(f.set)&&(i-=1,n.deleteXact(i));break;default:}}return e.when(v,function(){return n})}function b(){return f.outSeqNum(h)}var u=k(),f=d.settings,h=f.outSeqNum(),p;i=i||{count:0,total:n.length};var v=t.reduce(n,function(t,n){function s(){return o().then(y).then(m).then(a)}function o(){return d.getIncomingMtl(n).then(function(t){return t.seriesId!==f.outSeriesId()?e.reject(new Error("MTL series '"+t.seriesId+"' does not match OutSeriesId '"+f.outSeriesId()+"'")):t.seqNum<f.outSeqNum()?(r=t,j("Skipping server change '"+n.seriesId+"."+n.seqNum+".MTL' ["+n.segmentIndex+"] because it has already been applied"),null):t.seqNum!==f.outSeqNum()?e.reject(new Error("MTL sequence '"+t.seqNum+"' does not match OutSeqNum '"+f.outSeqNum()+"'")):t.modelVersion>u.version?e.reject(new Error("MTL model version ("+t.modelVersion+") is greater than the deployed model version ("+u.version+")")):r=t})}function a(){return d.deleteIncomingMtl(r)}var r;return t.then(function(){return i.count+=1,j("Applying server change '"+n.seriesId+"."+n.seqNum+".MTL' ["+n.segmentIndex+"]..."),e.notify(c.getMessage(l.messageCodes.applyingServerChanges,i.count,i.total),s())})},e.resolve());return v=v.then(b),v})}function A(e,n){t.each(t.keys(e.set||{}),function(t){n.fields.getByFieldId(t)||delete e.set[t]})}function O(e,n,r){var i=[];return e.forEach(function(e){function a(e,r){t.keys(e).forEach(function(t){var i=e[t];r[t]=n[i]||i})}var o=JSON.parse(e.xact);if(r&&o.localOnly)return;switch(o.t){case s.xactType.Sync:case s.xactType.Identity:return;case s.xactType.Create:o.t=s.xactType.LocalCreate;case s.xactType.Update:case s.xactType.Delete:var u=h.model.classes.getByClassId(o.classId);if(!u)return;if(o.ptmp||o.btmp)o.id=o.id||{},a(t.extend({},o.ptmp,o.btmp),o.id);o.ftmp&&(o.set=o.set||{},a(o.ftmp,o.set)),o.set&&A(o,u);if(o.t===s.xactType.Update&&t.isEmpty(o.set))return;if(!r&&o.t===s.xactType.LocalCreate&&o.id[u.idField.fieldId]<0)return;break;case s.xactType.Begin:case s.xactType.End:return;default:console.log("insertPosted: UNEXPECTED "+JSON.stringify(o));return}i.push(o)}),i}function M(){function e(e){var t=[],n;return e.forEach(function(e){if(!n||n.seqNum!==e.sequence)n=new s,n.modelId=d.settings.modelId(),n.modelVersion=e.version,n.seriesId=e.series,n.seqNum=e.sequence,t.push(n),n.addXact(d.newMtlSyncXact(e.sequence));var r=JSON.parse(e.xact);r.localOnly||n.addXact(r)}),t}return g.then(function(){return d.getOutgoingMtlXactRecords()}).then(e)}function D(t){function n(n){if(n.length===0)return undefined;var i=n.reduce(function(n,i){function s(){var e=new o;return e.fileName=i.seriesId+"."+i.seqNum+".mtc",e.type="DataSync",e.version=i.seqNum,e.contentId=i.seriesId,e.destinationId=d.settings.id(),e.targetId=d.settings.id(),e.addFile(i.seriesId+"."+i.seqNum+".mtl","TransactionLog",i.toJSON()),r.writeFile(t,e.fileName,JSON.stringify(e),!0).then(function(){return i.seqNum})}function u(){return d.postOutgoingMtlXacts(i.seriesId,i.seqNum)}function a(){return d.settings.inSeqNum(i.seqNum+1)}return e.when(n).then(s).then(u).then(a)},e.resolve());return j("Preparing to upload "+n.length+" file(s)..."),e.notify(c.getMessage(l.messageCodes.preparingUpload),i)}return g.then(M).then(n)}function P(e){function t(){return d.mdoTransaction(e)}return g.then(t)}function H(e){function t(){return v.getRows(e)}function n(){return d.getRows(e)}return g.then(function(){return e.fromServer?t():n()})}function B(e){return g.then(function(){return e.fromServer?v.getCount(e):d.getCount(e.className,e.filter,e.filterParams)})}function j(e,n){i.log(e,t.extend({domainId:u.id(),category:"INFO"},n))}var d=new a(u),v=new f(d,p),m=e.reject(new Error("Datastore is closed")),g=m,y=!1;return h={open:w,close:E,deployModel:S,processDataSyncs:N,prepareOutgoingMtcs:D,getRows:H,getCount:B,destroy:b,validateClassName:T,dsInfo:u,mdoTransaction:P,_internal:{applyIncomingMtlGroup:L,prepareOutgoingMtls:M}},Object.defineProperties(h,{store:{get:function(){return d}},server:{get:function(){return v}},vault:{get:function(){return x(),d.vault}},model:{get:k},settings:{get:function(){return x(),d.settings}},isOpen:{get:function(){return y}}}),t.extend(h,n)}}),define("MDO/Domain",["underscore","backbone","LocalStorage/Domain","LocalStorage/Datastore","Http/Server","./Datastore","./Error","Files/fs","Logging/logger","Files/Mtc","AH","Constants","Messages/Message"],function(e,t,n,r,i,s,o,u,a,f,l,c,h){"use strict";function v(n){function m(){function t(){var t=[];return n&&e.each(n.dataStoreIds(),function(e){P(l.format("Removing datastore:  {0}",e)),t.push(x(e))},this),l.whenAll(t)}return t().then(function(){P(l.format("Removing domain: {0}",n.name())),n.remove(),p=undefined})}function y(e){var t=f[e];if(!t){var r=n.getDatastoreById(e);if(r)return f[e]=t=new s(r,new i(n.serverUrl(),b)),t}return t}function b(){return{domainId:n.id(),userId:n.userId(),user:n.user(),password:v,deviceSharing:n.device()?c.deviceSharing.existingUser:c.deviceSharing.none}}function w(e){var t=n.getNumDatastores();for(var r=0;r<t;r++){var i=n.getDatastore(r);if(i.name()===e)return g(i.id())}return null}function E(){var e=n.getNumDatastores();if(!e)throw new Error("No datastores");if(e>1)throw new Error("Cannot determine default datastore ("+e+" datastores)");return g(n.getDatastore(0).id())}function S(e){if(!e)throw new Error("MDO.Domain.addDatastore: settings not specified");if(!e.id)throw new Error("MDO.Domain.addDatastore: id not specified");if(!e.name)throw new Error("MDO.Domain.addDatastore: name not specified");var t=n.addDatastore(e.id);t.id(e.id),t.name(e.name)}function x(e){var t=g(e);return t.destroy().then(function(){return delete f[e],n.removeDatastore(e)})}function T(){function t(t){function n(e,n,r){function s(){return u.deleteFile(n.dir,n.name)}function o(){return u.readJsonFileContent(n.path)}P("Extracting '"+n.name+"' ("+n.size+" bytes)...");var i=l.when(e).then(o).then(N).then(s);return l.notify(h.getMessage(c.messageCodes.extractingFile,r+1,t.length),i)}return t.length?(P(t.length+" files(s) to extract:"),e.reduce(t,n,l.resolve())):!1}return u.listFiles(n.incomingDir()).then(t)}function N(e){switch(e.descriptor.type){case"DataStore":case"DataSync":case"Settings":return C(e);default:return l.reject(new Error("Unknown MTC type: "+e.descriptor.type))}}function C(t){function h(e){if(!l.isDefined(e))return l.reject(new o("Cannot process null file",c.errorCodes.invalidFile));if(e.type==="DataModel")return p(e);if(e.type==="DataStoreSettings")return d(e);if(e.type==="TransactionLog")return v(e);e.type==="Segmented"}function p(e){var t=n.getDSDeploymentModelDir(i,e.version);return u.writeJsonFile(t,e.fileName,e,!0)}function d(e){return u.writeJsonFile(n.dsDeploymentsDir(),e.fileName,e,!0)}function v(e){var t=g(i);s&&(e.segmentIndex=s);if(t)return t.open(),t.store.addIncomingMtl(e);var n=r.getIncomingDir(i),o=s?s+"."+e.fileName:e.fileName;return u.writeJsonFile(n,o,e,!0)}var i=t.descriptor.contentId,s=t.segmentIndex,a=t.files,f=l.resolve();return e.each(a,function(e){f=f.then(function(){return h(e)})}),f}function L(){return O().reduce(function(t,n,r){return n.open(),t.then(e.bind(n.processDataSyncs,n))},l.resolve())}function A(){function t(){e&&d.trigger(c.connectionEvents.dataReset)}var e;return M().then(function(t){e=t}).then(k).then(function(){if(e)return l.whenAll(O().map(function(e){return e.store.deleteIncomingMtlsNotFromSeries(e.settings.outSeriesId())}))}).then(t,function(e){return t(),l.reject(e)})}function O(){return(n.dataStoreIds()||[]).map(g,this)}function M(){function r(t){function n(e,t){function n(){return u.readJsonFile(t.path)}return e.then(n).then(i)}return e.reduce(t,n,l.resolve())}function i(r){function m(){return a&&(s=n.addDatastore(o.dataStoreId),s.name(o.name)),i=g(s.id()),i.open().then(function(){d=!a&&o.inSeriesId&&i.settings.inSeriesId()!==o.inSeriesId,d&&(t=!0)})}function y(){return a?i.store.importIncomingMtlsFromFs():!1}function b(){if(!f){var e=n.getDSDeploymentModelPath(o);return u.readFile(e).then(function(e){return v=e.content})}}function w(){return d?u.deleteFiles(n.outgoingDir(),i.settings.outgoingMtcFilePattern).then(e.bind(i.store.emptyTempIdCache,i.store)).then(e.bind(i.store.purgeAllOutgoingXacts,i.store)):l.resolve()}function E(){var e=[];if(a||d)e.push(i.settings.inSeriesId(o.inSeriesId)),e.push(i.settings.inSeqNum(o.inSequenceNumber));return e.push(i.settings.outSeriesId(o.outSeriesId)),e.push(i.settings.outSeqNum(o.outSequenceNumber)),e.push(i.settings.modelId(o.modelId)),l.whenAll(e)}function S(){return!a&&p?(P("Resetting database..."),l.notify(h.getMessage(c.messageCodes.resettingDatabase),i.store.reset(!0))):l.resolve()}function x(){return v?(P("Deploying database..."),l.notify(h.getMessage(c.messageCodes.deployingDatabase),i.deployModel(v))):l.resolve()}function T(){return i.processDataSyncs(p||f)}function N(){function e(){var e=n.getDSDeploymentModelDir(o.dataStoreId,o.modelVersion);return u.deleteDirectory(e)}function t(){return u.deleteFile(r.path)}return e().then(t)}var i,s,o=r.content,a,f=o.deploymentType==="Create"&&!o.inSeriesId,p=o.deploymentType==="Create"&&!f||o.deploymentType==="CreateIfMissing",d,v;return l.deferredTryCatch(function(){s=n.getDatastoreById(o.dataStoreId),a=!s;if(a&&!p)throw new Error("Device is not installed!");return m().then(y).then(b).then(w).then(function(){return i.store.transaction(function(){return E().then(S).then(x).then(T)})}).then(N)})}var t=!1;return u.listFiles(n.dsDeploymentsDir(),null,u.pathSeqNumCompare).then(r).then(function(){return l.resolve(t)})}function D(){return n.dataStoreIds()?n.dataStoreIds().reduce(function(e,t){return l.when(e,function(){var e=g(t);return e.open(),e.prepareOutgoingMtcs(n.outgoingDir())})},l.resolve()):l.resolve()}function P(t,r){return a.log(t,e.extend({},{domainId:n.id(),category:"INFO"},r))}function H(t,r){return a.logError(t,e.extend({},{domainId:n.id()},r))}var f={},v,g=y,k=L;return d={destroy:m,addDatastore:S,getDefaultDatastore:E,removeDatastoreById:x,getDatastoreByName:w,extractIncoming:T,extractMtc:N,processIncomingFiles:A,prepareOutgoingFiles:D,logMessage:P,logError:H,domInfo:n,_internal:{extractMtcFiles:C}},e.extend(d,t.Events),Object.defineProperties(d,{getDatastoreById:{get:function(){return g},set:function(e){g=e}},serverPassword:{set:function(e){v=e},get:function(){throw new Error("password cannot be read")}}}),Object.defineProperties(d._internal,{processDataSyncs:{get:function(){return k},set:function(e){k=e}}}),d}function m(e){var t=p?p.domInfo:n.retrieve();return t?e&&t.name()!==e&&t.id()!==e?null:(p||(p=new v(t)),p):null}function g(e){if(m())throw new Error("MdoDomain.create: another domain already exists");var t=n.create();return t.name(e.domain),t.id(e.domainId),e.sharedDevice?t.device(e.user):t.saveCredentials(e.user,e.password),t.userId(e.userId),t.serverUrl(e.serverUrl),p=new v(t),p}var p,d;return v.create=g,v.retrieve=m,v}),define("MDO/QueryIncludeMixin",["underscore"],function(e){"use strict";return{queryInclude:function(t,n){function a(e,t){u.includedRefs[e]=u._mergeFieldsToFetch(u.includedRefs[e],t)}var r=t.split("."),i=this.mdoClass,s="",o=e.extend({fields:!0},n),u=this;return this.includedRefs=this.includedRefs||{},e.forEach(r,function(e){var t=i.allElements.getByName(e,!0);i=t.refClass,a(s,[t.referenceField.name]),s&&(s+="."),s+=e},this),a(s,o.fields),this},_mergeFieldsToFetch:function(t,n){if(t!==!0&&n)return n===!0?!0:t?e.union(t,n):n;return t},_getFetchOptions:function(t,n){if(!this.includedRefs)return n;var r=e.extend({fields:!0},n);return r.fields=this._mergeFieldsToFetch(r.fields,this.includedRefs[t]),r.fields===!0&&(n?delete r.fields:r=n),r}}}),define("MDO/Element",["underscore","backbone","AH","Constants","./Error","./QueryIncludeMixin"],function(e,t,n,r,i,s){"use strict";var o=t.Model.extend({localOnlyFields:null,initialize:function(t,n){n=n||{},this._state=n.collection?r.elementStates.saved:r.elementStates.new,this.originalAttributes=e.clone(t)},toString:function(){return this.mdoClass.name+"{"+(this.id||"")+"}"},set:function(n,i){if(!e.isObject(n)){var s={};s[arguments[0]]=arguments[1],n=s,i=arguments[2]}else n=e.clone(n);i=e.extend({validate:!0},i);if(i.validate){var o=this.mdoClass.allFields;e.forEach(n,function(e,t){var r=o.getByName(t,!1);r&&(n[t]=r.normalizeValue(e))},this)}delete this._error;var u=t.Model.prototype.set.call(this,n,i);if(this._error)throw this._error instanceof Error?this._error:new Error(this._error);return this._state===r.elementStates.saved&&this.hasChanged()&&(this._state=r.elementStates.changed),u},get:function(e){var n=null,s=e.indexOf(".");if(s>-1){n=e.substring(s+1),e=e.substring(0,s);if(!n||!e)throw new i("Invalid Merged Reference: "+e,r.errorCodes.invalidMergedReference)}var u=this.mdoClass.getEltOrFieldByName(e,!1);if(!u)throw new i(this._createFieldValidationError(e,"Invalid field name"),r.errorCodes.unknownFieldOrElement);if(!u.refClassId){if(n)throw new i(this._createFieldValidationError(e,"Invalid merged reference ("+e+"."+n+") - field is not an element reference"),r.errorCodes.invalidMergedReference);var a=t.Model.prototype.get.call(this,e);return a=u.element||e===this.idAttribute?this._ds.store.resolveTempId(a):a,a}var f=this[e];if(f===null||f instanceof o)return n?f===null?undefined:f.get(n):f;throw new i(this._createFieldValidationError(e,"Could get element reference because element was not fetched. Did you queryInclude() ?"),r.errorCodes.invalidMergedReference)},original:function(e){return this.originalAttributes?this.originalAttributes[e]:undefined},trigger:function(e,n,r){return e==="invalid"&&(this._error=r),t.Model.prototype.trigger.apply(this,arguments)},validate:function(t,r){var i,s,o,u,a,f=this.mdoClass,l=e.keys(t),c=r&&r.validateAllowNull;for(u=0;u<l.length;u++){i=l[u],o=f.allFields.getByName(i,!1);if(!o)return this._createFieldValidationError(i,"Invalid field name");if(c)continue;s=t[i],a=this._validateFieldValue(o,s,!1);if(a)return a}if(c)for(u=0;u<f.allFields.length;u++){o=f.allFields[u],i=o.name,s=t[i];if(o.isIdField()&&!n.isDefined(s))continue;a=this._validateFieldValue(o,s,!0);if(a)return a}},_validateFieldValue:function(e,t,r){var i=e.name;if(this.original(i)!==t&&this._isReadOnlyField(e))return this._createFieldValidationError(i,"Invalid assignment to readonly field");if(r||n.isDefined(t)){var s=e.validateValue(t);if(s)return this._createFieldValidationError(i,"Invalid field value - "+s)}},_createFieldValidationError:function(e,t){return t+" ("+this.mdoClass.name+"."+e+")"},_isReadOnlyField:function(e){return!1},fetch:function(n){var r=t.Model.prototype.fetch.call(this,e.extend({validate:!1},this._getFetchOptions("",n)));return this.includedRefs?r.then(e.bind(this._fetchRefs,this)):r},save:function(r,i,s){var o;return e.isObject(r)||!n.isDefined(r)?(o=r,s=i):(o={},o[r]=i),n.deferredTryCatch(function(){return t.Model.prototype.save.call(this,o||{},e.extend({validateAllowNull:!0},s))},this)},resolve:function(){return this.fetch({resolve:!0})},getCollection:function(e,t){var n=e.replace(/\[\]$/,""),r=this.mdoClass.allCollections.getByName(n,!0),i=this._mdoCon.createCollection(r.colClass.name),s=r.colClass.allFields.getByFieldId(r.colParentId,!0),o="$"+s.name+" = "+(this.id||0),u=[];return t&&t.queryFilter&&(u=t.args,o=o+" and ("+t.queryFilter+")"),i.queryFilter(o,u),i},fetchCollection:function(t,r){return r=e.extend({},r),n.deferredTryCatch(function(){function v(e,t){var n=0;for(;n<e.length&&!e[n].match(/\[\]$/);n++){var r=t.allElements.getByName(e[n],!1);if(!r)break;t=r.refClass}return n}function m(e,t){return e.allElements.getByName(t,!0).refClass}function g(e,t){return e.allCollections.getByName(t.replace(/\[\]$/,""),!0)}function y(t,n){var r=[];return e.reduce(t,function(e,t){var n=g(e,t);return r.push(n),n.colClass},n),r}function b(e,t){return e+"."+t.colParent.element.name}if(!t)throw new Error("No collection specified");var i=t.split("."),s=v(i,this.mdoClass),o=i.slice(0,s),u=i.slice(s),a=e.reduce(o,m,this.mdoClass),f;o.length===0?this.PKey?f=n.resolve(this):f=n.resolve(null):f=this.fetchElement(o.join("."));var l=y(u,a),c=l[l.length-1].colClass,h=e.reduceRight(l,b,"");h="$"+h.substr(1)+" = ";var p=this._mdoCon.createCollection(c.name),d=[];return r.queryFilter&&(h="("+r.queryFilter+") and "+h,d=r.args||d,delete r.queryFilter,delete r.args),n.when(f,function(e){return h+=e&&e.id||0,p.queryFilter(h,d),r.querySort&&(p.querySort(r.querySort),delete r.querySort),p.fetch(r)})},this)},getElement:function(e){if(e.indexOf(".")>-1)throw new i("Merged references are not supported by getElement(): "+e,r.errorCodes.mergedRefNotSupported);var t=this.mdoClass.allElements.getByName(e,!0),n=t.referenceField,s=this.get(n.name);if(s===undefined)throw new i("'"+e+"' could not be found because the '"+n.name+"' field was not fetched",r.errorCodes.refFieldNotFetched);if(!s)return null;var o=t.refClass,u=this._mdoCon.createElement(o.name);return u.set(o.idField.name,s),u},fetchElement:function(t){return n.deferredTryCatch(function(){var r=t.split(".");return e.reduce(r,function(e,t){return n.when(e,function(e){function i(e){return e.message.match(/0 rows matched for/i)?n.resolve(null):e}if(e===null)return null;var r=e.getElement(t);return r!==null?r.fetch().then(null,i):null})},n.resolve(this))},this)},_fetchRefs:function(){if(!this.includedRefs)return this;var t=this.mdoConnection.createCollection(this.mdoClass.name);return t.includedRefs=this.includedRefs,t.models.push(this),t._fetchRefs().then(e.bind(e.identity,null,this))},idEquals:function(t){return Boolean(this&&t&&this.id&&this._ds.store.resolveTempId(this.id)===this._ds.store.resolveTempId(t.id)&&e.last(this.mdoClass.inheritance)===e.last(t.mdoClass.inheritance))},sync:function(t,i,s){function l(t){return u.originalAttributes=e.clone(t),s.success(t),u._state=r.elementStates.saved,n.resolve(u)}function c(e){return a=e,s.success(f),u._state=r.elementStates.deleted,n.resolve(u)}function h(e){return n.normalizeWebSqlError(e),s.error&&s.error(u,e,s),n.reject(e)}var o=this._ds,u=this,a,f=this._syncAttributes(this.resolveTempIds(this.attributes));switch(t){case"read":return n.deferredTryCatch(function(){var e=s.resolve?this.mdoClass.getFieldFilter(f):this.mdoClass.getIdFilter(f);return o.store.getRow({className:this.mdoClass.name,filter:e,queryOptions:{fields:s.fields}}).then(l,h)},this);case"update":return o.store.updateElement(this.mdoClass,f,this.resolveTempIds(this.originalAttributes),this._getLocalOnly(s.localOnly)).then(l,h).then(function(){return u._mdoCon.onDataUpdated(r.connectionEvents.dataModified,u,s),u});case"delete":return o.store.deleteElement(this.mdoClass,f,Boolean(s.localOnly)).then(c,h).then(function(){return u._mdoCon.onDataUpdated(r.connectionEvents.dataDeleted,a,s),u});case"create":return o.store.insertElement(this.mdoClass,f,this._getLocalOnly(s.localOnly)).then(l,h).then(function(){return u._mdoCon.onDataUpdated(r.connectionEvents.dataAdded,u,s),u});default:return n.reject(new Error("MDO.Element sync method not implemented: "+t))}},_getLocalOnly:function(t){return t===!0?!0:e.isArray(t)?this.localOnlyFields?t.concat(this.localOnlyFields):t:this.localOnlyFields},_isReference:function(e){var t=this.mdoClass.allFields.getByName(e);return t&&t.element},resolveTempIds:function(t){var n={};return Object.keys(t).forEach(e.bind(function(e){e===this.idAttribute||this._isReference(e)?n[e]=this._ds.store.resolveTempId(t[e]):n[e]=t[e]},this)),n},_syncAttributes:function(e){return e}});return e.extend(o.prototype,s),Object.defineProperty(o.prototype,"mdoClass",{get:function(){return this._class}}),Object.defineProperty(o.prototype,"mdoConnection",{get:function(){return this._mdoCon}}),Object.defineProperty(o.prototype,"mdoState",{get:function(){return this._state}}),o}),define("MDO/FileElement",["underscore","AH","Constants","Logging/logger","./Element","Files/fileSystem","./Error"],function(e,t,n,r,i,s,o){"use strict";var u=i.extend({localOnlyFields:["ahLastDownloadTS","ahDownloadVersion","ahFilePath","ahSourcePath"],sync:function(e,n,r){function a(){return u=i.prototype.sync.apply(s,o),u}function f(){var n;switch(e){case"create":n=l();break;case"update":s._fileData&&(n=l());break;case"delete":n=c();break;case"read":break;default:throw new Error("Invalid sync method: "+e)}return t.when(n).then(function(){delete s._fileData,delete s._fileVersion,delete s._fileDownloadTs})}function l(){return s._ds.vault.addFile(s._fileData,s.mdoClass,s.ahFileName).then(null,function(e){var n=new Error("Failed to save file attachment to the vault. The element may be in an inconsistent state.");return n.exception=e,t.reject(n)})}function c(){return s._ds.vault.removeFile(s.mdoClass,s.ahFileName,!0)}var s=this,o=arguments,u;return a().then(f).then(function(){return u})},_syncAttributes:function(e){return this._fileVersion&&(e.ahLocalVersion=this._fileVersion),this._fileDownloadTs?(e.ahLastDownloadTS=this._fileDownloadTs,e.ahCurrentUploadTS=null):this._fileData&&(e.ahCurrentUploadTS=new Date),e},save:function(){function s(){if(e.isNew()&&!e._fileData){var n=new Error("Cannot save a new element without first attaching a file. Make sure to call 'setFile'.");return t.reject(n)}return t.resolve()}function u(){return e.isNew()&&!e.ahFileName?t.reject(new o("Cannot save a new element without specifying a file name.",n.errorCodes.fileNameMissing)):t.resolve()}function a(){if(!e.isNew())return!1;var r=e._ds.store.database,i="SELECT COUNT(*) as count FROM "+e.mdoClass.name+" WHERE ahFileName = ?";return r.read(i,[e.ahFileName]).then(function(r){var i=r.rows.item(0).count;if(i>0)return t.reject(new o("An element with an 'ahFileName' of '"+e.ahFileName+"' already exists.",n.errorCodes.fileNotUnique))})}var e=this,r=arguments;return s().then(u).then(a).then(function(){return i.prototype.save.apply(e,r)})},setFile:function(t,r){if(!t)throw new o("'data' must be specified.",n.errorCodes.invalidArgs);if(r&&!e.isString(r))throw new o("'filename' must be a valid string.",n.errorCodes.invalidArgs);if(r&&r!==this.ahFileName&&!this.isNew())throw new o("Cannot change file name on an existing element.",n.errorCodes.notSupported);if(t instanceof Blob)return r&&(this.ahFileName=r),this._fileData=t,this.trigger(n.dataEvents.fileSet,this._fileData),delete this._fileVersion,delete this._fileDownloadTs,this;throw new o("'data' is of an unsupported type.",n.errorCodes.notSupported)},_isReadOnlyField:function(e){switch(e.name){case"ahFileName":return!this.isNew();case"ahSourcePath":case"ahFilePath":return!0;default:return!1}},getFile:function(){return this._fileData?t.resolve(this._fileData):this.isNew()?t.resolve(null):this.hasLocalFile?this._ds.vault.getFile(this.mdoClass,this.ahFileName):t.reject(new o("The file '"+this.ahFileName+"' cannot be retrieved because it has not been downloaded",n.errorCodes.fileNotDownloaded))},getFileDataUrl:function(){function e(e){var n=t.defer(),r=new FileReader;return r.onerror=function(e){n.reject(e)},r.onloadend=function(e){n.resolve(e.target.result)},r.readAsDataURL(e),n.promise}return this.getFile().then(function(t){return t===null?t:e(t)})},downloadFile:function(e){if(this.mdoState===n.elementStates.new)return t.reject(new o("Cannot call downloadFile() on an unfetched element",n.errorCodes.fileElementIsNew));var r=this;r._logMessage("Downloading attachment '"+r.ahFileName+"'...");var i=this._downloadFileFromServer(e).then(function(e){var n=t.createBlob(e.contents,s.getMimeType(r.ahFileName));return r._fileData=n,r._fileVersion=e.version,r._fileDownloadTs=new Date,n});return i.tap(function(){r._logMessage("Downloaded attachment '"+r.ahFileName+"' ("+r._fileData.size+" bytes, version "+r._fileVersion+")")})},_downloadFileFromServer:function(e){var t=this.mdoConnection._internal.getFileServer();return t.downloadFile({datastore:this._ds.dsInfo.name(),fileClass:this.mdoClass.name,fileName:this.ahFileName,id:this.PKey,timeout:e})},uploadFile:function(e){function i(t){r._logMessage("Uploading attachment '"+r.ahFileName+"' ("+t.size+" bytes)...");var n=r.mdoConnection._internal.getFileServer();return n.uploadFile({datastore:r._ds.dsInfo.name(),fileClass:r.mdoClass.name,fileName:r.ahFileName,lastModified:r.ahCurrentUploadTS,id:r.PKey,timeout:e},t)}function s(e){return r.ahLocalVersion=e.version,r._fileDownloadTs=new Date,r.ahCurrentUploadTS=null,r.save()}if(this.mdoState===n.elementStates.new)return t.reject(new o("Cannot call uploadFile() on an unfetched element",n.errorCodes.fileElementIsNew));if(this.mdoState===n.elementStates.changed)return t.reject(new o("Cannot call uploadFile() on an unsaved element",n.errorCodes.fileElementNotSaved));if(!this.ahCurrentUploadTS)return t.reject(new o("Cannot call uploadFile() on an element without changed attachment",n.errorCodes.fileElementNoChanges));if(this._fileData)return t.reject(new o("Cannot call uploadFile() on an unsaved element",n.errorCodes.fileElementNotSaved));var r=this;return this.getFile().then(i).then(s).tap(function(){r._logMessage("Uploaded attachment '"+r.ahFileName+"' (version "+r.ahLocalVersion+")")})},_logMessage:function(t,n){r.log(t,e.extend({domainId:this._ds.dsInfo.id(),category:"INFO"},n))}});return Object.defineProperties(u.prototype,{hasLocalFile:{get:function(){return Boolean(this._fileData)||t.isDefined(this.ahLocalVersion)||t.isDefined(this.ahCurrentUploadTS)}}}),u}),define("MDO/Collection",["AH","underscore","backbone","./QueryIncludeMixin"],function(e,t,n,r){"use strict";var i=n.Collection.extend({initialize:function(e,t){},toString:function(){return this.mdoClass.name+"["+this.length+"]"},fieldValueToDb:function(e,t){var n=e.split(".",2),r=n.length===2?this.mdoClass.model.classes.getByName(n.shift(),!0):this.mdoClass,i=r.allFields.getByName(n.shift(),!0);return i.valueToDb(t)},queryFilter:function(e,n){if(!t.isString(e)&&n)throw new Error("Cannot use 'filter params' array with object based queryFilter");return e&&e.attributes&&(e=e.attributes),this._filter=e,this._filterParams=n,this},fetchCount:function(e){return this._ds.getCount(t.extend({},e,{className:this.mdoClass.name,filter:this._filter,filterParams:this._filterParams}))},querySort:function(e){return this._order=e,this},fetch:function(e){function s(){var s=n.Collection.prototype.fetch.call(r,t.extend({validate:!1},r._getFetchOptions("",e)));return r.includedRefs?s.then(t.bind(r._fetchRefs,r,i)):s}var r=this,i;return e&&e.fromServer?(i=t.pick(e,"fromServer","timeout"),this.mdoConnection.withServerSession(s)):s()},destroyAllElements:function(n){n=t.extend({wait:!0},n);var r=t.map(this.toArray(),function(e){return e.destroy(n)});return e.whenSettle(r).then(function(){return e.whenAll(r)}).yield(this)},saveAllElements:function(t){var n=this.map(function(e){return e.save(null,t)});return e.whenSettle(n).then(function(){return e.whenAll(n)}).yield(this)},_fetchRefs:function(n){if(!this.includedRefs)return this;var r=this,i=t.keys(this.includedRefs);i.sort(function(e,t){var n=e.split(".").length,r=t.split(".").length,i=n-r;return i?i:e<t?-1:e>t?1:0}),i.shift();var s={};return t.reduce(i,function(i,o){function c(){var i=o.lastIndexOf(".");if(i<0)u=r,f=o;else{var c=s[o.substr(0,i)];u=c.refCol,f=o.substr(i+1)}l=u.mdoClass.allElements.getByName(f,!0);var h=l.refClass,p=r.mdoConnection.createCollection(h.name);a=l.referenceField.name;var d=t.filter(t.unique(u.pluck(a)),t.identity);if(d.length){var v="$"+h.idField.name+" IN ("+d.join(",")+")";p.queryFilter(v);var m=r.includedRefs[o],g=t.isArray(m)?{fields:m}:{};return p.fetch(t.extend(g,n))}return e.resolve(p)}function h(e){var t={};return e.forEach(function(e){t[e.id]=e}),u.forEach(function(e){e[f]=t[e[a]]||null}),s[o]={refElement:l,refCol:e},r}var u,a,f,l;return i.then(c).then(h)},e.resolve(this),this)},sync:function(n,r,i){function f(n){return o.totalCount=t.isUndefined(n.totalCount)?undefined:n.totalCount,i.success(n),e.resolve(o)}function l(t){return i.error&&i.error(t),e.reject(t)}function c(){return s.getRows(u)}var s=this._ds,o=this,u,a;switch(n){case"read":return a=o._filter,t.isString(a)||(a=this.mdoClass.getFieldFilter(this._filter||{})),u={fromServer:Boolean(i.fromServer),timeout:i.timeout,className:o.mdoClass.name,filter:a,filterParams:o._filterParams,totalCount:i.totalCount,queryOptions:{orderBy:this._order,limit:i.limit,offset:i.offset,fields:i.fields}},c().then(f,l);case"create":case"update":case"delete":default:return e.reject(new Error("MDO.Collection sync method not implemented: "+n))}}});return t.extend(i.prototype,r),Object.defineProperty(i.prototype,"mdoClass",{get:function(){return this._class}}),Object.defineProperty(i.prototype,"mdoConnection",{get:function(){return this._mdoCon}}),i}),define("Http/FileServer",["underscore","./ajax","./Config","AH","Constants"],function(e,t,n,r,i){"use strict";return function(s){function f(r,i){var o=e.extend({url:r,type:"GET",timeout:n.attachmentTimeout,dataType:"application/binary",headers:{"Cache-Control":"no-cache","X-AHUser":s.user,"X-AHPassword":s.password}},i);return t.ajax(o)}function c(e){var t=e.getTime()-l;return t/864e5}function h(e,t){var n=[o,"action="+encodeURIComponent(e),"datastore="+encodeURIComponent(t.datastore),"fileclass="+encodeURIComponent(t.fileClass),"filename="+encodeURIComponent(t.fileName),"pkey="+encodeURIComponent(t.id)];return t.lastModified&&n.push("lastmodified="+encodeURIComponent(c(t.lastModified))),n.join("&")}function p(t){var s=h(u.downloadFile,t);return a(s,{responseType:"arraybuffer",timeout:t.timeout||n.attachmentTimeout}).then(function(n){var s=e.extend({size:Number(n.xhr.getResponseHeader("X-AHFileSize")),version:Number(n.xhr.getResponseHeader("X-AHFileServerVersion")),contents:n.data},e.pick(t,"fileName","fileClass"));if(s.version<0){var o=new Error("Server file not found: "+t.fileClass+":"+t.fileName);return o.mdoCode=i.errorCodes.serverFileNotFound,r.reject(o)}return s})}function v(e){var t=h(u.getInfo,e);return a(t).then(function(e){return r.resolve(e.xhr.getResponseHeader("X-AHServerFileNewer")==="1")})}function m(t,s){return d(t).then(function(o){if(o){var f=new Error("Server file is newer: "+t.fileClass+":"+t.fileName);return f.mdoCode=i.errorCodes.serverFileNewer,r.reject(f)}var l=h(u.uploadFile,t),c=null;return s instanceof Blob?c=g(s):c=r.resolve(s),c.then(function(r){return a(l,{type:"POST",processData:!1,data:r,timeout:t.timeout||n.attachmentTimeout}).then(function(n){return e.extend({version:Number(n.xhr.getResponseHeader("X-AHFileServerVersion"))},e.pick(t,"fileName","fileClass"))})})})}function g(e){var t=r.defer(),n=new FileReader;return n.onload=function(e){t.resolve(e.target.result)},n.readAsArrayBuffer(e),t.promise}var o=s.baseUrl||"/MTierServices/FileTransfer.aspx";o+="?domain="+encodeURIComponent(s.domain),o+="&deviceID="+encodeURIComponent(s.deviceId),o+="&passThroughAuth="+Boolean(s.sharedDevice);var u={getInfo:"info",downloadFile:"download",uploadFile:"upload"},a=f,l=(new Date(1900,0,-1,-6)).getTime(),d=v,y={downloadFile:p,uploadFile:m,_dateToVariantTime:c,_getServiceUri:h};return Object.defineProperties(y,{_ajaxRequest:{get:function(){return a},set:function(e){a=e}},_isServerFileNewer:{get:function(){return d},set:function(e){d=e}}}),y}}),define("MDO/VaultSynchronizer",["underscore","AH","Constants","Messages/Message"],function(e,t,n,r){"use strict";var i="(ahLocalVersion IS NULL OR ahLocalVersion < ahServerVersion) AND ahCurrentUploadTS IS NULL AND ahServerVersion >= 1",s="(ahOnDemand IS NULL OR ahOnDemand=0 OR ahSubscribed <> 0)",o="ahCurrentUploadTS IS NOT NULL";return function(u){function f(n){var r=i+" AND "+s,o=e.map(n,function(e){var t=u.createCollection(e.name);return t.queryFilter(r),t.fetch()});return t.whenAll(o)}function c(){return e.filter(u.model.classes,function(e){return e.isFileClass})}function p(e){return e.destroy({localOnly:!0}).then(null,function(){})}function v(r,i){return r.downloadFile(i).then(function(){return r.save(null,{localOnly:e.keys(r.attributes)})},function(e){return e.mdoCode===n.errorCodes.serverFileNotFound?h(r):t.reject(e)})}function g(i,s){var o=e.reduce(i,function(e,t){return e+t.length},0),u=0,a=e.reduce(i,function(e,i){return i.reduce(function(e,i){return e.then(function(){return u++,t.notify(r.getMessage(n.messageCodes.downloadingVaultFile,u,o,i.ahFileName),d(i,s))})},e)},t.resolve());return o&&(a=t.notify(r.getMessage(n.messageCodes.downloadingVaultFiles,o),a)),a}function y(e){var i=a(l()).then(function(t){return m(t,e)});return t.notify(r.getMessage(n.messageCodes.checkingForAttachmentDownloads),i)}function w(n){var r=o,i=e.map(n,function(e){var t=u.createCollection(e.name);return t.queryFilter(r),t.fetch()});return t.whenAll(i)}function S(i,s){var o=e.reduce(i,function(e,t){return e+t.length},0),u=0,a=e.reduce(i,function(e,i){return i.reduce(function(e,i){return e.then(function(){return u++,t.notify(r.getMessage(n.messageCodes.uploadingVaultFile,u,o,i.ahFileName),i.uploadFile(s))})},e)},t.resolve());return o&&(a=t.notify(r.getMessage(n.messageCodes.uploadingVaultFiles,o),a)),a}function x(e){var i=b(l()).then(function(t){return E(t,e)});return t.notify(r.getMessage(n.messageCodes.checkingForAttachmentUploads),i)}var a=f,l=c,h=p,d=v,m=g,b=w,E=S,T={downloadVaultFiles:y,uploadVaultFiles:x};return Object.defineProperties(T,{_getFileClasses:{get:function(){return l},set:function(e){l=e}},_getDownloadCollections:{get:function(){return a},set:function(e){a=e}},_downloadFilesInCollections:{get:function(){return m},set:function(e){m=e}},_downloadFile:{get:function(){return d},set:function(e){d=e}},_deleteMissingServerRecord:{get:function(){return h},set:function(e){h=e}},_getUploadCollections:{get:function(){return b},set:function(e){b=e}},_uploadFilesInCollections:{get:function(){return E},set:function(e){E=e}}}),T}}),define("MDO/Synchronizer",["underscore","AH","Constants","Http/Server","LocalStorage/Storage","./VaultSynchronizer","Files/fs","Files/fileSystem","./Error","./AsyncEvents","Messages/Message"],function(e,t,n,r,i,s,o,u,a,f,l){"use strict";var c,h,p=!1;return function(i,d){function m(s){function f(e){return function(t){return h.asyncTrigger("sync:"+e,s).then(function(){return t})}}var u={password:"",uploadXacts:!0,downloadXacts:!0,processXacts:!0,uploadFiles:!0,downloadFiles:!0,downloadXactsSizeLimit:5e3};s=e.extend(u,s);if(p)return t.reject(new a("Sync currently in progress",n.errorCodes.syncInProgress));p=!0;var d=t.deferredTryCatch(function(){function m(){function e(){return o.listFiles(i.domInfo.outgoingDir(),"*.mtc")}function r(e){var r=t.resolve();return e&&e.length&&(r=r.then(f("uploadingXacts")),r=e.reduce(function(r,u,a){return r.then(function(){var r=o.readJsonFileContent(u.dir,u.name).then(function(e){return d.putFile(e,s.timeout)}).then(function(){return o.deleteFile(i.domInfo.outgoingDir(),u.name,!1)});return C(u),t.notify(l.getMessage(n.messageCodes.uploadingFile,a+1,e.length),r)})},r),r=r.then(f("uploadedXacts"))),r}return e().then(r)}function E(r){function u(e,o,u){function a(){return A(o),t.notify(l.getMessage(n.messageCodes.downloadingFile,u+1,r.files.length),d.getFile(o,{maxNumTransactions:s.downloadXactsSizeLimit},s.timeout))}function f(e){b("Extracting '"+o.fileName+"' ("+JSON.stringify(e).length+" bytes)...");var s=i.extractMtc(e).then(function(){return S(e)}).then(function(){d.fileToAcknowledge=o.mailboxId});return t.notify(l.getMessage(n.messageCodes.extractingFile,u+1,r.files.length),s)}return e.then(a).then(f)}a=r.files&&r.files.length>0,L((r.files||[]).length);var o=t.resolve();return a&&(o=o.then(f("downloadingXacts")),o=e.reduce(r.files,u,o),o=o.then(f("downloadedXacts"))),o}function S(r){function u(o,u){function f(e){a.segmentIndex=e,b("Downloading '"+a.segmentFileName+"' ("+a.segmentFileType+") ["+a.segmentIndex+"]...");var r=d.getSegment(a,s.timeout).then(function(e){return i.extractMtc(e)});return t.notify(l.getMessage(n.messageCodes.downloadingSegment,e,u.segmentCount),r)}var a={mailboxId:r.descriptor.mailboxId,segmentFileName:u.fileName,segmentFileType:u.segmentFileType};return e.reduce(e.range(1,u.segmentCount+1),function(e,t){return e.then(function(){return f(t)})},o)}var o=e.where(r.files,{type:"Segmented"});return e.reduce(o,u,t.resolve())}function x(){return i.extractIncoming()}function T(e){return"### "+e+" ###"}function N(){b(T("Sync started"))}function C(e){b("Uploading '"+e.name+"' ("+e.size+" bytes)...")}function k(){b("Requesting file list...")}function L(e){b(e+" file(s) to download:")}function A(e){b("Downloading '"+e.fileName+"' ("+e.type+")...")}function O(){b(T(t.format("Sync completed ({0}s)",w(h))))}function M(e){var n=w(h),r="Sync failed ({0}s): {1}";return e instanceof Error?(t.normalizeWebSqlError(e),e.message=t.format(r,n,e.message)):e=new Error(t.format(r,n,e)),b(T(e.message)),t.reject(e)}c.checkNetworkConnection();var u={domainId:i.domInfo.id(),userId:i.domInfo.userId(),user:s.user||i.domInfo.user(),password:s.password,deviceSharing:s.deviceSharing};if(!i.domInfo.serverUrl())throw new Error("Server information not present in registry");var a=!1,h=(new Date).valueOf(),p=t.resolve(),d,v=s.uploadXacts||s.downloadXacts;return N(),v&&(d=new r(i.domInfo.serverUrl(),function(){return u}),g(),p=d.session(function(n){var r=t.resolve();return s.uploadXacts&&(r=r.then(f("preparingUploadXacts")).then(c.prepareOutgoingFiles).then(m)),s.downloadXacts&&(r=r.then(k).then(e.partial(n.getFileList,s.timeout)).then(E)),r.always(y),r})),s.uploadFiles&&(p=p.then(e.partial(c.uploadVaultFiles,s.timeout))),s.processXacts&&(p=p.then(x).then(c.processIncomingFiles)),s.downloadFiles&&(p=p.then(e.partial(c.downloadVaultFiles,s.timeout))),p.then(O),p.then(null,M)});return d.always(function(){p=!1}),d}function g(){b("Authenticating "+i.domInfo.user()+"@"+i.domInfo.name()+"...")}function y(){b("Disconnecting...")}function b(e){i.logMessage(e)}function w(e){var t=(new Date).valueOf();return((t-e)/1e3).toFixed(1)}function E(){return i.processIncomingFiles()}function S(){return i.prepareOutgoingFiles()}function x(){if(!t.isOnline())throw new a("No network available",n.errorCodes.offline)}function T(e){return v&&v.uploadVaultFiles(e)}function N(e){return v&&v.downloadVaultFiles(e)}function C(e){return e={domainId:i.domInfo.id(),userId:i.domInfo.userId(),password:e.password},i.domInfo.device()&&(e.deviceSharing=n.deviceSharing.existingUser,e.user=i.domInfo.user()),t.deferredTryCatch(function(){c.checkNetworkConnection();var t=new r(i.domInfo.serverUrl(),function(){return e});return g(),t.session().then(y)})}var v=u.isSupported&&d&&new s(d);return c={processIncomingFiles:E,prepareOutgoingFiles:S,checkNetworkConnection:x,downloadVaultFiles:N,uploadVaultFiles:T},h=e.extend({sync:m,testUserCredentials:C,_internal:c},f),h}}),define("MDO/Connection",["underscore","backbone","AH","Constants","./Error","./Element","./FileElement","./Collection","Http/FileServer","Logging/logger","./AsyncEvents","./Synchronizer"],function(e,t,n,r,i,s,o,u,a,f,l,c){"use strict";return function(t,h,p){function T(a,f){var l,c=this;if(e.isUndefined(a))f=undefined,l=n.resolve(r.connectionStates.opened);else if(t.domInfo.testCredentials(a,f))l=n.resolve(r.connectionStates.privileged);else{if(t.domInfo.user()!==a)return n.reject(new i("Invalid user credentials",r.errorCodes.invalidCredentials));l=m.synchronizer.testUserCredentials({password:f}).then(function(){return t.domInfo.saveCredentials(a,f),r.connectionStates.privileged},function(e){return e.mdoCode===r.errorCodes.offline?n.reject(new i("Invalid local user credentials",r.errorCodes.invalidLocalCredentials)):n.reject(new i("Invalid user credentials",r.errorCodes.invalidCredentials))})}return l.then(function(i){C(),E=s.extend({_mdoCon:c}),S=o.extend({_mdoCon:c}),x=u.extend({_mdoCon:c});var a=n.defer();return n.when(g!==r.connectionStates.closed||h.open(),function(){return k(f),g=i,v.listenTo(t,r.connectionEvents.dataReset,function(){v.onDataUpdated(r.connectionEvents.dataReset)}),v.listenTo(m.synchronizer,"all",function(e,t){return v.asyncTrigger(e,v,t)}),v.listenTo(h,"processingXacts",e.bind(v.asyncTrigger,v,r.connectionEvents.syncProcessingXacts,v)),v.listenTo(h,"processedXacts",e.bind(v.asyncTrigger,v,r.connectionEvents.syncProcessedXacts,v)),a.resolve(c)},function(){return a.reject(new Error("Failed to open connection"))}),y=a.promise})}function N(){g=r.connectionStates.closed,C(),v.stopListening(m.synchronizer),v.stopListening(t),v.stopListening(h),y=n.reject(new Error("MDO connection is closed"))}function C(){E=undefined,S=undefined,x=undefined,b={},w={}}function k(e){d=e,t.serverPassword=e}function L(){return g}function A(e){M("createElement()"),h.validateClassName(e);var t=H(e,this);return new t({})}function O(e){M("createCollection()"),h.validateClassName(e);var t=B(e,this);return new t}function M(e){if(g===r.connectionStates.closed)throw new Error("MDO connection not opened during "+e)}function D(e){return g===r.connectionStates.closed?n.reject(new Error("MDO connection not opened during "+e)):n.resolve()}function P(e){return g!==r.connectionStates.privileged?n.reject(new Error("MDO connection not privileged during "+e)):n.resolve()}function H(e){if(!e)return E;var t=b[e];if(!t){var n=h.model.classes.getByName(e),r=n.baseClass,i=n.isFileClass?S:E,s=n.fields;r&&(i=H(r.name),s=s.filter(function(e){return!e.isIdField()})),b[e]=t=i.extend({_class:n,idAttribute:n.idField.name,_ds:h}),s.forEach(function(e){var n=e.name;Object.defineProperty(t.prototype,n,{set:function(e){this.set(n,e)},get:function(){return this.get(n)}})})}return t}function B(e){if(!e)return x;var t=w[e];if(!t){var n=h.model.classes.getByName(e),r=n.baseClass,i=x;r&&(i=B(r.name)),w[e]=t=i.extend({_class:n,_ds:h,model:H(e)})}return t}function j(i){var s=this,o,u=h.model?h.model.version:undefined;return g===r.connectionStates.opened&&i&&"password"in i?o=!0:o=P("sync()"),n.when(o,function(){return i=e.extend({password:d},i),t.domInfo.device()?i.deviceSharing=r.deviceSharing.existingUser:delete i.deviceSharing,m.synchronizer.sync(i)}).then(function(){i.password!==d&&(t.domInfo.saveCredentials(t.domInfo.user(),i.password),k(i.password),g=r.connectionStates.privileged),u!==h.model.version&&s.onModelUpdated(r.connectionEvents.modelChanged),s.onDataUpdated(r.connectionEvents.dataSynced)}).then(function(){return s})}function F(t,n,i){return i=e.extend({server:h.server._httpServer},i),g===r.connectionStates.privileged?J(function(){return p.executeServerRpc(t,n,i)},i.authTimeout):p.executeServerRpc(t,n,i)}function I(e){switch(e){case r.connectionEvents.modelChanged:this.trigger(r.connectionEvents.modelChanged,h.model);break;default:throw new Error("Unsupported model update type: "+e)}}function q(t,n,i){if(i&&i.silent)return;switch(t){case r.connectionEvents.dataAdded:this.trigger(r.connectionEvents.dataAdded,n);break;case r.connectionEvents.dataModified:this.trigger(r.connectionEvents.dataModified,n,i);break;case r.connectionEvents.dataDeleted:e.forEach(n,function(e){var t=this.createElement(e.modelClass.name);t[e.modelClass.idField.name]=e.id,t._state=r.elementStates.deleted,this.trigger(r.connectionEvents.dataDeleted,t,i)},this);break;case r.connectionEvents.dataSynced:this.trigger(r.connectionEvents.dataSynced,this);break;case r.connectionEvents.dataReset:this.trigger(r.connectionEvents.dataReset,this);break;default:throw new Error("Unsupported data update type: "+t)}this.trigger("data")}function R(n,r){return f.log(n,e.extend({},r,{domainId:t.domInfo.id()}))}function U(n,r){return f.logError(n,e.extend({},r,{domainId:t.domInfo.id()}))}function z(t){function r(){return h.mdoTransaction(t)}return e.isFunction(t)?(t=e.bind(t,null,this),D("mdoTransaction()").then(r)):n.reject(new Error("No mdo transaction callback was specified"))}function W(){var e=t.domInfo,n=h.dsInfo,r=e.serverUrl(),i=r.replace(/[^\/]*\/$/,"MTierServices/FileTransfer.aspx");return new a({domain:e.name(),datastore:n.name(),sharedDevice:Boolean(e.device()),deviceId:e.device()||e.user(),user:e.user(),password:d,baseUrl:i})}function X(t){t&&h.validateClassName(t);var n=H(t).prototype,r=e.toArray(arguments).slice(1);return e.extend.apply(null,[n].concat(r)),t||e.extend.apply(null,[S.prototype].concat(r)),n}function V(t){t&&h.validateClassName(t);var n=B(t).prototype;return e.extend.apply(null,[n].concat(e.toArray(arguments).slice(1))),n}function $(e,t){M("fieldValueToDb");var n=e.split(".",2),r=h.model.classes.getByName(n.shift(),!0),i=r.allFields.getByName(n.shift(),!0);return i.valueToDb(t)}function J(t,r){function i(){return h.server.session(t,r)}return e.isFunction(t)?D("withServerSession()").then(i):n.reject(new Error("No server session callback was specified"))}var d,v={},m={synchronizer:new c(t,v),domInfo:t.domInfo,isCurrentPassword:function(e){return e===d},datastore:h,domain:t,getFileServer:W},g,y,b={},w={},E,S,x;return Object.defineProperties(m,{BaseConnectionElement:{get:function(){return E}},BaseConnectionCollection:{get:function(){return x}}}),e.extend(v,{open:T,close:N,getState:L,createElement:A,createCollection:O,sync:j,onDataUpdated:q,onModelUpdated:I,logMessage:R,logError:U,mdoTransaction:z,withServerSession:J,extendElement:X,extendCollection:V,fieldValueToDb:$,executeServerRpc:F,_internal:m,promise:function(){return y}},l),Object.defineProperties(v,{state:{get:function(){return g}},model:{get:function(){return M("model"),h.model}},database:{get:function(){return M("database access"),h.store.database}}}),N(),v}}),define("MDO/Client",["AH","Constants","underscore","backbone","lib/uuid","Http/Config","Http/Server","Messages/Message","./Domain","./Connection","./Synchronizer","./Stats","Logging/logger","./Error"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p){"use strict";function g(){var e=r.VERSION.split("."),n=Number(e.shift());return n<1?new p("Insufficient prerequisites: MDO requires Backbone version 1.0 or newer - current version is "+r.VERSION,t.errorCodes.insufficientPrereqs):undefined}function y(){var e=a.retrieve();return e?e.domInfo:!1}function b(r,i,s){if(!r||r==="")return e.reject(new p("methodName must be a non-empty string",t.errorCodes.invalidArgs));var u=y();s=n.extend({serverUrl:u&&u.serverUrl()},s),i=i||{};var a=s.server||new o(s.serverUrl);return a.execute("DeviceRpc",{methodName:r,parameters:i},s.timeout).then(function(e){return e.customData})}function w(r,i,s,f,l){var c=T(r,i,s,f).then(function(t){r=t.serverUrl;var i=t.credentials,s=new o(r);return s.execute("RegisterDevice",n.extend({deviceUuid:M(),deviceModel:D(),devicePlatform:_(),customData:l},i)).then(function(t){return a.create({serverUrl:r,domain:i.domain,domainId:t.domainId,sharedDevice:!0,user:t.deviceName,userId:t.deviceId}),e.resolve(t.customData)})});return e.notify(u.getMessage(t.messageCodes.registeringDevice),c)}function E(r,i,s){function h(){return N(r,i).then(function(){if(u.domInfo.getNumDatastores()<=0)return e.reject(new p("Datastore has not been prepared for installation",t.errorCodes.noDatastore))},function(n){if(f&&!l&&n.mdoCode===t.errorCodes.dataRepostInProgress){--f;var r=d();return setTimeout(function(){l||e.chainPromise(h(),r)},s.retryInterval),e.notify("Server is preparing data...",r.promise)}return u.logError(n),e.reject(e.normalizeWebSqlError(n))})}function d(){var n=e.defer();return c&&e.when(c,function(){l=!0,n.reject(new p("Colonization was canceled.",t.errorCodes.canceled))},function(e){l=!0,n.reject(e)}),n}var o=m();if(o)return e.reject(o);if(!y())return e.reject(new p("The device is not registered",t.errorCodes.deviceNotRegistered));s=n.extend({retryInterval:5e3,maxRetries:-1},s);var u=a.retrieve(),f=s.maxRetries,l=!1,c=s.cancelPromise;return e.chainPromise(h(),d())}function S(e){var t=a.retrieve(e);return t&&t.domInfo.getNumDatastores()?t.domInfo:!1}function x(r,i,s,u){return T(r,i,s,u).then(function(f){function g(t){function n(){return e.reject(e.normalizeWebSqlError(t))}return(m||h).logError(t),v.uninstall().then(n,function(e){return e&&e.message&&(e.message="MDOUninstall: "+e.message),h.logError(e),n()})}r=f.serverUrl;var l=f.credentials,c=new o(r,function(){return l}),m;return c.session(function(t,i){return e.resolve(a.create(n.extend({serverUrl:r},i,l)))}).then(function(e){return m=e,d.sync(m,{password:u})}).then(function(){return m.domInfo.getNumDatastores()>0?{domainName:i,userName:s,userId:m.domInfo.userId(),domainId:m.domInfo.id(),serverUrl:r}:g(new p("Datastore has not been prepared for installation",t.errorCodes.noDatastore))},g)})}function T(n,r,i,s){if(!e.isDefined(i))return e.reject(new p("Invalid Username: "+(i===null?"null":"undefined"),t.errorCodes.invalidCredentials));if(!e.isDefined(r)||r==="")return e.reject(new p("Missing domain name",t.errorCodes.missingDomainName));var o=m();return o?e.reject(o):(n&&n.charAt(n.length-1)!=="/"&&(n+="/"),e.resolve({serverUrl:n,credentials:{domain:r,user:i,password:s}}))}function N(n,r){var i=m();if(i)return e.reject(i);var s=a.retrieve();return s?s.domInfo.device()?d.sync(s,{user:n,password:r,deviceSharing:t.deviceSharing.changeUser}).then(function(){s.domInfo.saveCredentials(n,r)}).then(null,function(t){return e.reject(e.normalizeWebSqlError(t))}):e.reject(new p("Change user not supported",t.errorCodes.notSupported)):e.reject(new p("Client not installed",t.errorCodes.clientNotInstalled))}function C(){var n=a.retrieve();return n?n.domInfo.device()?e.resolve(n.domInfo.clearCredentials()):e.reject(new p("Reset user not supported",t.errorCodes.notSupported)):e.reject(new p("Client not installed",t.errorCodes.clientNotInstalled))}function k(){h.log("### Uninstall Started ###",{category:"INFO"});var t=a.retrieve();return t?t.destroy().then(function(){h.log("### Uninstall complete ###",{category:"INFO"})}):(h.log("Nothing to do",{category:"INFO"}),h.log("### Uninstall complete ###",{category:"INFO"}),e.resolve())}function L(e){var n=m();if(n)throw n;var r=a.retrieve();if(!r)throw new p("Client not installed",t.errorCodes.clientNotInstalled);var i;if(!e)i=r.getDefaultDatastore();else{i=r.getDatastoreByName(e);if(!i)throw new p("Datastore '"+e+"' does not exist",t.errorCodes.noDatastore)}return new f(r,i,v)}function O(t){return n.isObject(t)&&(n.isUndefined(t.traceDb)||e.websql.config({traceDb:t.traceDb}),n.isUndefined(t.collectStats)||(c.enabled=Boolean(t.collectStats)),n.isUndefined(t.syncDisconnectTimeout)||(s.disconnectTimeout=t.syncDisconnectTimeout),n.isUndefined(t.syncAuthenticationTimeout)||(s.authenticationTimeout=t.syncAuthenticationTimeout),n.isUndefined(t.syncRequestTimeout)||(s.requestTimeout=t.syncRequestTimeout),n.isUndefined(t.syncAttachmentTimeout)||(s.attachmentTimeout=t.syncAttachmentTimeout)),{traceDb:e.websql.config().traceDb,collectStats:c.enabled,syncDisconnectTimeout:s.disconnectTimeout,syncAuthenticationTimeout:s.authenticationTimeout,syncRequestTimeout:s.requestTimeout,syncAttachmentTimeout:s.attachmentTimeout}}function M(){if(window.device&&window.device.uuid)return window.device.uuid;var e=localStorage["@deviceUuid"];return e||(localStorage["@deviceUuid"]=e=i.uuid()),e}function _(){switch(window.device&&window.device.platform){case"Android":return t.devicePlatforms.easAndroid;case"iOS":return t.devicePlatforms.easIos;case"Win32NT":return t.devicePlatforms.easWindows8;default:return t.devicePlatforms.browser}}function D(){return window.device&&window.device.model?window.device.model:navigator.userAgent}var d,v,m=g,A={};return d={sync:function(e,t){return(new l(e)).sync(t)}},v={config:O,isDeviceRegistered:y,registerDevice:w,colonize:E,isInstalled:S,install:x,uninstall:k,changeUser:N,resetUser:C,createConnection:L,executeServerRpc:b,version:"6.5.0.104",stats:c,logger:h,constants:t,Message:u,errorCodes:n.extend({},t.errorCodes),connectionStates:n.extend({},t.connectionStates),connectionEvents:n.extend({},t.connectionEvents),defer:e.defer,when:e.when,whenAll:e.whenAll,resolve:e.resolve,reject:e.reject,notify:e.notify,chainPromise:e.chainPromise,_:n,Backbone:r,_internal:d},Object.defineProperties(v,{settings:{get:function(){return A}},deviceUuid:{get:M},devicePlatform:{get:_},deviceModel:{get:D}}),Object.defineProperties(d,{getPrerequisitesError:{get:function(){return m},set:function(e){m=e}}}),v}),define("mdo",["MDO/Client"],function(e){"use strict";return e}),require("mdo")});